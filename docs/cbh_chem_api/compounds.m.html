<!doctype html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />

    <title>cbh_chem_api.compounds API documentation</title>
    <meta name="description" content="nearly deprecated old inteface to the compounds API" />

  <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300' rel='stylesheet' type='text/css'>
  
  <style type="text/css">
  
* {
  box-sizing: border-box;
}
/*! normalize.css v1.1.1 | MIT License | git.io/normalize */

/* ==========================================================================
   HTML5 display definitions
   ========================================================================== */

/**
 * Correct `block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
nav,
section,
summary {
    display: block;
}

/**
 * Correct `inline-block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

audio,
canvas,
video {
    display: inline-block;
    *display: inline;
    *zoom: 1;
}

/**
 * Prevent modern browsers from displaying `audio` without controls.
 * Remove excess height in iOS 5 devices.
 */

audio:not([controls]) {
    display: none;
    height: 0;
}

/**
 * Address styling not present in IE 7/8/9, Firefox 3, and Safari 4.
 * Known issue: no IE 6 support.
 */

[hidden] {
    display: none;
}

/* ==========================================================================
   Base
   ========================================================================== */

/**
 * 1. Prevent system color scheme's background color being used in Firefox, IE,
 *    and Opera.
 * 2. Prevent system color scheme's text color being used in Firefox, IE, and
 *    Opera.
 * 3. Correct text resizing oddly in IE 6/7 when body `font-size` is set using
 *    `em` units.
 * 4. Prevent iOS text size adjust after orientation change, without disabling
 *    user zoom.
 */

html {
    background: #fff; /* 1 */
    color: #000; /* 2 */
    font-size: 100%; /* 3 */
    -webkit-text-size-adjust: 100%; /* 4 */
    -ms-text-size-adjust: 100%; /* 4 */
}

/**
 * Address `font-family` inconsistency between `textarea` and other form
 * elements.
 */

html,
button,
input,
select,
textarea {
    font-family: sans-serif;
}

/**
 * Address margins handled incorrectly in IE 6/7.
 */

body {
    margin: 0;
}

/* ==========================================================================
   Links
   ========================================================================== */

/**
 * Address `outline` inconsistency between Chrome and other browsers.
 */

a:focus {
    outline: thin dotted;
}

/**
 * Improve readability when focused and also mouse hovered in all browsers.
 */

a:active,
a:hover {
    outline: 0;
}

/* ==========================================================================
   Typography
   ========================================================================== */

/**
 * Address font sizes and margins set differently in IE 6/7.
 * Address font sizes within `section` and `article` in Firefox 4+, Safari 5,
 * and Chrome.
 */

h1 {
    font-size: 2em;
    margin: 0.67em 0;
}

h2 {
    font-size: 1.5em;
    margin: 0.83em 0;
}

h3 {
    font-size: 1.17em;
    margin: 1em 0;
}

h4 {
    font-size: 1em;
    margin: 1.33em 0;
}

h5 {
    font-size: 0.83em;
    margin: 1.67em 0;
}

h6 {
    font-size: 0.67em;
    margin: 2.33em 0;
}

/**
 * Address styling not present in IE 7/8/9, Safari 5, and Chrome.
 */

abbr[title] {
    border-bottom: 1px dotted;
}

/**
 * Address style set to `bolder` in Firefox 3+, Safari 4/5, and Chrome.
 */

b,
strong {
    font-weight: bold;
}

blockquote {
    margin: 1em 40px;
}

/**
 * Address styling not present in Safari 5 and Chrome.
 */

dfn {
    font-style: italic;
}

/**
 * Address differences between Firefox and other browsers.
 * Known issue: no IE 6/7 normalization.
 */

hr {
    -moz-box-sizing: content-box;
    box-sizing: content-box;
    height: 0;
}

/**
 * Address styling not present in IE 6/7/8/9.
 */

mark {
    background: #ff0;
    color: #000;
}

/**
 * Address margins set differently in IE 6/7.
 */

p,
pre {
    margin: 1em 0;
}

/**
 * Correct font family set oddly in IE 6, Safari 4/5, and Chrome.
 */

code,
kbd,
pre,
samp {
    font-family: monospace, serif;
    _font-family: 'courier new', monospace;
    font-size: 1em;
}

/**
 * Improve readability of pre-formatted text in all browsers.
 */

pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/**
 * Address CSS quotes not supported in IE 6/7.
 */

q {
    quotes: none;
}

/**
 * Address `quotes` property not supported in Safari 4.
 */

q:before,
q:after {
    content: '';
    content: none;
}

/**
 * Address inconsistent and variable font size in all browsers.
 */

small {
    font-size: 80%;
}

/**
 * Prevent `sub` and `sup` affecting `line-height` in all browsers.
 */

sub,
sup {
    font-size: 75%;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
}

sup {
    top: -0.5em;
}

sub {
    bottom: -0.25em;
}

/* ==========================================================================
   Lists
   ========================================================================== */

/**
 * Address margins set differently in IE 6/7.
 */

dl,
menu,
ol,
ul {
    margin: 1em 0;
}

dd {
    margin: 0 0 0 40px;
}

/**
 * Address paddings set differently in IE 6/7.
 */

menu,
ol,
ul {
    padding: 0 0 0 40px;
}

/**
 * Correct list images handled incorrectly in IE 7.
 */

nav ul,
nav ol {
    list-style: none;
    list-style-image: none;
}

/* ==========================================================================
   Embedded content
   ========================================================================== */

/**
 * 1. Remove border when inside `a` element in IE 6/7/8/9 and Firefox 3.
 * 2. Improve image quality when scaled in IE 7.
 */

img {
    border: 0; /* 1 */
    -ms-interpolation-mode: bicubic; /* 2 */
}

/**
 * Correct overflow displayed oddly in IE 9.
 */

svg:not(:root) {
    overflow: hidden;
}

/* ==========================================================================
   Figures
   ========================================================================== */

/**
 * Address margin not present in IE 6/7/8/9, Safari 5, and Opera 11.
 */

figure {
    margin: 0;
}

/* ==========================================================================
   Forms
   ========================================================================== */

/**
 * Correct margin displayed oddly in IE 6/7.
 */

form {
    margin: 0;
}

/**
 * Define consistent border, margin, and padding.
 */

fieldset {
    border: 1px solid #c0c0c0;
    margin: 0 2px;
    padding: 0.35em 0.625em 0.75em;
}

/**
 * 1. Correct color not being inherited in IE 6/7/8/9.
 * 2. Correct text not wrapping in Firefox 3.
 * 3. Correct alignment displayed oddly in IE 6/7.
 */

legend {
    border: 0; /* 1 */
    padding: 0;
    white-space: normal; /* 2 */
    *margin-left: -7px; /* 3 */
}

/**
 * 1. Correct font size not being inherited in all browsers.
 * 2. Address margins set differently in IE 6/7, Firefox 3+, Safari 5,
 *    and Chrome.
 * 3. Improve appearance and consistency in all browsers.
 */

button,
input,
select,
textarea {
    font-size: 100%; /* 1 */
    margin: 0; /* 2 */
    vertical-align: baseline; /* 3 */
    *vertical-align: middle; /* 3 */
}

/**
 * Address Firefox 3+ setting `line-height` on `input` using `!important` in
 * the UA stylesheet.
 */

button,
input {
    line-height: normal;
}

/**
 * Address inconsistent `text-transform` inheritance for `button` and `select`.
 * All other form control elements do not inherit `text-transform` values.
 * Correct `button` style inheritance in Chrome, Safari 5+, and IE 6+.
 * Correct `select` style inheritance in Firefox 4+ and Opera.
 */

button,
select {
    text-transform: none;
}

/**
 * 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio`
 *    and `video` controls.
 * 2. Correct inability to style clickable `input` types in iOS.
 * 3. Improve usability and consistency of cursor style between image-type
 *    `input` and others.
 * 4. Remove inner spacing in IE 7 without affecting normal text inputs.
 *    Known issue: inner spacing remains in IE 6.
 */

button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
    -webkit-appearance: button; /* 2 */
    cursor: pointer; /* 3 */
    *overflow: visible;  /* 4 */
}

/**
 * Re-set default cursor for disabled elements.
 */

button[disabled],
html input[disabled] {
    cursor: default;
}

/**
 * 1. Address box sizing set to content-box in IE 8/9.
 * 2. Remove excess padding in IE 8/9.
 * 3. Remove excess padding in IE 7.
 *    Known issue: excess padding remains in IE 6.
 */

input[type="checkbox"],
input[type="radio"] {
    box-sizing: border-box; /* 1 */
    padding: 0; /* 2 */
    *height: 13px; /* 3 */
    *width: 13px; /* 3 */
}

/**
 * 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome.
 * 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome
 *    (include `-moz` to future-proof).
 */

input[type="search"] {
    -webkit-appearance: textfield; /* 1 */
    -moz-box-sizing: content-box;
    -webkit-box-sizing: content-box; /* 2 */
    box-sizing: content-box;
}

/**
 * Remove inner padding and search cancel button in Safari 5 and Chrome
 * on OS X.
 */

input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
    -webkit-appearance: none;
}

/**
 * Remove inner padding and border in Firefox 3+.
 */

button::-moz-focus-inner,
input::-moz-focus-inner {
    border: 0;
    padding: 0;
}

/**
 * 1. Remove default vertical scrollbar in IE 6/7/8/9.
 * 2. Improve readability and alignment in all browsers.
 */

textarea {
    overflow: auto; /* 1 */
    vertical-align: top; /* 2 */
}

/* ==========================================================================
   Tables
   ========================================================================== */

/**
 * Remove most spacing between table cells.
 */

table {
    border-collapse: collapse;
    border-spacing: 0;
}

  </style>

  <style type="text/css">
  
  html, body {
    margin: 0;
    padding: 0;
    min-height: 100%;
  }
  body {
    background: #fff;
    font-family: "Source Sans Pro", "Helvetica Neueue", Helvetica, sans;
    font-weight: 300;
    font-size: 16px;
    line-height: 1.6em;
  }
  #content {
    width: 70%;
    max-width: 850px;
    float: left;
    padding: 30px 60px;
    border-left: 1px solid #ddd;
  }
  #sidebar {
    width: 25%;
    float: left;
    padding: 30px;
    overflow: hidden;
  }
  #nav {
    font-size: 130%;
    margin: 0 0 15px 0;
  }

  #top {
    display: block;
    position: fixed;
    bottom: 5px;
    left: 5px;
    font-size: .85em;
    text-transform: uppercase;
  }

  #footer {
    font-size: .75em;
    padding: 5px 30px;
    border-top: 1px solid #ddd;
    text-align: right;
  }
    #footer p {
      margin: 0 0 0 30px;
      display: inline-block;
    }

  h1, h2, h3, h4, h5 {
    font-weight: 300;
  }
  h1 {
    font-size: 2.5em;
    line-height: 1.1em;
    margin: 0 0 .50em 0;
  }

  h2 {
    font-size: 1.75em;
    margin: 1em 0 .50em 0;
  }

  h3 {
    margin: 25px 0 10px 0;
  }

  h4 {
    margin: 0;
    font-size: 105%;
  }

  a {
    color: #058;
    text-decoration: none;
    transition: color .3s ease-in-out;
  }

  a:hover {
    color: #e08524;
    transition: color .3s ease-in-out;
  }

  pre, code, .mono, .name {
    font-family: "Ubuntu Mono", "Cousine", "DejaVu Sans Mono", monospace;
  }

  .title .name {
    font-weight: bold;
  }
  .section-title {
    margin-top: 2em;
  }
  .ident {
    color: #900;
  }

  code {
    background: #f9f9f9;
  } 

  pre {
    background: #fefefe;
    border: 1px solid #ddd;
    box-shadow: 2px 2px 0 #f3f3f3;
    margin: 0 30px;
    padding: 15px 30px;
  }

  .codehilite {
    margin: 0 30px 10px 30px;
  }

    .codehilite pre {
      margin: 0;
    }
    .codehilite .err { background: #ff3300; color: #fff !important; } 

  table#module-list {
    font-size: 110%;
  }

    table#module-list tr td:first-child {
      padding-right: 10px;
      white-space: nowrap;
    }

    table#module-list td {
      vertical-align: top;
      padding-bottom: 8px;
    }

      table#module-list td p {
        margin: 0 0 7px 0;
      }

  .def {
    display: table;
  }

    .def p {
      display: table-cell;
      vertical-align: top;
      text-align: left;
    }

    .def p:first-child {
      white-space: nowrap;
    }

    .def p:last-child {
      width: 100%;
    }


  #index {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }
    ul#index .class_name {
      /* font-size: 110%; */
      font-weight: bold;
    }
    #index ul {
      margin: 0;
    }

  .item {
    margin: 0 0 15px 0;
  }

    .item .class {
      margin: 0 0 25px 30px;
    }

      .item .class ul.class_list {
        margin: 0 0 20px 0;
      }

    .item .name {
      background: #fafafa;
      margin: 0;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 3px;
      display: inline-block;
      min-width: 40%;
    }
      .item .name:hover {
        background: #f6f6f6;
      }

    .item .empty_desc {
      margin: 0 0 5px 0;
      padding: 0;
    }

    .item .inheritance {
      margin: 3px 0 0 30px;
    }

    .item .inherited {
      color: #666;
    }

    .item .desc {
      padding: 0 8px;
      margin: 0;
    }

      .item .desc p {
        margin: 0 0 10px 0;
      }

    .source_cont {
      margin: 0;
      padding: 0;
    }

    .source_link a {
      background: #ffc300;
      font-weight: 400;
      font-size: .75em;
      text-transform: uppercase;
      color: #fff;
      text-shadow: 1px 1px 0 #f4b700;
      
      padding: 3px 8px;
      border-radius: 2px;
      transition: background .3s ease-in-out;
    }
      .source_link a:hover {
        background: #FF7200;
        text-shadow: none;
        transition: background .3s ease-in-out;
      }

    .source {
      display: none;
      max-height: 600px;
      overflow-y: scroll;
      margin-bottom: 15px;
    }

      .source .codehilite {
        margin: 0;
      }

  .desc h1, .desc h2, .desc h3 {
    font-size: 100% !important;
  }
  .clear {
    clear: both;
  }

  @media all and (max-width: 950px) {
    #sidebar {
      width: 35%;
    }
    #content {
      width: 65%;
    }
  }
  @media all and (max-width: 650px) {
    #top {
      display: none;
    }
    #sidebar {
      float: none;
      width: auto;
    }
    #content {
      float: none;
      width: auto;
      padding: 30px;
    }

    #index ul {
      padding: 0;
      margin-bottom: 15px;
    }
    #index ul li {
      display: inline-block;
      margin-right: 30px;
    }
    #footer {
      text-align: left;
    }
    #footer p {
      display: block;
      margin: inherit;
    }
  }

  /*****************************/

  </style>

  <style type="text/css">
  .codehilite .hll { background-color: #ffffcc }
.codehilite  { background: #f8f8f8; }
.codehilite .c { color: #408080; font-style: italic } /* Comment */
.codehilite .err { border: 1px solid #FF0000 } /* Error */
.codehilite .k { color: #008000; font-weight: bold } /* Keyword */
.codehilite .o { color: #666666 } /* Operator */
.codehilite .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.codehilite .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #BC7A00 } /* Comment.Preproc */
.codehilite .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.codehilite .c1 { color: #408080; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #408080; font-style: italic } /* Comment.Special */
.codehilite .gd { color: #A00000 } /* Generic.Deleted */
.codehilite .ge { font-style: italic } /* Generic.Emph */
.codehilite .gr { color: #FF0000 } /* Generic.Error */
.codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #00A000 } /* Generic.Inserted */
.codehilite .go { color: #888888 } /* Generic.Output */
.codehilite .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.codehilite .gt { color: #0044DD } /* Generic.Traceback */
.codehilite .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #008000 } /* Keyword.Pseudo */
.codehilite .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #B00040 } /* Keyword.Type */
.codehilite .m { color: #666666 } /* Literal.Number */
.codehilite .s { color: #BA2121 } /* Literal.String */
.codehilite .na { color: #7D9029 } /* Name.Attribute */
.codehilite .nb { color: #008000 } /* Name.Builtin */
.codehilite .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.codehilite .no { color: #880000 } /* Name.Constant */
.codehilite .nd { color: #AA22FF } /* Name.Decorator */
.codehilite .ni { color: #999999; font-weight: bold } /* Name.Entity */
.codehilite .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.codehilite .nf { color: #0000FF } /* Name.Function */
.codehilite .nl { color: #A0A000 } /* Name.Label */
.codehilite .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.codehilite .nt { color: #008000; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #19177C } /* Name.Variable */
.codehilite .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #bbbbbb } /* Text.Whitespace */
.codehilite .mb { color: #666666 } /* Literal.Number.Bin */
.codehilite .mf { color: #666666 } /* Literal.Number.Float */
.codehilite .mh { color: #666666 } /* Literal.Number.Hex */
.codehilite .mi { color: #666666 } /* Literal.Number.Integer */
.codehilite .mo { color: #666666 } /* Literal.Number.Oct */
.codehilite .sb { color: #BA2121 } /* Literal.String.Backtick */
.codehilite .sc { color: #BA2121 } /* Literal.String.Char */
.codehilite .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.codehilite .s2 { color: #BA2121 } /* Literal.String.Double */
.codehilite .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.codehilite .sh { color: #BA2121 } /* Literal.String.Heredoc */
.codehilite .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.codehilite .sx { color: #008000 } /* Literal.String.Other */
.codehilite .sr { color: #BB6688 } /* Literal.String.Regex */
.codehilite .s1 { color: #BA2121 } /* Literal.String.Single */
.codehilite .ss { color: #19177C } /* Literal.String.Symbol */
.codehilite .bp { color: #008000 } /* Name.Builtin.Pseudo */
.codehilite .vc { color: #19177C } /* Name.Variable.Class */
.codehilite .vg { color: #19177C } /* Name.Variable.Global */
.codehilite .vi { color: #19177C } /* Name.Variable.Instance */
.codehilite .il { color: #666666 } /* Literal.Number.Integer.Long */
  </style>

  <style type="text/css">
  
/* ==========================================================================
   EXAMPLE Media Queries for Responsive Design.
   These examples override the primary ('mobile first') styles.
   Modify as content requires.
   ========================================================================== */

@media only screen and (min-width: 35em) {
    /* Style adjustments for viewports that meet the condition */
}

@media print,
       (-o-min-device-pixel-ratio: 5/4),
       (-webkit-min-device-pixel-ratio: 1.25),
       (min-resolution: 120dpi) {
    /* Style adjustments for high resolution devices */
}

/* ==========================================================================
   Print styles.
   Inlined to avoid required HTTP connection: h5bp.com/r
   ========================================================================== */

@media print {
    * {
        background: transparent !important;
        color: #000 !important; /* Black prints faster: h5bp.com/s */
        box-shadow: none !important;
        text-shadow: none !important;
    }

    a,
    a:visited {
        text-decoration: underline;
    }

    a[href]:after {
        content: " (" attr(href) ")";
    }

    abbr[title]:after {
        content: " (" attr(title) ")";
    }

    /*
     * Don't show links for images, or javascript/internal links
     */

    .ir a:after,
    a[href^="javascript:"]:after,
    a[href^="#"]:after {
        content: "";
    }

    pre,
    blockquote {
        border: 1px solid #999;
        page-break-inside: avoid;
    }

    thead {
        display: table-header-group; /* h5bp.com/t */
    }

    tr,
    img {
        page-break-inside: avoid;
    }

    img {
        max-width: 100% !important;
    }

    @page {
        margin: 0.5cm;
    }

    p,
    h2,
    h3 {
        orphans: 3;
        widows: 3;
    }

    h2,
    h3 {
        page-break-after: avoid;
    }
}

  </style>

  <script type="text/javascript">
  function toggle(id, $link) {
    $node = document.getElementById(id);
    if (!$node)
    return;
    if (!$node.style.display || $node.style.display == 'none') {
    $node.style.display = 'block';
    $link.innerHTML = 'Hide source &nequiv;';
    } else {
    $node.style.display = 'none';
    $link.innerHTML = 'Show source &equiv;';
    }
  }
  </script>
</head>
<body>
<a href="#" id="top">Top</a>

<div id="container">
    
  
  <div id="sidebar">
    <h1>Index</h1>
    <ul id="index">
    <li class="set"><h3><a href="#header-variables">Module variables</a></h3>
      
  <ul>
    <li class="mono"><a href="#cbh_chem_api.compounds.ALL">ALL</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.ALL_WITH_RELATIONS">ALL_WITH_RELATIONS</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.WS_DEBUG">WS_DEBUG</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.handler400">handler400</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.handler403">handler403</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.handler404">handler404</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.handler500">handler500</a></li>
  </ul>

    </li>

    <li class="set"><h3><a href="#header-functions">Functions</a></h3>
      
  <ul>
    <li class="mono"><a href="#cbh_chem_api.compounds.build_content_type">build_content_type</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.deepgetattr">deepgetattr</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.get_all_sdf_headers">get_all_sdf_headers</a></li>
  </ul>

    </li>

    <li class="set"><h3><a href="#header-classes">Classes</a></h3>
      <ul>
        <li class="mono">
        <span class="class_name"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource">CBHCompoundUploadResource</a></span>
        
          
  <ul>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.__init__">__init__</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.after_save_and_index_hook">after_save_and_index_hook</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.alter_batch_data_after_save">alter_batch_data_after_save</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.alter_deserialized_detail_data">alter_deserialized_detail_data</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.alter_deserialized_list_data">alter_deserialized_list_data</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.alter_detail_data_to_serialize">alter_detail_data_to_serialize</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.alter_list_data_to_serialize">alter_list_data_to_serialize</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.api_field_from_django_field">api_field_from_django_field</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.apply_authorization_limits">apply_authorization_limits</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.apply_filters">apply_filters</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.apply_sorting">apply_sorting</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_create_detail">authorized_create_detail</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_create_list">authorized_create_list</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_delete_detail">authorized_delete_detail</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_delete_list">authorized_delete_list</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_read_detail">authorized_read_detail</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_read_list">authorized_read_list</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_update_detail">authorized_update_detail</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_update_list">authorized_update_list</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.base_urls">base_urls</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.batches_to_es_ready">batches_to_es_ready</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.build_bundle">build_bundle</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.build_filters">build_filters</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.build_schema">build_schema</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.cached_obj_get">cached_obj_get</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.cached_obj_get_list">cached_obj_get_list</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.can_create">can_create</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.can_delete">can_delete</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.can_update">can_update</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.check_filtering">check_filtering</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.convert_custom_field">convert_custom_field</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.create_identifier">create_identifier</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.create_response">create_response</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.dehydrate">dehydrate</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.dehydrate_resource_uri">dehydrate_resource_uri</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.delete_detail">delete_detail</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.delete_index">delete_index</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.delete_list">delete_list</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.deserialize">deserialize</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.detail_uri_kwargs">detail_uri_kwargs</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.determine_format">determine_format</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.dispatch">dispatch</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.dispatch_detail">dispatch_detail</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.dispatch_list">dispatch_list</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.error_response">error_response</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.filter_value_to_python">filter_value_to_python</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.full_dehydrate">full_dehydrate</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.full_hydrate">full_hydrate</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.generate_cache_key">generate_cache_key</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.get_bundle_detail_data">get_bundle_detail_data</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.get_cached_temporary_batch_data">get_cached_temporary_batch_data</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.get_cached_temporary_batches">get_cached_temporary_batches</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.get_detail">get_detail</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.get_fields">get_fields</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.get_list">get_list</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.get_multiple">get_multiple</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.get_object_list">get_object_list</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.get_part_processed_multiple_batch">get_part_processed_multiple_batch</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.get_resource_uri">get_resource_uri</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.get_schema">get_schema</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.get_via_uri">get_via_uri</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.hydrate">hydrate</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.hydrate_m2m">hydrate_m2m</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.is_authenticated">is_authenticated</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.is_valid">is_valid</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.log_throttled_access">log_throttled_access</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.lookup_kwargs_with_identifiers">lookup_kwargs_with_identifiers</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.method_check">method_check</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.multi_batch_custom_fields">multi_batch_custom_fields</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.multi_batch_save">multi_batch_save</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.obj_create">obj_create</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.obj_delete">obj_delete</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.obj_delete_list">obj_delete_list</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.obj_delete_list_for_update">obj_delete_list_for_update</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.obj_get">obj_get</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.obj_get_list">obj_get_list</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.obj_update">obj_update</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.override_urls">override_urls</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.patch_detail">patch_detail</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.patch_dict">patch_dict</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.patch_list">patch_list</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.post_detail">post_detail</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.post_list">post_list</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.post_validate_drawn">post_validate_drawn</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.post_validate_files">post_validate_files</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.post_validate_list">post_validate_list</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.prepend_urls">prepend_urls</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.preprocess_sdf_file">preprocess_sdf_file</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.put_detail">put_detail</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.put_list">put_list</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.remove_api_resource_names">remove_api_resource_names</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.resource_uri_kwargs">resource_uri_kwargs</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.rollback">rollback</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.save">save</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.save_m2m">save_m2m</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.save_related">save_related</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.serialize">serialize</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.set_cached_temporary_batches">set_cached_temporary_batches</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.should_skip_field">should_skip_field</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.throttle_check">throttle_check</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.unauthorized_result">unauthorized_result</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.update_in_place">update_in_place</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.update_temp_batches">update_temp_batches</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.validate_multi_batch">validate_multi_batch</a></li>
    <li class="mono"><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource.wrap_view">wrap_view</a></li>
  </ul>

        </li>
      </ul>
    </li>

    </ul>
  </div>

    <article id="content">
      
  

  


  <header id="section-intro">
  <h1 class="title"><span class="name">cbh_chem_api.compounds</span> module</h1>
  <p>nearly deprecated old inteface to the compounds API</p>
  
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds" class="source">
    <div class="codehilite"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">nearly deprecated old inteface to the compounds API</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">tastypie.resources</span> <span class="kn">import</span> <span class="n">ALL</span>
<span class="kn">from</span> <span class="nn">tastypie.resources</span> <span class="kn">import</span> <span class="n">ALL_WITH_RELATIONS</span>
<span class="kn">from</span> <span class="nn">tastypie.resources</span> <span class="kn">import</span> <span class="n">ModelResource</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ObjectDoesNotExist</span>
<span class="kn">from</span> <span class="nn">tastypie.authorization</span> <span class="kn">import</span> <span class="n">Authorization</span>
<span class="kn">from</span> <span class="nn">tastypie</span> <span class="kn">import</span> <span class="n">http</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">pybel</span> <span class="kn">import</span> <span class="n">readfile</span><span class="p">,</span> <span class="n">readstring</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shortuuid</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">elasticsearch_client</span>
<span class="kn">from</span> <span class="nn">difflib</span> <span class="kn">import</span> <span class="n">SequenceMatcher</span> <span class="k">as</span> <span class="n">fuzzymatch</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">rdkit</span> <span class="kn">import</span> <span class="n">Chem</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">Chem</span> <span class="o">=</span> <span class="bp">None</span>
<span class="kn">from</span> <span class="nn">tastypie.exceptions</span> <span class="kn">import</span> <span class="n">BadRequest</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">chembl_compatibility.models</span> <span class="kn">import</span> <span class="n">MoleculeDictionary</span>
    <span class="kn">from</span> <span class="nn">chembl_compatibility.models</span> <span class="kn">import</span> <span class="n">CompoundMols</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">chembl_core_model.models</span> <span class="kn">import</span> <span class="n">MoleculeDictionary</span>
    <span class="kn">from</span> <span class="nn">chembl_core_model.models</span> <span class="kn">import</span> <span class="n">CompoundMols</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">WS_DEBUG</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">WS_DEBUG</span>
<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
    <span class="n">WS_DEBUG</span> <span class="o">=</span> <span class="bp">False</span>
<span class="kn">from</span> <span class="nn">cbh_core_api.authorization</span> <span class="kn">import</span> <span class="n">ProjectAuthorization</span>
<span class="kn">from</span> <span class="nn">cbh_core_api.resources</span> <span class="kn">import</span> <span class="n">ChemregProjectResource</span><span class="p">,</span> <span class="n">ChemRegCustomFieldConfigResource</span><span class="p">,</span> <span class="n">NoCustomFieldsChemregProjectResource</span>
<span class="kn">from</span> <span class="nn">cbh_chem_api.serializers</span> <span class="kn">import</span> <span class="n">CBHCompoundBatchSerializer</span><span class="p">,</span> <span class="n">CBHCompoundBatchElasticSearchSerializer</span><span class="p">,</span> <span class="n">get_key_from_field_name</span>
<span class="kn">from</span> <span class="nn">tastypie.utils</span> <span class="kn">import</span> <span class="n">dict_strip_unicode_keys</span>
<span class="kn">from</span> <span class="nn">tastypie.serializers</span> <span class="kn">import</span> <span class="n">Serializer</span>
<span class="kn">from</span> <span class="nn">tastypie</span> <span class="kn">import</span> <span class="n">fields</span>
<span class="kn">from</span> <span class="nn">cbh_chembl_model_extension.models</span> <span class="kn">import</span> <span class="n">CBHCompoundBatch</span><span class="p">,</span> <span class="n">CBHCompoundMultipleBatch</span><span class="p">,</span> <span class="n">generate_structure_and_dictionary</span>
<span class="kn">from</span> <span class="nn">cbh_core_model.models</span> <span class="kn">import</span> <span class="n">Project</span><span class="p">,</span> <span class="n">PinnedCustomField</span>
<span class="kn">from</span> <span class="nn">tastypie.authentication</span> <span class="kn">import</span> <span class="n">SessionAuthentication</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">tastypie.paginator</span> <span class="kn">import</span> <span class="n">Paginator</span>
<span class="kn">from</span> <span class="nn">cbh_core_model.models</span> <span class="kn">import</span> <span class="n">CBHFlowFile</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Max</span><span class="p">,</span> <span class="n">Q</span>
<span class="kn">from</span> <span class="nn">tastypie.serializers</span> <span class="kn">import</span> <span class="n">Serializer</span>
<span class="kn">from</span> <span class="nn">tastypie.authentication</span> <span class="kn">import</span> <span class="n">SessionAuthentication</span>
<span class="kn">import</span> <span class="nn">chemdraw_reaction</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">get_user_model</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem.AllChem</span> <span class="kn">import</span> <span class="n">Compute2DCoords</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Prefetch</span>
<span class="kn">import</span> <span class="nn">dateutil.parser</span>
<span class="kn">from</span> <span class="nn">cbh_utils.parser</span> <span class="kn">import</span> <span class="n">parse_pandas_record</span><span class="p">,</span> <span class="n">parse_sdf_record</span><span class="p">,</span> <span class="n">apply_json_patch</span><span class="p">,</span> <span class="n">get_uncurated_fields_from_file</span>
<span class="c1"># from tastypie.utils.mime import build_content_type</span>
<span class="kn">from</span> <span class="nn">cbh_core_api.resources</span> <span class="kn">import</span> <span class="n">SimpleResourceURIField</span><span class="p">,</span> <span class="n">UserResource</span><span class="p">,</span> <span class="n">UserHydrate</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">cbh_chem_api.tasks</span> <span class="kn">import</span> <span class="n">process_batch_list</span>

<span class="k">def</span> <span class="nf">build_content_type</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Appends character encoding to the provided format if not already present.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;charset&#39;</span> <span class="ow">in</span> <span class="n">format</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">format</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">; charset=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="n">encoding</span><span class="p">)</span>




<span class="k">class</span> <span class="nc">CBHCompoundUploadResource</span><span class="p">(</span><span class="n">ModelResource</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Old CBHCompoundBatch resource now only used for bulk data uploads&quot;&quot;&quot;</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">SimpleResourceURIField</span><span class="p">(</span>
        <span class="n">NoCustomFieldsChemregProjectResource</span><span class="p">,</span> <span class="s1">&#39;project_id&#39;</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">creator</span> <span class="o">=</span> <span class="n">SimpleResourceURIField</span><span class="p">(</span><span class="n">UserResource</span><span class="p">,</span> <span class="s1">&#39;created_by_id&#39;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">filtering</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;std_ctab&quot;</span><span class="p">:</span> <span class="n">ALL_WITH_RELATIONS</span><span class="p">,</span>
            <span class="s2">&quot;ctab&quot;</span><span class="p">:</span> <span class="n">ALL</span><span class="p">,</span>
            <span class="s2">&quot;multiple_batch_id&quot;</span><span class="p">:</span> <span class="n">ALL_WITH_RELATIONS</span><span class="p">,</span>
            <span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="n">ALL_WITH_RELATIONS</span><span class="p">,</span>
            <span class="s2">&quot;with_substructure&quot;</span><span class="p">:</span> <span class="n">ALL_WITH_RELATIONS</span><span class="p">,</span>
            <span class="s2">&quot;similar_to&quot;</span><span class="p">:</span> <span class="n">ALL_WITH_RELATIONS</span><span class="p">,</span>
            <span class="s2">&quot;flexmatch&quot;</span><span class="p">:</span> <span class="n">ALL_WITH_RELATIONS</span><span class="p">,</span>
            <span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;gte&#39;</span><span class="p">,</span> <span class="s1">&#39;lte&#39;</span><span class="p">],</span>
            <span class="s2">&quot;created_by&quot;</span><span class="p">:</span> <span class="n">ALL_WITH_RELATIONS</span><span class="p">,</span>
            <span class="s2">&quot;excludes&quot;</span><span class="p">:</span> <span class="n">ALL_WITH_RELATIONS</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">always_return_data</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;related_molregno&quot;</span>
        <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;chembl_id&#39;</span><span class="p">,</span> <span class="s1">&#39;chemblId&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;pref_name&#39;</span><span class="p">,</span> <span class="s1">&#39;preferredCompoundName&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;max_phase&#39;</span><span class="p">,</span> <span class="s1">&#39;knownDrug&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundproperties.med_chem_friendly&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;medChemFriendly&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundproperties.ro3_pass&#39;</span><span class="p">,</span> <span class="s1">&#39;passesRuleOfThree&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundproperties.full_molformula&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;molecularFormula&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundstructures.canonical_smiles&#39;</span><span class="p">,</span> <span class="s1">&#39;smiles&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundstructures.standard_inchi_key&#39;</span><span class="p">,</span> <span class="s1">&#39;stdInChiKey&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundproperties.molecular_species&#39;</span><span class="p">,</span> <span class="s1">&#39;species&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundproperties.num_ro5_violations&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;numRo5Violations&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundproperties.rtb&#39;</span><span class="p">,</span> <span class="s1">&#39;rotatableBonds&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundproperties.mw_freebase&#39;</span><span class="p">,</span> <span class="s1">&#39;molecularWeight&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundproperties.alogp&#39;</span><span class="p">,</span> <span class="s1">&#39;alogp&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundproperties.acd_logp&#39;</span><span class="p">,</span> <span class="s1">&#39;acdLogp&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundproperties.acd_logd&#39;</span><span class="p">,</span> <span class="s1">&#39;acdLogd&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundproperties.acd_most_apka&#39;</span><span class="p">,</span> <span class="s1">&#39;acdAcidicPka&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundproperties.acd_most_bpka&#39;</span><span class="p">,</span> <span class="s1">&#39;acdBasicPka&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundproperties.full_molformula&#39;</span><span class="p">,</span> <span class="s1">&#39;fullMolformula&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;project.name&#39;</span><span class="p">,</span> <span class="s1">&#39;Project&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s1">&#39;multiple_batch_id&#39;</span><span class="p">,</span> <span class="s1">&#39;Upload ID&#39;</span><span class="p">)</span>

                      <span class="p">]</span>
                         
        <span class="n">fields_to_keep</span> <span class="o">=</span> <span class="p">{</span>
                          <span class="s1">&#39;Project&#39;</span><span class="p">:</span> <span class="s1">&#39;Project&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;chemblId&#39;</span><span class="p">:</span> <span class="s1">&#39;UOx ID&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;Batch ID&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;canonical_smiles&#39;</span><span class="p">:</span> <span class="s1">&#39;SMILES&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;created_by&#39;</span><span class="p">:</span> <span class="s1">&#39;Added By&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;standard_inchi&#39;</span><span class="p">:</span> <span class="s1">&#39;Std InChi&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;molecularWeight&#39;</span><span class="p">:</span> <span class="s1">&#39;Mol Weight&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;molecularFormula&#39;</span><span class="p">:</span> <span class="s1">&#39;Mol Formula&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;custom_fields&#39;</span><span class="p">:</span> <span class="s1">&#39;custom_fields&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;multiple_batch_id&#39;</span> <span class="p">:</span> <span class="s1">&#39;Upload ID&#39;</span> <span class="p">}</span>
        <span class="n">ordrered_ftk</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;chemblId&#39;</span><span class="p">,</span> <span class="s1">&#39;UOx ID&#39;</span><span class="p">),</span>
                                    <span class="p">(</span><span class="s1">&#39;canonical_smiles&#39;</span><span class="p">,</span> <span class="s1">&#39;SMILES&#39;</span><span class="p">),</span>
                                    <span class="p">(</span><span class="s1">&#39;knownDrug&#39;</span><span class="p">,</span> <span class="s1">&#39;Known Drug&#39;</span><span class="p">),</span>
                                    <span class="p">(</span><span class="s1">&#39;medChemFriendly&#39;</span><span class="p">,</span> <span class="s1">&#39;MedChem Friendly&#39;</span><span class="p">),</span>
                                    <span class="p">(</span><span class="s1">&#39;standard_inchi&#39;</span><span class="p">,</span> <span class="s1">&#39;Std InChi&#39;</span><span class="p">),</span>
                                    <span class="p">(</span><span class="s1">&#39;molecularWeight&#39;</span><span class="p">,</span> <span class="s1">&#39;Mol Weight&#39;</span><span class="p">),</span>
                                    <span class="p">(</span><span class="s1">&#39;acdLogp&#39;</span><span class="p">,</span> <span class="s1">&#39;alogp&#39;</span><span class="p">)])</span>

        <span class="n">queryset</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">resource_name</span> <span class="o">=</span> <span class="s1">&#39;cbh_compound_batches&#39;</span>
        <span class="n">authorization</span> <span class="o">=</span> <span class="n">ProjectAuthorization</span><span class="p">()</span>
        <span class="n">include_resource_uri</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">always_return_data</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">CBHCompoundBatchSerializer</span><span class="p">()</span>
        <span class="n">allowed_methods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="s1">&#39;patch&#39;</span><span class="p">]</span>
        <span class="n">default_format</span> <span class="o">=</span> <span class="s1">&#39;application/json&#39;</span>
        <span class="n">authentication</span> <span class="o">=</span> <span class="n">SessionAuthentication</span><span class="p">()</span>
        <span class="n">paginator_class</span> <span class="o">=</span> <span class="n">Paginator</span>
        <span class="c1"># elasticsearch config items</span>
        <span class="n">es_index_name</span> <span class="o">=</span> <span class="s2">&quot;chemreg_chemical_index&quot;</span>




 


    <span class="k">def</span> <span class="nf">alter_deserialized_list_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Weird way we added project to input data, not reccomended, now deprecated apart from for upload&quot;&quot;&quot;</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="n">Project</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">project_key</span><span class="o">=</span><span class="n">deserialized</span><span class="p">[</span><span class="s2">&quot;project_key&quot;</span><span class="p">])</span>
        <span class="n">deserialized</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proj</span>
        <span class="k">return</span> <span class="n">deserialized</span>

    <span class="k">def</span> <span class="nf">alter_deserialized_detail_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;A project may be necessary for create statements&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">deserialized</span><span class="p">[</span><span class="s2">&quot;project_key&quot;</span><span class="p">]:</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">Project</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">project_key</span><span class="o">=</span><span class="n">deserialized</span><span class="p">[</span><span class="s2">&quot;project_key&quot;</span><span class="p">])</span>
            <span class="n">deserialized</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proj</span>
        <span class="k">return</span> <span class="n">deserialized</span>

    <span class="k">def</span> <span class="nf">full_hydrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;As the object is created we run the validate code on it&#39;&#39;&#39;</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CBHCompoundUploadResource</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">full_hydrate</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">created_by</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span>
            <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">created_by_id</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
            <span class="c1"># bundle.obj.validate()</span>
            <span class="c1"># self.match_list_to_moleculedictionaries(bundle.obj,bundle.data[&quot;project&quot;] )</span>
        <span class="k">return</span> <span class="n">bundle</span>

    <span class="k">def</span> <span class="nf">prepend_urls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add lots of extra methods to the API&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">url</span><span class="p">(</span><span class="s2">r&quot;^(?P&lt;resource_name&gt;</span><span class="si">%s</span><span class="s2">)/delete_index/?$&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wrap_view</span><span class="p">(</span><span class="s1">&#39;delete_index&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;delete_index&quot;</span><span class="p">),</span>
            <span class="n">url</span><span class="p">(</span><span class="s2">r&quot;^(?P&lt;resource_name&gt;</span><span class="si">%s</span><span class="s2">)/update_temp_batches/?$&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wrap_view</span><span class="p">(</span><span class="s1">&#39;update_temp_batches&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;update_temp_batches&quot;</span><span class="p">),</span>
            <span class="n">url</span><span class="p">(</span><span class="s2">r&quot;^(?P&lt;resource_name&gt;</span><span class="si">%s</span><span class="s2">)/get_part_processed_multiple_batch/?$&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wrap_view</span><span class="p">(</span><span class="s1">&#39;get_part_processed_multiple_batch&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;api_get_part_processed_multiple_batch&quot;</span><span class="p">),</span>

            <span class="n">url</span><span class="p">(</span><span class="s2">r&quot;^(?P&lt;resource_name&gt;</span><span class="si">%s</span><span class="s2">)/validate_list/?$&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wrap_view</span><span class="p">(</span><span class="s1">&#39;post_validate_list&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;api_validate_compound_list&quot;</span><span class="p">),</span>
            <span class="n">url</span><span class="p">(</span><span class="s2">r&quot;^(?P&lt;resource_name&gt;</span><span class="si">%s</span><span class="s2">)/validate_drawn/?$&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wrap_view</span><span class="p">(</span><span class="s1">&#39;post_validate_drawn&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;api_validate_compound_drawn&quot;</span><span class="p">),</span>
            <span class="n">url</span><span class="p">(</span><span class="s2">r&quot;^(?P&lt;resource_name&gt;</span><span class="si">%s</span><span class="s2">)/multi_batch_save/?$&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wrap_view</span><span class="p">(</span><span class="s1">&#39;multi_batch_save&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;multi_batch_save&quot;</span><span class="p">),</span>
            <span class="n">url</span><span class="p">(</span><span class="s2">r&quot;^(?P&lt;resource_name&gt;</span><span class="si">%s</span><span class="s2">)/multi_batch_custom_fields/?$&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wrap_view</span><span class="p">(</span><span class="s1">&#39;multi_batch_custom_fields&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;multi_batch_custom_fields&quot;</span><span class="p">),</span>
            <span class="n">url</span><span class="p">(</span><span class="s2">r&quot;^(?P&lt;resource_name&gt;</span><span class="si">%s</span><span class="s2">)/validate_files/?$&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wrap_view</span><span class="p">(</span><span class="s1">&#39;post_validate_files&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;api_compound_validate_files&quot;</span><span class="p">),]</span>


  
    <span class="k">def</span> <span class="nf">patch_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictdata</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply a JSON patch to the data in a particular column&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">json_patches</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operations&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">json_patches</span><span class="p">:</span>
                <span class="n">apply_json_patch</span><span class="p">(</span><span class="n">dictdata</span><span class="p">,</span> <span class="n">json_patches</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">multi_batch_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save the data which has been cached in Elasticsearch&quot;&quot;&quot;</span>
        <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">))</span>

        <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_deserialized_detail_data</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">)</span>

        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">dict_strip_unicode_keys</span><span class="p">(</span><span class="n">deserialized</span><span class="p">),</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authorized_update_detail</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authorized_create_detail</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
        
        <span class="nb">id</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;multiplebatch&quot;</span><span class="p">]</span>
        <span class="n">mb</span> <span class="o">=</span> <span class="n">CBHCompoundMultipleBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="n">project</span> <span class="o">=</span> <span class="n">Serializer</span><span class="p">()</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">mb</span><span class="p">)</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">batches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">hasMoreData</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">mb</span><span class="o">.</span><span class="n">saved</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">mb</span><span class="o">.</span><span class="n">created_by</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span>
        <span class="n">mb</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;saved&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;ignored&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">hasMoreData</span><span class="p">:</span>
            <span class="n">bundles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cached_temporary_batch_data</span><span class="p">(</span>
                <span class="n">mb</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>  <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="s1">&#39;{&quot;term&quot; : {&quot;properties.action.raw&quot; : &quot;New Batch&quot;}}&#39;</span><span class="p">,</span><span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="n">limit</span><span class="p">,</span> <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="n">offset</span><span class="p">,</span> <span class="s2">&quot;sorts&quot;</span><span class="p">:</span> <span class="s1">&#39;[{&quot;id&quot;: {&quot;order&quot;: &quot;desc&quot;}}]&#39;</span><span class="p">},</span> <span class="n">request</span><span class="p">)</span>
           <span class="c1"># allowing setting of headers to be fale during saving of drawn molecule</span>
            <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">bundles</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patch_dict</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]))</span>
            <span class="n">set_of_batches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cached_temporary_batches</span><span class="p">(</span>
                <span class="n">bundles</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span>  <span class="n">bundledata</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">set_of_batches</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]:</span>
                <span class="k">if</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;New Batch&quot;</span><span class="p">):</span>
                    <span class="n">batch</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">created_by</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span>
                    <span class="n">batch</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">created_by_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
                    <span class="n">batch</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="n">batch</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">multiple_batch_id</span> <span class="o">=</span> <span class="nb">id</span>

                    <span class="c1"># batch.multi_batch_id = id</span>
                    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;saved&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">b</span><span class="o">.</span><span class="n">obj</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">set_of_batches</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]])</span>


            <span class="n">offset</span> <span class="o">+=</span> <span class="n">limit</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">set_of_batches</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">hasMoreData</span> <span class="o">=</span> <span class="bp">None</span>
        

        <span class="n">processed</span> <span class="o">=</span> <span class="p">[</span><span class="n">process_batch_list</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span> <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">]</span>


        <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">delete_index</span><span class="p">(</span>
            <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_temp_index_name</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">mb</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">after_save_and_index_hook</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">mb</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">project_key</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">http</span><span class="o">.</span><span class="n">HttpCreated</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">after_save_and_index_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">multi_batch_id</span><span class="p">,</span> <span class="n">project_key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Hook used to perform operations on data that has been saved&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">alter_batch_data_after_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_list</span><span class="p">,</span> <span class="n">python_file_object</span><span class="p">,</span><span class="n">request</span><span class="p">,</span> <span class="n">multi_batch</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Actually edit the data just after it has been saved&quot;&quot;&quot;</span>
        <span class="k">pass</span>


    <span class="k">def</span> <span class="nf">delete_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete the index that was created for a multiple batch&quot;&quot;&quot;</span>
        <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">))</span>

        <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_deserialized_detail_data</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">)</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">dict_strip_unicode_keys</span><span class="p">(</span><span class="n">deserialized</span><span class="p">),</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authorized_update_detail</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authorized_create_detail</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;multiplebatch&quot;</span><span class="p">]</span>
        <span class="n">mb</span> <span class="o">=</span> <span class="n">CBHCompoundMultipleBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">delete_index</span><span class="p">(</span>
            <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_temp_index_name</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">mb</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">http</span><span class="o">.</span><span class="n">HttpAccepted</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">convert_custom_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uncurated_value</span><span class="p">,</span> <span class="n">field_schema</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tidy up the custom field values&quot;&quot;&quot;</span>
        <span class="n">curated_value</span> <span class="o">=</span> <span class="n">uncurated_value</span>
        <span class="k">if</span> <span class="n">field_schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;format&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;yyyy-mm-dd&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">uncurated_value</span><span class="p">:</span>

                <span class="n">curated_value</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
                    <span class="n">uncurated_value</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">field_schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;field_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">PinnedCustomField</span><span class="o">.</span><span class="n">UISELECTTAGS</span><span class="p">):</span>

            <span class="n">curated_value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">uncurated_value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">field_schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;field_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">PinnedCustomField</span><span class="o">.</span><span class="n">INTEGER</span><span class="p">):</span>
            <span class="n">curated_value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">uncurated_value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">field_schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;field_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">PinnedCustomField</span><span class="o">.</span><span class="n">NUMBER</span><span class="p">,</span> <span class="n">PinnedCustomField</span><span class="o">.</span><span class="n">PERCENTAGE</span><span class="p">]):</span>
            <span class="n">curated_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">uncurated_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">curated_value</span>

    <span class="k">def</span> <span class="nf">update_temp_batches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Update a set of molecules into elasticsearch (used in ChemBio Hub to set the action field to ignore or new batch)&#39;&#39;&#39;</span>
        <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">))</span>

        <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_deserialized_detail_data</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">)</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">dict_strip_unicode_keys</span><span class="p">(</span><span class="n">deserialized</span><span class="p">),</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authorized_update_detail</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authorized_create_detail</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="n">multi_batch_id</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;multiplebatch&quot;</span><span class="p">]</span>
        <span class="n">es_serializer</span> <span class="o">=</span> <span class="n">CBHCompoundBatchElasticSearchSerializer</span><span class="p">()</span>
        <span class="n">es_ready_updates</span> <span class="o">=</span> <span class="p">[</span><span class="n">es_serializer</span><span class="o">.</span><span class="n">to_es_ready_data</span><span class="p">(</span><span class="n">dictdata</span><span class="p">,</span>
                                                           <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;underscorize&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span> <span class="k">for</span> <span class="n">dictdata</span> <span class="ow">in</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]]</span>
        <span class="n">index_name</span> <span class="o">=</span> <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_temp_index_name</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span> <span class="n">multi_batch_id</span><span class="p">)</span>
        <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">create_temporary_index</span><span class="p">(</span>
            <span class="n">es_ready_updates</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">index_name</span><span class="p">)</span>
        <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_action_totals</span><span class="p">(</span><span class="n">index_name</span><span class="p">,</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">http</span><span class="o">.</span><span class="n">HttpAccepted</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">multi_batch_custom_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;change the structure column for an excel file&#39;&#39;&#39;</span>
        <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">))</span>

        <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_deserialized_detail_data</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">)</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">dict_strip_unicode_keys</span><span class="p">(</span><span class="n">deserialized</span><span class="p">),</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authorized_update_detail</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authorized_create_detail</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;multiplebatch&quot;</span><span class="p">]</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span>
        <span class="c1"># structure_col = bundle.data.get(&quot;structure_col&quot;, None)</span>
        <span class="n">mb</span> <span class="o">=</span> <span class="n">CBHCompoundMultipleBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="n">processSmiles</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1"># if structure_col and structure_col != mb.uploaded_data.get(&quot;structure_col&quot;, &quot;&quot;):</span>
        <span class="c1">#     processSmiles =  True</span>
        <span class="n">index_name</span> <span class="o">=</span> <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_temp_index_name</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">mb</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_action_totals</span><span class="p">(</span><span class="n">index_name</span><span class="p">,</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">mb</span><span class="o">.</span><span class="n">uploaded_data</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span>
        <span class="n">mb</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">http</span><span class="o">.</span><span class="n">HttpAccepted</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate_multi_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multi_batch</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">batches</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate a set of staticstics about a set of data that has been uploaded&quot;&quot;&quot;</span>
        <span class="n">batches_not_errors</span> <span class="o">=</span> <span class="p">[</span><span class="n">batch</span> <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches</span> <span class="k">if</span> <span class="n">batch</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;parseerror&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;smilesParseError&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)]</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;no_data&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batches_not_errors</span><span class="p">:</span>
            <span class="n">b</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;New Batch&quot;</span>
        <span class="n">batches_with_structures</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">batch</span> <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches_not_errors</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">batch</span><span class="o">.</span><span class="n">blinded_batch_id</span><span class="p">]</span>
        <span class="n">blinded_data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">batch</span> <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches_not_errors</span> <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">blinded_batch_id</span><span class="p">]</span>
        <span class="n">sdfstrings</span> <span class="o">=</span> <span class="p">[</span><span class="n">batch</span><span class="o">.</span><span class="n">ctab</span> <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches_with_structures</span><span class="p">]</span>
        <span class="n">sdf</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sdfstrings</span><span class="p">)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;/tmp/&quot;</span> <span class="o">+</span> <span class="n">shortuuid</span><span class="o">.</span><span class="n">ShortUUID</span><span class="p">()</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
        <span class="n">text_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sdf</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">PIPE</span><span class="p">,</span> <span class="n">Popen</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">([</span><span class="n">settings</span><span class="o">.</span><span class="n">INCHI_BINARIES_LOCATION</span><span class="p">[</span><span class="s1">&#39;1.02&#39;</span><span class="p">],</span>
                   <span class="s2">&quot;-STDIO&quot;</span><span class="p">,</span>  <span class="n">filename</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="n">inchis</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1">#PB - there is an assumption here that everything that has a structure will generate an inChi without issue. This is not the case.</span>
        <span class="c1">#Where a molecule does not generate an inchi, there will be a key error looking up the inchi in inchiparts, as anything that cannot </span>
        <span class="c1">#generate an inchi will be missing from inchiparts, i.e. 50 structures with 1 error will have 49 entries in inchiparts, and this </span>
        <span class="c1">#will in turn bin the whole file - not great when we can handle erroring structures elsewhere</span>

        <span class="n">error_locs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">#a[0] holds the generated inchis. a[1] holds all of the error and warning information (if any)</span>
        <span class="n">errorparts</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error&quot;</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">errorparts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">errorp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">errorparts</span><span class="p">):</span>
                <span class="c1">#split on &#39;structure #&#39;, then get the number given</span>
                <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">splits</span> <span class="o">=</span> <span class="n">errorp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;structure #&#39;</span><span class="p">)</span>

                    <span class="n">error_loc</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1">#convert to number, put this number in an errors list</span>
                    <span class="n">error_locs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_loc</span><span class="p">)</span>

        <span class="n">err_batches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#for the errors found, remove from non-error lists and flag as erroring</span>
        <span class="k">for</span> <span class="n">error_no</span> <span class="ow">in</span> <span class="n">error_locs</span><span class="p">:</span>
            <span class="n">error_no_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">error_no</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="c1">#find structures at the position indicated - 1 (for 0-indexed list)</span>
            <span class="n">err_batch</span> <span class="o">=</span> <span class="n">batches_with_structures</span><span class="p">[</span><span class="n">error_no_int</span><span class="p">]</span>
            <span class="n">err_batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_batch</span><span class="p">)</span>
 
        <span class="c1">#we can&#39;t remove these while looping through err_locs as it messes up the list order and gives arrayindex exceptions</span>
        <span class="k">for</span> <span class="n">err_batch</span> <span class="ow">in</span> <span class="n">err_batches</span><span class="p">:</span>

            <span class="c1">#remove from batches_with_structures and batches_not_errors</span>
            <span class="n">batches_with_structures</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">err_batch</span><span class="p">)</span>
            <span class="n">batches_not_errors</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">err_batch</span><span class="p">)</span>

            <span class="c1">#flag this batch as erroring due to inability to generate anything for the standard_inchi_key field</span>
            <span class="n">batches_index</span> <span class="o">=</span> <span class="n">batches</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">err_batch</span><span class="p">)</span>
            <span class="n">batches</span><span class="p">[</span><span class="n">batches_index</span><span class="p">]</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;inchicreationerror&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
            <span class="n">batches</span><span class="p">[</span><span class="n">batches_index</span><span class="p">]</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ignore&quot;</span>


        <span class="n">inchiparts</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Structure:&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">inch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inchiparts</span><span class="p">):</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">inch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">ints</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]</span>
            <span class="n">part</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ints</span><span class="p">)</span>
            <span class="n">inchis</span><span class="p">[</span><span class="n">part</span><span class="p">]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fileerrors&quot;</span><span class="p">):</span>
            <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;fileerrors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">new_uploaded_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">already_found</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">batches_with_structures</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">error_locs</span><span class="p">):</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi</span> <span class="o">=</span> <span class="n">inchis</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">temp_props</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span> <span class="ow">in</span> <span class="n">already_found</span><span class="p">:</span>
                <span class="c1"># setting this in case we change it later</span>
                <span class="n">duplicates</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">already_found</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span><span class="p">)</span>

            <span class="n">new_uploaded_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">already_in_db</span> <span class="o">=</span> <span class="n">MoleculeDictionary</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                                                          <span class="s2">&quot;project&quot;</span><span class="p">],</span> <span class="n">structure_type</span><span class="o">=</span><span class="s2">&quot;MOL&quot;</span><span class="p">,</span> <span class="n">structure_key__in</span><span class="o">=</span><span class="n">already_found</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s2">&quot;structure_key&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">already_in_db</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">already_in_db</span><span class="p">)</span>

        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;new&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">new_data</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="n">duplicate_overlaps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="n">duplicate_new</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches_with_structures</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;duplicate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span> <span class="ow">in</span> <span class="n">already_in_db</span><span class="p">:</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;overlap&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
                    <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;duplicate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">duplicate_overlaps</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;new&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

                <span class="n">new_data</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
                    <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;duplicate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">duplicate_new</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches_with_structures</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nostructure&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;nostructure&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">blinded_data</span><span class="p">:</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;nostructure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;batchstats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;batchstats&quot;</span><span class="p">][</span><span class="s2">&quot;withstructure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">batches_with_structures</span><span class="p">)</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;batchstats&quot;</span><span class="p">][</span><span class="s2">&quot;parseerrors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">batches_not_errors</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span>
            <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batches_not_errors</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parseerror&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">])</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;batchstats&quot;</span><span class="p">][</span><span class="s2">&quot;withoutstructure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">blinded_data</span><span class="p">)</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;batchstats&quot;</span><span class="p">][</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;compoundstats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;compoundstats&quot;</span><span class="p">][</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">already_in_db</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;compoundstats&quot;</span><span class="p">][</span><span class="s2">&quot;overlaps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">already_in_db</span><span class="p">)</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;compoundstats&quot;</span><span class="p">][</span><span class="s2">&quot;new&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;compoundstats&quot;</span><span class="p">][</span>
            <span class="s2">&quot;duplicateoverlaps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">duplicate_overlaps</span><span class="p">)</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;compoundstats&quot;</span><span class="p">][</span><span class="s2">&quot;duplicatenew&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">duplicate_new</span><span class="p">)</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;multiplebatch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">multi_batch</span><span class="o">.</span><span class="n">pk</span>

        
        <span class="n">fifty_batches_for_first_page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_cached_temporary_batches</span><span class="p">(</span>
            <span class="n">batches</span><span class="p">,</span> <span class="n">multi_batch</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="n">multi_batch</span><span class="o">.</span><span class="n">uploaded_data</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span>
        <span class="n">multi_batch</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="c1">#bundle.data[&quot;objects&quot;] = fifty_batches_for_first_page</span>
        <span class="n">index_name</span> <span class="o">=</span> <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_temp_index_name</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span> <span class="n">multi_batch</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_action_totals</span><span class="p">(</span><span class="n">index_name</span><span class="p">,</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">http</span><span class="o">.</span><span class="n">HttpAccepted</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_part_processed_multiple_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the part processed data from elasticsearch and the stats about the</span>
<span class="sd">        multiple batch</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Uncached for now. Invalidation that works for everyone may be</span>
        <span class="c1">#       impossible.</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>

        <span class="c1"># self.authorized_create_detail(self.get_object_list(bundle.request), bundle)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;multi_batch&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)):</span>
            <span class="n">mb</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;multi_batch&quot;</span><span class="p">)</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;current_batch&quot;</span><span class="p">)</span>
            <span class="n">mb</span> <span class="o">=</span> <span class="n">CBHCompoundMultipleBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>

        <span class="n">to_be_serialized</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">uploaded_data</span>
        <span class="n">to_be_serialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cached_temporary_batch_data</span><span class="p">(</span>
            <span class="nb">id</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">bundledata</span><span class="o">=</span><span class="n">to_be_serialized</span><span class="p">)</span>
        <span class="n">index_name</span> <span class="o">=</span> <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_temp_index_name</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
        <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_action_totals</span><span class="p">(</span><span class="n">index_name</span><span class="p">,</span> <span class="n">to_be_serialized</span><span class="p">)</span>
        <span class="n">to_be_serialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_list_data_to_serialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">to_be_serialized</span><span class="p">,</span> <span class="n">permanent_data</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">to_be_serialized</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post_validate_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        When a list of SMILES patterns are submitted, save them to elasticsearhc and</span>
<span class="sd">        call the normal validate multi batch function to give the normal statistics page</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">))</span>

        <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_deserialized_detail_data</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">)</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">dict_strip_unicode_keys</span><span class="p">(</span><span class="n">deserialized</span><span class="p">),</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authorized_update_detail</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authorized_create_detail</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="n">smilesdata</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;smilesdata&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="p">[</span><span class="n">smi</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">smi</span> <span class="ow">in</span> <span class="n">smilesdata</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="bp">True</span><span class="p">)]</span>
        <span class="n">batches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># first assume smiles</span>
        <span class="n">allmols</span> <span class="o">=</span> <span class="p">[(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)))</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">]</span>
        <span class="c1"># Next test for inchi</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">allmols</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">inchimol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromInchi</span><span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">inchimol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">allmols</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">MolToSmiles</span><span class="p">(</span><span class="n">inchimol</span><span class="p">),</span> <span class="n">inchimol</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">allmols</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">Compute2DCoords</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">batches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">multiple_batch</span> <span class="o">=</span> <span class="n">CBHCompoundMultipleBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">mol2</span> <span class="ow">in</span> <span class="n">allmols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mol2</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">from_rd_mol</span><span class="p">(</span>
                    <span class="n">mol2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">smiles</span><span class="o">=</span><span class="n">mol2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">],</span> <span class="n">reDraw</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">blinded</span><span class="p">(</span>
                    <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
                <span class="n">b</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;smilesParseError&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
                <span class="n">b</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ignore&quot;</span>
                <span class="n">b</span><span class="o">.</span><span class="n">original_smiles</span> <span class="o">=</span> <span class="n">mol2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">b</span><span class="o">.</span><span class="n">multiple_batch_id</span> <span class="o">=</span> <span class="n">multiple_batch</span><span class="o">.</span><span class="n">pk</span>
            <span class="n">b</span><span class="o">.</span><span class="n">created_by</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span>
            <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;current_batch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">multiple_batch</span><span class="o">.</span><span class="n">pk</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_multi_batch</span><span class="p">(</span><span class="n">multiple_batch</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">batches</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post_validate_drawn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Turn a drawn molfile via chemdoodle into a processable </span>
<span class="sd">        rdkit mol to be used by the rest of the architecture</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">))</span>

        <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_deserialized_detail_data</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">)</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">dict_strip_unicode_keys</span><span class="p">(</span><span class="n">deserialized</span><span class="p">),</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authorized_update_detail</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authorized_create_detail</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="c1">#now get the SDfile from the request</span>
        <span class="n">ctab</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sketch&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="c1"># first assume ctab</span>
        <span class="c1"># allmols = [(obj, Chem.MolFromSmiles(str(obj))) for obj in objects]</span>
        <span class="c1"># we need to make allmols a single-entry list in order to use the rst of the architecture</span>

        <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromMolBlock</span><span class="p">(</span><span class="n">ctab</span><span class="p">)</span>
        <span class="c1">#for each of the supplied custom fields, use set prop to replicate how this would be if it was an sd file.</span>
        <span class="n">prj_data_fields</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;custom_fields&#39;</span><span class="p">,{})</span>
        <span class="n">sup_data_fields</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;supplementary_fields&#39;</span><span class="p">,[])</span>
        <span class="k">if</span><span class="p">(</span><span class="n">mol</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k1</span><span class="p">,</span> <span class="n">v1</span> <span class="ow">in</span> <span class="n">prj_data_fields</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                    <span class="n">v1str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">v1</span><span class="p">:</span>
                        <span class="n">v1str</span> <span class="o">=</span> <span class="n">v1str</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
                    <span class="n">mol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="n">k1</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">),</span> <span class="n">v1str</span><span class="p">)</span>
                <span class="c1">#not a unicode string? Don&#39;t try and ascii encode the result, </span>
                <span class="c1">#just add it as a value converted to a string (which SetProp expects)</span>
                <span class="k">elif</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">True</span><span class="p">):</span>
                    <span class="n">mol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="n">k1</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">v1</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="n">k1</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">),</span> <span class="n">v1</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">sup_data_fields</span><span class="p">:</span>
                <span class="n">mol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">),</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">))</span>
        
        <span class="n">allmols</span> <span class="o">=</span> <span class="p">[</span> <span class="n">mol</span> <span class="p">]</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">batches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">multiple_batch</span> <span class="o">=</span> <span class="n">CBHCompoundMultipleBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">from_rd_mol</span><span class="p">(</span>
                <span class="n">mol</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">],</span> <span class="n">orig_ctab</span><span class="o">=</span><span class="n">ctab</span><span class="p">)</span>
            <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">blinded</span><span class="p">(</span>
                            <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
            <span class="n">b</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;parseerror&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
            <span class="n">b</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ignore&quot;</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
        <span class="n">b</span><span class="o">.</span><span class="n">custom_fields</span> <span class="o">=</span> <span class="n">prj_data_fields</span>
        <span class="n">b</span><span class="o">.</span><span class="n">uncurated_fields</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1">#iterate the supplementary fields</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">sup_data_fields</span><span class="p">:</span>
            <span class="n">b</span><span class="o">.</span><span class="n">uncurated_fields</span><span class="p">[</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;current_batch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">multiple_batch</span><span class="o">.</span><span class="n">pk</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">errors</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_multi_batch</span><span class="p">(</span><span class="n">multiple_batch</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">batches</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">preprocess_sdf_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_obj</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the input SDF file and add some extra information to it&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">post_validate_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Receive a CBHFlowFile ID which points at an uploaded SDF, XLSX or CDX file</span>
<span class="sd">        Perform validation on the file&#39;s contents and then send the resultant elasticsearch index</span>
<span class="sd">        to the validate mult batch method</span>
<span class="sd">        More about data import information can be found in the wiki</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">automapped_structure</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">))</span>

        <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_deserialized_detail_data</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">)</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">dict_strip_unicode_keys</span><span class="p">(</span><span class="n">deserialized</span><span class="p">),</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authorized_create_detail</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span>
        <span class="n">session_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">COOKIES</span><span class="p">[</span><span class="n">settings</span><span class="o">.</span><span class="n">SESSION_COOKIE_NAME</span><span class="p">]</span>
        <span class="n">correct_file</span> <span class="o">=</span> <span class="n">CBHFlowFile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">identifier</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">session_key</span><span class="p">,</span> <span class="n">file_name</span><span class="p">))</span>
        <span class="n">batches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fielderrors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">fielderrors</span><span class="p">[</span><span class="s2">&quot;stringdate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="n">fielderrors</span><span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="n">fielderrors</span><span class="p">[</span><span class="s2">&quot;integer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="n">structure_col</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;struccol&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;.cdx&quot;</span> <span class="ow">in</span> <span class="n">correct_file</span><span class="o">.</span><span class="n">extension</span><span class="p">):</span>
            <span class="n">mols</span> <span class="o">=</span> <span class="p">[</span><span class="n">mol</span> <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">readfile</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">correct_file</span><span class="o">.</span><span class="n">extension</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">correct_file</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="p">)]</span>
            <span class="n">rxn</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">correct_file</span><span class="o">.</span><span class="n">extension</span> <span class="o">==</span> <span class="s1">&#39;.cdxml&#39;</span><span class="p">:</span>
                <span class="c1"># Look for a stoichiometry table in the reaction file</span>
                <span class="n">rxn</span> <span class="o">=</span> <span class="n">chemdraw_reaction</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">correct_file</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;%Completion&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;%Yield&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;Expected Moles&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;Product Moles&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;Expected Mass&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;Product Mass&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;MW&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;role&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;Purity&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;Limit Moles&quot;</span><span class="p">,</span>
                           <span class="c1"># &quot;Formula&quot;,</span>
                           <span class="s2">&quot;Equivalents&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;Measured Mass&quot;</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">pybelmol</span> <span class="ow">in</span> <span class="n">mols</span><span class="p">:</span>
                <span class="n">molfile</span> <span class="o">=</span> <span class="n">pybelmol</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;mdl&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">molfile</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="n">molfile</span> <span class="o">!=</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span>
                    <span class="n">rd_mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromMolBlock</span><span class="p">(</span><span class="n">molfile</span><span class="p">,</span> <span class="n">sanitize</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                    Pybel can read some hypervalent molecules that RDKit cannot read</span>
<span class="sd">                    Therefore currently these molecules are outputted as images and sent back to the front end</span>
<span class="sd">                    https://www.mail-archive.com/rdkit-discuss@lists.sourceforge.net/msg04466.html</span>
<span class="sd">                    &#39;&#39;&#39;</span>
                    <span class="k">if</span> <span class="n">rd_mol</span><span class="p">:</span>
                        <span class="n">smiles</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolToSmiles</span><span class="p">(</span><span class="n">rd_mol</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">smiles</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">from_rd_mol</span><span class="p">(</span>
                                    <span class="n">rd_mol</span><span class="p">,</span> <span class="n">orig_ctab</span><span class="o">=</span><span class="n">molfile</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="n">smiles</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                                <span class="n">b</span> <span class="o">=</span> <span class="bp">None</span>
                                <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">b</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">rxn</span><span class="p">:</span>
                                    <span class="c1"># Here we set the uncurated fields equal to</span>
                                    <span class="c1"># the reaction data extracted from Chemdraw</span>
                                    <span class="n">b</span><span class="o">.</span><span class="n">uncurated_fields</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                        <span class="n">pybelmol</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="p">{})</span>
                                <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">pybelmol</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                    <span class="s2">&quot;svg&quot;</span><span class="p">),</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Unable to produce inchi from this molecule&quot;</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">pybelmol</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                            <span class="s2">&quot;svg&quot;</span><span class="p">),</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid valency or other error parsing this molecule&quot;</span><span class="p">})</span>
                    <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">correct_file</span><span class="o">.</span><span class="n">extension</span> <span class="o">==</span> <span class="s2">&quot;.sdf&quot;</span><span class="p">):</span>
                <span class="c1"># read in the file</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_sdf_file</span><span class="p">(</span><span class="n">correct_file</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
                <span class="n">suppl</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">ForwardSDMolSupplier</span><span class="p">(</span><span class="n">correct_file</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
                <span class="n">mols</span> <span class="o">=</span> <span class="p">[</span><span class="n">mo</span> <span class="k">for</span> <span class="n">mo</span> <span class="ow">in</span> <span class="n">suppl</span><span class="p">]</span>
                <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;file_too_large&quot;</span><span class="p">)</span>
                <span class="c1"># read the headers from the first molecule</span>

                <span class="n">headers</span> <span class="o">=</span> <span class="n">get_all_sdf_headers</span><span class="p">(</span><span class="n">correct_file</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">uncurated</span><span class="p">,</span> <span class="n">ctabs</span> <span class="o">=</span> <span class="n">get_uncurated_fields_from_file</span><span class="p">(</span><span class="n">correct_file</span><span class="p">,</span> <span class="n">fielderrors</span><span class="p">)</span>
                
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">mol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mols</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">blinded</span><span class="p">(</span>
                            <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
                        <span class="n">b</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;parseerror&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
                        <span class="n">b</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ignore&quot;</span>

                        <span class="n">b</span><span class="o">.</span><span class="n">uncurated_fields</span> <span class="o">=</span> <span class="n">uncurated</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>  <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;No structure found&quot;</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">from_rd_mol</span><span class="p">(</span>
                                <span class="n">mol</span><span class="p">,</span> <span class="n">orig_ctab</span><span class="o">=</span><span class="n">ctabs</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">blinded</span><span class="p">(</span>
                            <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
                            <span class="n">b</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;parseerror&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
                            <span class="n">b</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ignore&quot;</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>  <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
                       
                        <span class="n">b</span><span class="o">.</span><span class="n">uncurated_fields</span> <span class="o">=</span> <span class="n">uncurated</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

                    <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

            <span class="k">elif</span><span class="p">(</span><span class="n">correct_file</span><span class="o">.</span><span class="n">extension</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;.xls&quot;</span><span class="p">,</span> <span class="s2">&quot;.xlsx&quot;</span><span class="p">)):</span>
                <span class="c1"># we need to know which column contains structural info - this needs to be defined on the mapping page and passed here</span>
                <span class="c1"># read in the specified structural column</span>

                <span class="n">headerswithdata</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>

                <span class="n">df</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">correct_file</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;no_headers&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;file_too_large&quot;</span><span class="p">)</span>
                <span class="c1"># read the smiles string value out of here, when we know which</span>
                <span class="c1"># column it is.</span>
                <span class="n">row_iterator</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;__&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">]</span>
                <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">headers</span>
                <span class="c1"># Only automap on the first attempt at mapping the smiles</span>
                    <span class="c1"># column</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">structure_col</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;headers&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
                    <span class="n">max_score</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
                        <span class="c1"># fuzzy matching for smiles - this should also</span>
                        <span class="c1"># match things like &quot;canonical_smiles&quot;</span>
                        <span class="n">hdr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[^0-9a-zA-Z]+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hdr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">):</span>
                            <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">h</span><span class="p">:</span>
                                <span class="n">score</span> <span class="o">=</span> <span class="n">fuzzymatch</span><span class="p">(</span>
                                    <span class="n">a</span><span class="o">=</span><span class="s2">&quot;smiles&quot;</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span>
                                <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">max_score</span> <span class="ow">and</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">:</span>
                                    <span class="n">structure_col</span> <span class="o">=</span> <span class="n">header</span>
                                    <span class="n">max_score</span> <span class="o">=</span> <span class="n">score</span>
                                    <span class="n">automapped_structure</span> <span class="o">=</span> <span class="bp">True</span>
                
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">row_iterator</span><span class="p">:</span>
                    
                    <span class="k">if</span> <span class="n">structure_col</span><span class="p">:</span>
                        <span class="n">smiles_str</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">structure_col</span><span class="p">]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">struc</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles_str</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">struc</span><span class="p">:</span>
                                <span class="n">Compute2DCoords</span><span class="p">(</span><span class="n">struc</span><span class="p">)</span>
                                <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">from_rd_mol</span><span class="p">(</span>
                                    <span class="n">struc</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="n">smiles_str</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">],</span> <span class="n">reDraw</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                                <span class="n">b</span><span class="o">.</span><span class="n">blinded_batch_id</span> <span class="o">=</span> <span class="bp">None</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Smiles not processed&quot;</span><span class="p">)</span>

                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">blinded</span><span class="p">(</span>
                                <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
                            <span class="n">b</span><span class="o">.</span><span class="n">original_smiles</span> <span class="o">=</span> <span class="n">smiles_str</span>
                            <span class="n">b</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;parseerror&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
                            <span class="n">b</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ignore&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">blinded</span><span class="p">(</span>
                            <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>

                    <span class="k">if</span> <span class="nb">dict</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">uncurated_fields</span><span class="p">)</span> <span class="o">==</span> <span class="p">{}:</span>
                            <span class="c1"># Only rebuild the uncurated fields if this has not</span>
                            <span class="c1"># been done before</span>
                        <span class="n">parse_pandas_record</span><span class="p">(</span>
                                <span class="n">headers</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="s2">&quot;uncurated_fields&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">fielderrors</span><span class="p">,</span> <span class="n">headerswithdata</span><span class="p">)</span>
                   
                    <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="n">hdr</span> <span class="k">for</span> <span class="n">hdr</span> <span class="ow">in</span> <span class="n">headers</span> <span class="k">if</span> <span class="n">hdr</span> <span class="ow">in</span> <span class="n">headerswithdata</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;file_format_error&quot;</span><span class="p">)</span>
        <span class="n">multiple_batch</span> <span class="o">=</span> <span class="n">CBHCompoundMultipleBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">],</span>
                <span class="n">uploaded_file</span><span class="o">=</span><span class="n">correct_file</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batches</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">b</span><span class="p">:</span>
                <span class="n">b</span><span class="o">.</span><span class="n">multiple_batch_id</span> <span class="o">=</span> <span class="n">multiple_batch</span><span class="o">.</span><span class="n">pk</span>
                <span class="n">b</span><span class="o">.</span><span class="n">created_by</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span>

        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;fileerrors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">errors</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;automapped&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cfr</span> <span class="o">=</span> <span class="n">ChemRegCustomFieldConfigResource</span><span class="p">()</span>
        <span class="n">jsondata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cfr</span><span class="o">.</span><span class="n">get_detail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
            <span class="n">pk</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">custom_field_config_id</span><span class="p">)</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="n">schemaform</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="p">[</span><span class="s2">&quot;edit_form&quot;</span><span class="p">][</span><span class="s2">&quot;form&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">jsondata</span><span class="p">[</span><span class="s2">&quot;project_data_fields&quot;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;headers&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
                <span class="n">copyto</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">automapped</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">operations</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">header</span> <span class="o">==</span> <span class="n">structure_col</span><span class="p">:</span>
                    <span class="n">copyto</span> <span class="o">=</span> <span class="s2">&quot;SMILES for chemical structures&quot;</span>
                    <span class="k">if</span> <span class="n">automapped_structure</span><span class="p">:</span>
                        <span class="n">automapped</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">form</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">schemaform</span><span class="p">)</span>
                    <span class="n">copyto</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">max_score</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">form_item</span> <span class="ow">in</span> <span class="n">form</span><span class="p">:</span>
                        <span class="n">score</span> <span class="o">=</span> <span class="n">fuzzymatch</span><span class="p">(</span>
                            <span class="n">a</span><span class="o">=</span><span class="n">form_item</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">b</span><span class="o">=</span><span class="n">header</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">max_score</span> <span class="ow">and</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">:</span>
                            <span class="n">matched_item</span> <span class="o">=</span> <span class="n">form_item</span>
                            <span class="n">copyto</span> <span class="o">=</span> <span class="n">matched_item</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span>
                            <span class="n">automapped</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="k">if</span><span class="p">(</span><span class="n">matched_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;field_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;uiselecttags&quot;</span><span class="p">):</span>
                                <span class="n">operations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="p">{</span><span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="s2">&quot;split&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/uncurated_fields/&quot;</span> <span class="o">+</span> <span class="n">header</span><span class="p">})</span>
                                <span class="n">operations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="p">{</span><span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="s2">&quot;move&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/custom_fields/&quot;</span> <span class="o">+</span> <span class="n">matched_item</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">],</span> <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;/uncurated_fields/&quot;</span> <span class="o">+</span> <span class="n">header</span><span class="p">})</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">operation</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="s2">&quot;move&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/custom_fields/&quot;</span> <span class="o">+</span> <span class="n">matched_item</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">],</span> <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;/uncurated_fields/&quot;</span> <span class="o">+</span> <span class="n">header</span><span class="p">}</span>
                                <span class="n">operations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">operation</span><span class="p">)</span>
                                <span class="k">if</span><span class="p">(</span><span class="n">matched_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;format&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;date&quot;</span><span class="p">):</span>
                                    <span class="n">operations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                        <span class="p">{</span><span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="s2">&quot;convertdate&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/custom_fields/&quot;</span> <span class="o">+</span> <span class="n">matched_item</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]})</span>
                            <span class="c1">#set the max score so less well matched content than this is ignored</span>
                            <span class="n">max_score</span> <span class="o">=</span> <span class="n">score</span>

                <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">header</span><span class="p">,</span>
                    <span class="s2">&quot;automapped&quot;</span><span class="p">:</span> <span class="n">automapped</span><span class="p">,</span>
                    <span class="s2">&quot;copyto&quot;</span><span class="p">:</span> <span class="n">copyto</span><span class="p">,</span>
                    <span class="s2">&quot;operations&quot;</span><span class="p">:</span> <span class="n">operations</span><span class="p">,</span>
                    <span class="s2">&quot;fieldErrors&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;stringdate&quot;</span><span class="p">:</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">fielderrors</span><span class="p">[</span><span class="s2">&quot;stringdate&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;integer&quot;</span><span class="p">:</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">fielderrors</span><span class="p">[</span><span class="s2">&quot;integer&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">fielderrors</span><span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">]</span>
                    <span class="p">}</span>
                <span class="p">})</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_multi_batch</span><span class="p">(</span><span class="n">multiple_batch</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">batches</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">create_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">HttpResponse</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts the common &quot;which-format/serialize/return-response&quot; cycle.</span>
<span class="sd">        Mostly a useful shortcut/hook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">desired_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_format</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">serialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">desired_format</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Meta</span><span class="o">.</span><span class="n">ordrered_ftk</span><span class="p">)</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">response_class</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">serialized</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="n">build_content_type</span><span class="p">(</span>
            <span class="n">desired_format</span><span class="p">),</span> <span class="o">**</span><span class="n">response_kwargs</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">desired_format</span> <span class="o">==</span> <span class="s1">&#39;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&#39;</span><span class="p">):</span>
            <span class="n">rc</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;attachment; filename=export_from_chembiohub_chemreg</span><span class="si">%d</span><span class="s1">.xlsx&#39;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">desired_format</span> <span class="o">==</span> <span class="s1">&#39;chemical/x-mdl-sdfile&#39;</span><span class="p">):</span>
            <span class="n">rc</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;attachment; filename=export_from_chembiohub_chemreg</span><span class="si">%d</span><span class="s1">.sdf&#39;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">rc</span>

    <span class="k">def</span> <span class="nf">dehydrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tidy up the data adding timestamp etc, now mostly deprecated&quot;&quot;&quot;</span>
        <span class="c1"># try:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">related_molregno</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">for</span> <span class="n">names</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Meta</span><span class="o">.</span><span class="n">fieldnames</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">blinded_batch_id</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">deepgetattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">except</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>
                    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;chemblId&quot;</span><span class="p">:</span>
                    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">blinded_batch_id</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">created_by</span><span class="p">:</span>
          <span class="c1">#user = User.objects.get(username=bundle.obj.created_by)</span>
            <span class="n">User</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">created_by</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ObjectDoesNotExist</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">first_name</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">created_by</span><span class="o">.</span><span class="n">split</span><span class="p">[</span><span class="s2">&quot; &quot;</span><span class="p">][</span>
                                            <span class="mi">0</span><span class="p">],</span> <span class="n">last_name</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">created_by</span><span class="o">.</span><span class="n">split</span><span class="p">[</span><span class="s2">&quot; &quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">user</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">mynames</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;uncurated_fields&quot;</span><span class="p">,</span> <span class="s2">&quot;warnings&quot;</span><span class="p">,</span> <span class="s2">&quot;properties&quot;</span><span class="p">,</span> <span class="s2">&quot;custom_fields&quot;</span><span class="p">,]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">mynames</span><span class="p">:</span>
            <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            
        <span class="c1">#bundle.data[&quot;created_by&quot;] = user.__dict__</span>
        <span class="k">if</span> <span class="n">user</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">first_name</span><span class="p">:</span>
                <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;created_by&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">user</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">last_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;created_by&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;created_by&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">created_by</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;created&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
        <span class="c1"># except:</span>
        <span class="c1">#    pass</span>
        <span class="k">return</span> <span class="n">bundle</span>

    <span class="k">def</span> <span class="nf">batches_to_es_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batches</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">non_chem_data_only</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert the data to be ready to submit to elasticsearch&quot;&quot;&quot;</span>
        <span class="n">batch_dicts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">es_serializer</span> <span class="o">=</span> <span class="n">CBHCompoundBatchElasticSearchSerializer</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">batch</span><span class="p">:</span>
                <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">batch</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
                    <span class="n">batch</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">index</span>
                <span class="n">bun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
                <span class="n">bun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_dehydrate</span><span class="p">(</span><span class="n">bun</span><span class="p">,</span> <span class="n">for_list</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">bun</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">bun</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                        <span class="s2">&quot;project&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;/</span><span class="si">%s</span><span class="s1">/cbh_projects/</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">WEBSERVICES_NAME</span><span class="p">,</span> <span class="n">bun</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">project_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">non_chem_data_only</span><span class="p">:</span>
                    <span class="n">ready</span> <span class="o">=</span> <span class="n">es_serializer</span><span class="o">.</span><span class="n">to_es_ready_non_chemical_data</span><span class="p">(</span>
                        <span class="n">bun</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;underscorize&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ready</span> <span class="o">=</span> <span class="n">es_serializer</span><span class="o">.</span><span class="n">to_es_ready_data</span><span class="p">(</span>
                        <span class="n">bun</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;underscorize&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>

                <span class="n">batch_dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ready</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># preserve the line number of the batch that could not be</span>
                <span class="c1"># processed</span>
                <span class="n">batch_dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span>
                     <span class="s2">&quot;warnings&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;parseerror&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
                                  <span class="p">},</span>
                     <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;Ignore&quot;</span><span class="p">},</span>
                     <span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">)</span>
                     <span class="p">}</span>
                <span class="p">)</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">batch_dicts</span>

    <span class="k">def</span> <span class="nf">set_cached_temporary_batches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batches</span><span class="p">,</span> <span class="n">multi_batch_id</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Index the new data when a new bulk upload is done&quot;&quot;&quot;</span>
        <span class="n">es_serializer</span> <span class="o">=</span> <span class="n">CBHCompoundBatchElasticSearchSerializer</span><span class="p">()</span>
        <span class="n">batch_dicts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches_to_es_ready</span><span class="p">(</span><span class="n">batches</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="n">index_name</span> <span class="o">=</span> <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_temp_index_name</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span> <span class="n">multi_batch_id</span><span class="p">)</span>
        <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">create_temporary_index</span><span class="p">(</span>
            <span class="n">batch_dicts</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">index_name</span><span class="p">)</span>
        <span class="c1"># Now get rid of my ES preparation again</span>

    <span class="k">def</span> <span class="nf">get_cached_temporary_batches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundles</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">bundledata</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;Request the imported data which has been cached in Elasticsearch&quot;&quot;&quot;</span>
        <span class="n">fakeobj</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="n">bundledata</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">],</span> <span class="nb">id</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">bun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">fakeobj</span><span class="p">)</span>
        <span class="n">bun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_dehydrate</span><span class="p">(</span><span class="n">bun</span><span class="p">)</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="n">bun</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">datum</span> <span class="ow">in</span> <span class="n">bundles</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]:</span>
        
            <span class="n">datum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">datum</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>

            <span class="n">datum</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proj</span>
            <span class="n">datum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_hydrate</span><span class="p">(</span><span class="n">datum</span><span class="p">)</span>
            <span class="c1">#Quick hack to fix saving of sutom fields when validating a sketch</span>
            <span class="k">if</span> <span class="n">bundledata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;sketch&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">bundles</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">datum</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;custom_fields&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bundledata</span><span class="p">[</span><span class="s2">&quot;custom_fields&quot;</span><span class="p">]</span>
                <span class="n">datum</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">custom_fields</span> <span class="o">=</span> <span class="n">bundledata</span><span class="p">[</span><span class="s2">&quot;custom_fields&quot;</span><span class="p">]</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datum</span><span class="p">)</span>
        <span class="n">bundles</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">return</span> <span class="n">bundles</span>

   
    <span class="k">def</span> <span class="nf">get_cached_temporary_batch_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multi_batch_id</span><span class="p">,</span> <span class="n">get_data</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">bundledata</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;make the batch data into models so it can be serialized properly&quot;&quot;&quot;</span>
        <span class="n">es_request</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">get_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;offset&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">get_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limit&quot;</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
            <span class="s2">&quot;filter&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">get_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;query&quot;</span><span class="p">,</span> <span class="s1">&#39;{ &quot;match_all&quot; : {}}&#39;</span><span class="p">)),</span>
            <span class="s2">&quot;sort&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">get_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sorts&quot;</span><span class="p">,</span> <span class="s1">&#39;[{&quot;id&quot;: {&quot;order&quot;: &quot;asc&quot;}}]&#39;</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_temp_index_name</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span> <span class="n">multi_batch_id</span><span class="p">)</span>
        <span class="n">es_serializer</span> <span class="o">=</span> <span class="n">CBHCompoundBatchElasticSearchSerializer</span><span class="p">()</span>
        <span class="n">bundledata</span> <span class="o">=</span> <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">es_request</span><span class="p">,</span> <span class="n">bundledata</span><span class="p">)</span>
        <span class="n">bundledata</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">es_serializer</span><span class="o">.</span><span class="n">to_python_ready_data</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">bundledata</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">bundledata</span>

    <span class="k">def</span> <span class="nf">get_object_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;where to add select related etc.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CBHCompoundUploadResource</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">deepgetattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">ex</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Recurses through an attribute chain to get the ultimate value.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">reduce</span><span class="p">(</span><span class="nb">getattr</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">),</span> <span class="n">obj</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ex</span>


    


<span class="k">def</span> <span class="nf">get_all_sdf_headers</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Use the unix tools grep, cut, sort and uniq to pull out a set of headers from a file&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span><span class="p">,</span> <span class="n">PIPE</span>
    <span class="kn">from</span> <span class="nn">shlex</span> <span class="kn">import</span> <span class="n">split</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;grep &quot;^&gt;&quot; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">),</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;cut -d &quot;&lt;&quot; -f2&#39;</span><span class="p">),</span> <span class="n">stdin</span><span class="o">=</span><span class="n">p1</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">p3</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;cut -d &quot;&gt;&quot; -f1&#39;</span><span class="p">),</span> <span class="n">stdin</span><span class="o">=</span><span class="n">p2</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">p4</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;sort&#39;</span><span class="p">),</span> <span class="n">stdin</span><span class="o">=</span><span class="n">p3</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">p5</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;uniq&#39;</span><span class="p">),</span> <span class="n">stdin</span><span class="o">=</span><span class="n">p4</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">p5</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span><span class="p">]</span>
</pre></div>

  </div>

  </header>

  <section id="section-items">
    <h2 class="section-title" id="header-variables">Module variables</h2>
      <div class="item">
      <p id="cbh_chem_api.compounds.ALL" class="name">var <span class="ident">ALL</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="cbh_chem_api.compounds.ALL_WITH_RELATIONS" class="name">var <span class="ident">ALL_WITH_RELATIONS</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="cbh_chem_api.compounds.WS_DEBUG" class="name">var <span class="ident">WS_DEBUG</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="cbh_chem_api.compounds.handler400" class="name">var <span class="ident">handler400</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="cbh_chem_api.compounds.handler403" class="name">var <span class="ident">handler403</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="cbh_chem_api.compounds.handler404" class="name">var <span class="ident">handler404</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="cbh_chem_api.compounds.handler500" class="name">var <span class="ident">handler500</span></p>
      
  
  <div class="source_cont">
</div>

      </div>

    <h2 class="section-title" id="header-functions">Functions</h2>
      
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.build_content_type">
    <p>def <span class="ident">build_content_type</span>(</p><p>format, encoding=&#39;utf-8&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>Appends character encoding to the provided format if not already present.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.build_content_type', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.build_content_type" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">build_content_type</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Appends character encoding to the provided format if not already present.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;charset&#39;</span> <span class="ow">in</span> <span class="n">format</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">format</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">; charset=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="n">encoding</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.deepgetattr">
    <p>def <span class="ident">deepgetattr</span>(</p><p>obj, attr, ex)</p>
    </div>
    

    
  
    <div class="desc"><p>Recurses through an attribute chain to get the ultimate value.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.deepgetattr', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.deepgetattr" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">deepgetattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">ex</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Recurses through an attribute chain to get the ultimate value.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">reduce</span><span class="p">(</span><span class="nb">getattr</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">),</span> <span class="n">obj</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ex</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.get_all_sdf_headers">
    <p>def <span class="ident">get_all_sdf_headers</span>(</p><p>filename)</p>
    </div>
    

    
  
    <div class="desc"><p>Use the unix tools grep, cut, sort and uniq to pull out a set of headers from a file</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.get_all_sdf_headers', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.get_all_sdf_headers" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_all_sdf_headers</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Use the unix tools grep, cut, sort and uniq to pull out a set of headers from a file&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span><span class="p">,</span> <span class="n">PIPE</span>
    <span class="kn">from</span> <span class="nn">shlex</span> <span class="kn">import</span> <span class="n">split</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;grep &quot;^&gt;&quot; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">),</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;cut -d &quot;&lt;&quot; -f2&#39;</span><span class="p">),</span> <span class="n">stdin</span><span class="o">=</span><span class="n">p1</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">p3</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;cut -d &quot;&gt;&quot; -f1&#39;</span><span class="p">),</span> <span class="n">stdin</span><span class="o">=</span><span class="n">p2</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">p4</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;sort&#39;</span><span class="p">),</span> <span class="n">stdin</span><span class="o">=</span><span class="n">p3</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">p5</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;uniq&#39;</span><span class="p">),</span> <span class="n">stdin</span><span class="o">=</span><span class="n">p4</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">p5</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  

    <h2 class="section-title" id="header-classes">Classes</h2>
      
      <div class="item">
      <p id="cbh_chem_api.compounds.CBHCompoundUploadResource" class="name">class <span class="ident">CBHCompoundUploadResource</span></p>
      
  
    <div class="desc"><p>Old CBHCompoundBatch resource now only used for bulk data uploads</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">CBHCompoundUploadResource</span><span class="p">(</span><span class="n">ModelResource</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Old CBHCompoundBatch resource now only used for bulk data uploads&quot;&quot;&quot;</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">SimpleResourceURIField</span><span class="p">(</span>
        <span class="n">NoCustomFieldsChemregProjectResource</span><span class="p">,</span> <span class="s1">&#39;project_id&#39;</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">creator</span> <span class="o">=</span> <span class="n">SimpleResourceURIField</span><span class="p">(</span><span class="n">UserResource</span><span class="p">,</span> <span class="s1">&#39;created_by_id&#39;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">filtering</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;std_ctab&quot;</span><span class="p">:</span> <span class="n">ALL_WITH_RELATIONS</span><span class="p">,</span>
            <span class="s2">&quot;ctab&quot;</span><span class="p">:</span> <span class="n">ALL</span><span class="p">,</span>
            <span class="s2">&quot;multiple_batch_id&quot;</span><span class="p">:</span> <span class="n">ALL_WITH_RELATIONS</span><span class="p">,</span>
            <span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="n">ALL_WITH_RELATIONS</span><span class="p">,</span>
            <span class="s2">&quot;with_substructure&quot;</span><span class="p">:</span> <span class="n">ALL_WITH_RELATIONS</span><span class="p">,</span>
            <span class="s2">&quot;similar_to&quot;</span><span class="p">:</span> <span class="n">ALL_WITH_RELATIONS</span><span class="p">,</span>
            <span class="s2">&quot;flexmatch&quot;</span><span class="p">:</span> <span class="n">ALL_WITH_RELATIONS</span><span class="p">,</span>
            <span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;gte&#39;</span><span class="p">,</span> <span class="s1">&#39;lte&#39;</span><span class="p">],</span>
            <span class="s2">&quot;created_by&quot;</span><span class="p">:</span> <span class="n">ALL_WITH_RELATIONS</span><span class="p">,</span>
            <span class="s2">&quot;excludes&quot;</span><span class="p">:</span> <span class="n">ALL_WITH_RELATIONS</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">always_return_data</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;related_molregno&quot;</span>
        <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;chembl_id&#39;</span><span class="p">,</span> <span class="s1">&#39;chemblId&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;pref_name&#39;</span><span class="p">,</span> <span class="s1">&#39;preferredCompoundName&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;max_phase&#39;</span><span class="p">,</span> <span class="s1">&#39;knownDrug&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundproperties.med_chem_friendly&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;medChemFriendly&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundproperties.ro3_pass&#39;</span><span class="p">,</span> <span class="s1">&#39;passesRuleOfThree&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundproperties.full_molformula&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;molecularFormula&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundstructures.canonical_smiles&#39;</span><span class="p">,</span> <span class="s1">&#39;smiles&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundstructures.standard_inchi_key&#39;</span><span class="p">,</span> <span class="s1">&#39;stdInChiKey&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundproperties.molecular_species&#39;</span><span class="p">,</span> <span class="s1">&#39;species&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundproperties.num_ro5_violations&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;numRo5Violations&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundproperties.rtb&#39;</span><span class="p">,</span> <span class="s1">&#39;rotatableBonds&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundproperties.mw_freebase&#39;</span><span class="p">,</span> <span class="s1">&#39;molecularWeight&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundproperties.alogp&#39;</span><span class="p">,</span> <span class="s1">&#39;alogp&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundproperties.acd_logp&#39;</span><span class="p">,</span> <span class="s1">&#39;acdLogp&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundproperties.acd_logd&#39;</span><span class="p">,</span> <span class="s1">&#39;acdLogd&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundproperties.acd_most_apka&#39;</span><span class="p">,</span> <span class="s1">&#39;acdAcidicPka&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundproperties.acd_most_bpka&#39;</span><span class="p">,</span> <span class="s1">&#39;acdBasicPka&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;compoundproperties.full_molformula&#39;</span><span class="p">,</span> <span class="s1">&#39;fullMolformula&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;project.name&#39;</span><span class="p">,</span> <span class="s1">&#39;Project&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s1">&#39;multiple_batch_id&#39;</span><span class="p">,</span> <span class="s1">&#39;Upload ID&#39;</span><span class="p">)</span>

                      <span class="p">]</span>
                         
        <span class="n">fields_to_keep</span> <span class="o">=</span> <span class="p">{</span>
                          <span class="s1">&#39;Project&#39;</span><span class="p">:</span> <span class="s1">&#39;Project&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;chemblId&#39;</span><span class="p">:</span> <span class="s1">&#39;UOx ID&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;Batch ID&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;canonical_smiles&#39;</span><span class="p">:</span> <span class="s1">&#39;SMILES&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;created_by&#39;</span><span class="p">:</span> <span class="s1">&#39;Added By&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;standard_inchi&#39;</span><span class="p">:</span> <span class="s1">&#39;Std InChi&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;molecularWeight&#39;</span><span class="p">:</span> <span class="s1">&#39;Mol Weight&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;molecularFormula&#39;</span><span class="p">:</span> <span class="s1">&#39;Mol Formula&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;custom_fields&#39;</span><span class="p">:</span> <span class="s1">&#39;custom_fields&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;multiple_batch_id&#39;</span> <span class="p">:</span> <span class="s1">&#39;Upload ID&#39;</span> <span class="p">}</span>
        <span class="n">ordrered_ftk</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;chemblId&#39;</span><span class="p">,</span> <span class="s1">&#39;UOx ID&#39;</span><span class="p">),</span>
                                    <span class="p">(</span><span class="s1">&#39;canonical_smiles&#39;</span><span class="p">,</span> <span class="s1">&#39;SMILES&#39;</span><span class="p">),</span>
                                    <span class="p">(</span><span class="s1">&#39;knownDrug&#39;</span><span class="p">,</span> <span class="s1">&#39;Known Drug&#39;</span><span class="p">),</span>
                                    <span class="p">(</span><span class="s1">&#39;medChemFriendly&#39;</span><span class="p">,</span> <span class="s1">&#39;MedChem Friendly&#39;</span><span class="p">),</span>
                                    <span class="p">(</span><span class="s1">&#39;standard_inchi&#39;</span><span class="p">,</span> <span class="s1">&#39;Std InChi&#39;</span><span class="p">),</span>
                                    <span class="p">(</span><span class="s1">&#39;molecularWeight&#39;</span><span class="p">,</span> <span class="s1">&#39;Mol Weight&#39;</span><span class="p">),</span>
                                    <span class="p">(</span><span class="s1">&#39;acdLogp&#39;</span><span class="p">,</span> <span class="s1">&#39;alogp&#39;</span><span class="p">)])</span>

        <span class="n">queryset</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">resource_name</span> <span class="o">=</span> <span class="s1">&#39;cbh_compound_batches&#39;</span>
        <span class="n">authorization</span> <span class="o">=</span> <span class="n">ProjectAuthorization</span><span class="p">()</span>
        <span class="n">include_resource_uri</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">always_return_data</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">CBHCompoundBatchSerializer</span><span class="p">()</span>
        <span class="n">allowed_methods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="s1">&#39;patch&#39;</span><span class="p">]</span>
        <span class="n">default_format</span> <span class="o">=</span> <span class="s1">&#39;application/json&#39;</span>
        <span class="n">authentication</span> <span class="o">=</span> <span class="n">SessionAuthentication</span><span class="p">()</span>
        <span class="n">paginator_class</span> <span class="o">=</span> <span class="n">Paginator</span>
        <span class="c1"># elasticsearch config items</span>
        <span class="n">es_index_name</span> <span class="o">=</span> <span class="s2">&quot;chemreg_chemical_index&quot;</span>




 


    <span class="k">def</span> <span class="nf">alter_deserialized_list_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Weird way we added project to input data, not reccomended, now deprecated apart from for upload&quot;&quot;&quot;</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="n">Project</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">project_key</span><span class="o">=</span><span class="n">deserialized</span><span class="p">[</span><span class="s2">&quot;project_key&quot;</span><span class="p">])</span>
        <span class="n">deserialized</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proj</span>
        <span class="k">return</span> <span class="n">deserialized</span>

    <span class="k">def</span> <span class="nf">alter_deserialized_detail_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;A project may be necessary for create statements&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">deserialized</span><span class="p">[</span><span class="s2">&quot;project_key&quot;</span><span class="p">]:</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">Project</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">project_key</span><span class="o">=</span><span class="n">deserialized</span><span class="p">[</span><span class="s2">&quot;project_key&quot;</span><span class="p">])</span>
            <span class="n">deserialized</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proj</span>
        <span class="k">return</span> <span class="n">deserialized</span>

    <span class="k">def</span> <span class="nf">full_hydrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;As the object is created we run the validate code on it&#39;&#39;&#39;</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CBHCompoundUploadResource</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">full_hydrate</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">created_by</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span>
            <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">created_by_id</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
            <span class="c1"># bundle.obj.validate()</span>
            <span class="c1"># self.match_list_to_moleculedictionaries(bundle.obj,bundle.data[&quot;project&quot;] )</span>
        <span class="k">return</span> <span class="n">bundle</span>

    <span class="k">def</span> <span class="nf">prepend_urls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add lots of extra methods to the API&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">url</span><span class="p">(</span><span class="s2">r&quot;^(?P&lt;resource_name&gt;</span><span class="si">%s</span><span class="s2">)/delete_index/?$&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wrap_view</span><span class="p">(</span><span class="s1">&#39;delete_index&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;delete_index&quot;</span><span class="p">),</span>
            <span class="n">url</span><span class="p">(</span><span class="s2">r&quot;^(?P&lt;resource_name&gt;</span><span class="si">%s</span><span class="s2">)/update_temp_batches/?$&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wrap_view</span><span class="p">(</span><span class="s1">&#39;update_temp_batches&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;update_temp_batches&quot;</span><span class="p">),</span>
            <span class="n">url</span><span class="p">(</span><span class="s2">r&quot;^(?P&lt;resource_name&gt;</span><span class="si">%s</span><span class="s2">)/get_part_processed_multiple_batch/?$&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wrap_view</span><span class="p">(</span><span class="s1">&#39;get_part_processed_multiple_batch&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;api_get_part_processed_multiple_batch&quot;</span><span class="p">),</span>

            <span class="n">url</span><span class="p">(</span><span class="s2">r&quot;^(?P&lt;resource_name&gt;</span><span class="si">%s</span><span class="s2">)/validate_list/?$&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wrap_view</span><span class="p">(</span><span class="s1">&#39;post_validate_list&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;api_validate_compound_list&quot;</span><span class="p">),</span>
            <span class="n">url</span><span class="p">(</span><span class="s2">r&quot;^(?P&lt;resource_name&gt;</span><span class="si">%s</span><span class="s2">)/validate_drawn/?$&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wrap_view</span><span class="p">(</span><span class="s1">&#39;post_validate_drawn&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;api_validate_compound_drawn&quot;</span><span class="p">),</span>
            <span class="n">url</span><span class="p">(</span><span class="s2">r&quot;^(?P&lt;resource_name&gt;</span><span class="si">%s</span><span class="s2">)/multi_batch_save/?$&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wrap_view</span><span class="p">(</span><span class="s1">&#39;multi_batch_save&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;multi_batch_save&quot;</span><span class="p">),</span>
            <span class="n">url</span><span class="p">(</span><span class="s2">r&quot;^(?P&lt;resource_name&gt;</span><span class="si">%s</span><span class="s2">)/multi_batch_custom_fields/?$&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wrap_view</span><span class="p">(</span><span class="s1">&#39;multi_batch_custom_fields&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;multi_batch_custom_fields&quot;</span><span class="p">),</span>
            <span class="n">url</span><span class="p">(</span><span class="s2">r&quot;^(?P&lt;resource_name&gt;</span><span class="si">%s</span><span class="s2">)/validate_files/?$&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wrap_view</span><span class="p">(</span><span class="s1">&#39;post_validate_files&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;api_compound_validate_files&quot;</span><span class="p">),]</span>


  
    <span class="k">def</span> <span class="nf">patch_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictdata</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply a JSON patch to the data in a particular column&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">json_patches</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operations&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">json_patches</span><span class="p">:</span>
                <span class="n">apply_json_patch</span><span class="p">(</span><span class="n">dictdata</span><span class="p">,</span> <span class="n">json_patches</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">multi_batch_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save the data which has been cached in Elasticsearch&quot;&quot;&quot;</span>
        <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">))</span>

        <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_deserialized_detail_data</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">)</span>

        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">dict_strip_unicode_keys</span><span class="p">(</span><span class="n">deserialized</span><span class="p">),</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authorized_update_detail</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authorized_create_detail</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
        
        <span class="nb">id</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;multiplebatch&quot;</span><span class="p">]</span>
        <span class="n">mb</span> <span class="o">=</span> <span class="n">CBHCompoundMultipleBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="n">project</span> <span class="o">=</span> <span class="n">Serializer</span><span class="p">()</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">mb</span><span class="p">)</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">batches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">hasMoreData</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">mb</span><span class="o">.</span><span class="n">saved</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">mb</span><span class="o">.</span><span class="n">created_by</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span>
        <span class="n">mb</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;saved&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;ignored&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">hasMoreData</span><span class="p">:</span>
            <span class="n">bundles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cached_temporary_batch_data</span><span class="p">(</span>
                <span class="n">mb</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>  <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="s1">&#39;{&quot;term&quot; : {&quot;properties.action.raw&quot; : &quot;New Batch&quot;}}&#39;</span><span class="p">,</span><span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="n">limit</span><span class="p">,</span> <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="n">offset</span><span class="p">,</span> <span class="s2">&quot;sorts&quot;</span><span class="p">:</span> <span class="s1">&#39;[{&quot;id&quot;: {&quot;order&quot;: &quot;desc&quot;}}]&#39;</span><span class="p">},</span> <span class="n">request</span><span class="p">)</span>
           <span class="c1"># allowing setting of headers to be fale during saving of drawn molecule</span>
            <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">bundles</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patch_dict</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]))</span>
            <span class="n">set_of_batches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cached_temporary_batches</span><span class="p">(</span>
                <span class="n">bundles</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span>  <span class="n">bundledata</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">set_of_batches</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]:</span>
                <span class="k">if</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;New Batch&quot;</span><span class="p">):</span>
                    <span class="n">batch</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">created_by</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span>
                    <span class="n">batch</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">created_by_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
                    <span class="n">batch</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="n">batch</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">multiple_batch_id</span> <span class="o">=</span> <span class="nb">id</span>

                    <span class="c1"># batch.multi_batch_id = id</span>
                    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;saved&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">b</span><span class="o">.</span><span class="n">obj</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">set_of_batches</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]])</span>


            <span class="n">offset</span> <span class="o">+=</span> <span class="n">limit</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">set_of_batches</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">hasMoreData</span> <span class="o">=</span> <span class="bp">None</span>
        

        <span class="n">processed</span> <span class="o">=</span> <span class="p">[</span><span class="n">process_batch_list</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span> <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">]</span>


        <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">delete_index</span><span class="p">(</span>
            <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_temp_index_name</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">mb</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">after_save_and_index_hook</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">mb</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">project_key</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">http</span><span class="o">.</span><span class="n">HttpCreated</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">after_save_and_index_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">multi_batch_id</span><span class="p">,</span> <span class="n">project_key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Hook used to perform operations on data that has been saved&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">alter_batch_data_after_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_list</span><span class="p">,</span> <span class="n">python_file_object</span><span class="p">,</span><span class="n">request</span><span class="p">,</span> <span class="n">multi_batch</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Actually edit the data just after it has been saved&quot;&quot;&quot;</span>
        <span class="k">pass</span>


    <span class="k">def</span> <span class="nf">delete_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete the index that was created for a multiple batch&quot;&quot;&quot;</span>
        <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">))</span>

        <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_deserialized_detail_data</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">)</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">dict_strip_unicode_keys</span><span class="p">(</span><span class="n">deserialized</span><span class="p">),</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authorized_update_detail</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authorized_create_detail</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;multiplebatch&quot;</span><span class="p">]</span>
        <span class="n">mb</span> <span class="o">=</span> <span class="n">CBHCompoundMultipleBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">delete_index</span><span class="p">(</span>
            <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_temp_index_name</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">mb</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">http</span><span class="o">.</span><span class="n">HttpAccepted</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">convert_custom_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uncurated_value</span><span class="p">,</span> <span class="n">field_schema</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tidy up the custom field values&quot;&quot;&quot;</span>
        <span class="n">curated_value</span> <span class="o">=</span> <span class="n">uncurated_value</span>
        <span class="k">if</span> <span class="n">field_schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;format&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;yyyy-mm-dd&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">uncurated_value</span><span class="p">:</span>

                <span class="n">curated_value</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
                    <span class="n">uncurated_value</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">field_schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;field_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">PinnedCustomField</span><span class="o">.</span><span class="n">UISELECTTAGS</span><span class="p">):</span>

            <span class="n">curated_value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">uncurated_value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">field_schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;field_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">PinnedCustomField</span><span class="o">.</span><span class="n">INTEGER</span><span class="p">):</span>
            <span class="n">curated_value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">uncurated_value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">field_schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;field_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">PinnedCustomField</span><span class="o">.</span><span class="n">NUMBER</span><span class="p">,</span> <span class="n">PinnedCustomField</span><span class="o">.</span><span class="n">PERCENTAGE</span><span class="p">]):</span>
            <span class="n">curated_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">uncurated_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">curated_value</span>

    <span class="k">def</span> <span class="nf">update_temp_batches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Update a set of molecules into elasticsearch (used in ChemBio Hub to set the action field to ignore or new batch)&#39;&#39;&#39;</span>
        <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">))</span>

        <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_deserialized_detail_data</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">)</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">dict_strip_unicode_keys</span><span class="p">(</span><span class="n">deserialized</span><span class="p">),</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authorized_update_detail</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authorized_create_detail</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="n">multi_batch_id</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;multiplebatch&quot;</span><span class="p">]</span>
        <span class="n">es_serializer</span> <span class="o">=</span> <span class="n">CBHCompoundBatchElasticSearchSerializer</span><span class="p">()</span>
        <span class="n">es_ready_updates</span> <span class="o">=</span> <span class="p">[</span><span class="n">es_serializer</span><span class="o">.</span><span class="n">to_es_ready_data</span><span class="p">(</span><span class="n">dictdata</span><span class="p">,</span>
                                                           <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;underscorize&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span> <span class="k">for</span> <span class="n">dictdata</span> <span class="ow">in</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]]</span>
        <span class="n">index_name</span> <span class="o">=</span> <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_temp_index_name</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span> <span class="n">multi_batch_id</span><span class="p">)</span>
        <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">create_temporary_index</span><span class="p">(</span>
            <span class="n">es_ready_updates</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">index_name</span><span class="p">)</span>
        <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_action_totals</span><span class="p">(</span><span class="n">index_name</span><span class="p">,</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">http</span><span class="o">.</span><span class="n">HttpAccepted</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">multi_batch_custom_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;change the structure column for an excel file&#39;&#39;&#39;</span>
        <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">))</span>

        <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_deserialized_detail_data</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">)</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">dict_strip_unicode_keys</span><span class="p">(</span><span class="n">deserialized</span><span class="p">),</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authorized_update_detail</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authorized_create_detail</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;multiplebatch&quot;</span><span class="p">]</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span>
        <span class="c1"># structure_col = bundle.data.get(&quot;structure_col&quot;, None)</span>
        <span class="n">mb</span> <span class="o">=</span> <span class="n">CBHCompoundMultipleBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="n">processSmiles</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1"># if structure_col and structure_col != mb.uploaded_data.get(&quot;structure_col&quot;, &quot;&quot;):</span>
        <span class="c1">#     processSmiles =  True</span>
        <span class="n">index_name</span> <span class="o">=</span> <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_temp_index_name</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">mb</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_action_totals</span><span class="p">(</span><span class="n">index_name</span><span class="p">,</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">mb</span><span class="o">.</span><span class="n">uploaded_data</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span>
        <span class="n">mb</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">http</span><span class="o">.</span><span class="n">HttpAccepted</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate_multi_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multi_batch</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">batches</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate a set of staticstics about a set of data that has been uploaded&quot;&quot;&quot;</span>
        <span class="n">batches_not_errors</span> <span class="o">=</span> <span class="p">[</span><span class="n">batch</span> <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches</span> <span class="k">if</span> <span class="n">batch</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;parseerror&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;smilesParseError&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)]</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;no_data&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batches_not_errors</span><span class="p">:</span>
            <span class="n">b</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;New Batch&quot;</span>
        <span class="n">batches_with_structures</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">batch</span> <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches_not_errors</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">batch</span><span class="o">.</span><span class="n">blinded_batch_id</span><span class="p">]</span>
        <span class="n">blinded_data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">batch</span> <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches_not_errors</span> <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">blinded_batch_id</span><span class="p">]</span>
        <span class="n">sdfstrings</span> <span class="o">=</span> <span class="p">[</span><span class="n">batch</span><span class="o">.</span><span class="n">ctab</span> <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches_with_structures</span><span class="p">]</span>
        <span class="n">sdf</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sdfstrings</span><span class="p">)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;/tmp/&quot;</span> <span class="o">+</span> <span class="n">shortuuid</span><span class="o">.</span><span class="n">ShortUUID</span><span class="p">()</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
        <span class="n">text_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sdf</span><span class="p">)</span>
        <span class="n">text_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">PIPE</span><span class="p">,</span> <span class="n">Popen</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">([</span><span class="n">settings</span><span class="o">.</span><span class="n">INCHI_BINARIES_LOCATION</span><span class="p">[</span><span class="s1">&#39;1.02&#39;</span><span class="p">],</span>
                   <span class="s2">&quot;-STDIO&quot;</span><span class="p">,</span>  <span class="n">filename</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="n">inchis</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1">#PB - there is an assumption here that everything that has a structure will generate an inChi without issue. This is not the case.</span>
        <span class="c1">#Where a molecule does not generate an inchi, there will be a key error looking up the inchi in inchiparts, as anything that cannot </span>
        <span class="c1">#generate an inchi will be missing from inchiparts, i.e. 50 structures with 1 error will have 49 entries in inchiparts, and this </span>
        <span class="c1">#will in turn bin the whole file - not great when we can handle erroring structures elsewhere</span>

        <span class="n">error_locs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">#a[0] holds the generated inchis. a[1] holds all of the error and warning information (if any)</span>
        <span class="n">errorparts</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error&quot;</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">errorparts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">errorp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">errorparts</span><span class="p">):</span>
                <span class="c1">#split on &#39;structure #&#39;, then get the number given</span>
                <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">splits</span> <span class="o">=</span> <span class="n">errorp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;structure #&#39;</span><span class="p">)</span>

                    <span class="n">error_loc</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1">#convert to number, put this number in an errors list</span>
                    <span class="n">error_locs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_loc</span><span class="p">)</span>

        <span class="n">err_batches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#for the errors found, remove from non-error lists and flag as erroring</span>
        <span class="k">for</span> <span class="n">error_no</span> <span class="ow">in</span> <span class="n">error_locs</span><span class="p">:</span>
            <span class="n">error_no_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">error_no</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="c1">#find structures at the position indicated - 1 (for 0-indexed list)</span>
            <span class="n">err_batch</span> <span class="o">=</span> <span class="n">batches_with_structures</span><span class="p">[</span><span class="n">error_no_int</span><span class="p">]</span>
            <span class="n">err_batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_batch</span><span class="p">)</span>
 
        <span class="c1">#we can&#39;t remove these while looping through err_locs as it messes up the list order and gives arrayindex exceptions</span>
        <span class="k">for</span> <span class="n">err_batch</span> <span class="ow">in</span> <span class="n">err_batches</span><span class="p">:</span>

            <span class="c1">#remove from batches_with_structures and batches_not_errors</span>
            <span class="n">batches_with_structures</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">err_batch</span><span class="p">)</span>
            <span class="n">batches_not_errors</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">err_batch</span><span class="p">)</span>

            <span class="c1">#flag this batch as erroring due to inability to generate anything for the standard_inchi_key field</span>
            <span class="n">batches_index</span> <span class="o">=</span> <span class="n">batches</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">err_batch</span><span class="p">)</span>
            <span class="n">batches</span><span class="p">[</span><span class="n">batches_index</span><span class="p">]</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;inchicreationerror&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
            <span class="n">batches</span><span class="p">[</span><span class="n">batches_index</span><span class="p">]</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ignore&quot;</span>


        <span class="n">inchiparts</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Structure:&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">inch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inchiparts</span><span class="p">):</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">inch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">ints</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]</span>
            <span class="n">part</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ints</span><span class="p">)</span>
            <span class="n">inchis</span><span class="p">[</span><span class="n">part</span><span class="p">]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fileerrors&quot;</span><span class="p">):</span>
            <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;fileerrors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">new_uploaded_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">already_found</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">batches_with_structures</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">error_locs</span><span class="p">):</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi</span> <span class="o">=</span> <span class="n">inchis</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">temp_props</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span> <span class="ow">in</span> <span class="n">already_found</span><span class="p">:</span>
                <span class="c1"># setting this in case we change it later</span>
                <span class="n">duplicates</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">already_found</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span><span class="p">)</span>

            <span class="n">new_uploaded_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">already_in_db</span> <span class="o">=</span> <span class="n">MoleculeDictionary</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                                                          <span class="s2">&quot;project&quot;</span><span class="p">],</span> <span class="n">structure_type</span><span class="o">=</span><span class="s2">&quot;MOL&quot;</span><span class="p">,</span> <span class="n">structure_key__in</span><span class="o">=</span><span class="n">already_found</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s2">&quot;structure_key&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">already_in_db</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">already_in_db</span><span class="p">)</span>

        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;new&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">new_data</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="n">duplicate_overlaps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="n">duplicate_new</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches_with_structures</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;duplicate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span> <span class="ow">in</span> <span class="n">already_in_db</span><span class="p">:</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;overlap&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
                    <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;duplicate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">duplicate_overlaps</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;new&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

                <span class="n">new_data</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
                    <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;duplicate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">duplicate_new</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches_with_structures</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nostructure&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;nostructure&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">blinded_data</span><span class="p">:</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;nostructure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;batchstats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;batchstats&quot;</span><span class="p">][</span><span class="s2">&quot;withstructure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">batches_with_structures</span><span class="p">)</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;batchstats&quot;</span><span class="p">][</span><span class="s2">&quot;parseerrors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">batches_not_errors</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span>
            <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batches_not_errors</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parseerror&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">])</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;batchstats&quot;</span><span class="p">][</span><span class="s2">&quot;withoutstructure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">blinded_data</span><span class="p">)</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;batchstats&quot;</span><span class="p">][</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;compoundstats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;compoundstats&quot;</span><span class="p">][</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">already_in_db</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;compoundstats&quot;</span><span class="p">][</span><span class="s2">&quot;overlaps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">already_in_db</span><span class="p">)</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;compoundstats&quot;</span><span class="p">][</span><span class="s2">&quot;new&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;compoundstats&quot;</span><span class="p">][</span>
            <span class="s2">&quot;duplicateoverlaps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">duplicate_overlaps</span><span class="p">)</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;compoundstats&quot;</span><span class="p">][</span><span class="s2">&quot;duplicatenew&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">duplicate_new</span><span class="p">)</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;multiplebatch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">multi_batch</span><span class="o">.</span><span class="n">pk</span>

        
        <span class="n">fifty_batches_for_first_page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_cached_temporary_batches</span><span class="p">(</span>
            <span class="n">batches</span><span class="p">,</span> <span class="n">multi_batch</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="n">multi_batch</span><span class="o">.</span><span class="n">uploaded_data</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span>
        <span class="n">multi_batch</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="c1">#bundle.data[&quot;objects&quot;] = fifty_batches_for_first_page</span>
        <span class="n">index_name</span> <span class="o">=</span> <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_temp_index_name</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span> <span class="n">multi_batch</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_action_totals</span><span class="p">(</span><span class="n">index_name</span><span class="p">,</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">http</span><span class="o">.</span><span class="n">HttpAccepted</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_part_processed_multiple_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the part processed data from elasticsearch and the stats about the</span>
<span class="sd">        multiple batch</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Uncached for now. Invalidation that works for everyone may be</span>
        <span class="c1">#       impossible.</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>

        <span class="c1"># self.authorized_create_detail(self.get_object_list(bundle.request), bundle)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;multi_batch&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)):</span>
            <span class="n">mb</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;multi_batch&quot;</span><span class="p">)</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;current_batch&quot;</span><span class="p">)</span>
            <span class="n">mb</span> <span class="o">=</span> <span class="n">CBHCompoundMultipleBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>

        <span class="n">to_be_serialized</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">uploaded_data</span>
        <span class="n">to_be_serialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cached_temporary_batch_data</span><span class="p">(</span>
            <span class="nb">id</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">bundledata</span><span class="o">=</span><span class="n">to_be_serialized</span><span class="p">)</span>
        <span class="n">index_name</span> <span class="o">=</span> <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_temp_index_name</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
        <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_action_totals</span><span class="p">(</span><span class="n">index_name</span><span class="p">,</span> <span class="n">to_be_serialized</span><span class="p">)</span>
        <span class="n">to_be_serialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_list_data_to_serialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">to_be_serialized</span><span class="p">,</span> <span class="n">permanent_data</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">to_be_serialized</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post_validate_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        When a list of SMILES patterns are submitted, save them to elasticsearhc and</span>
<span class="sd">        call the normal validate multi batch function to give the normal statistics page</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">))</span>

        <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_deserialized_detail_data</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">)</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">dict_strip_unicode_keys</span><span class="p">(</span><span class="n">deserialized</span><span class="p">),</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authorized_update_detail</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authorized_create_detail</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="n">smilesdata</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;smilesdata&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="p">[</span><span class="n">smi</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">smi</span> <span class="ow">in</span> <span class="n">smilesdata</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="bp">True</span><span class="p">)]</span>
        <span class="n">batches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># first assume smiles</span>
        <span class="n">allmols</span> <span class="o">=</span> <span class="p">[(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)))</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">]</span>
        <span class="c1"># Next test for inchi</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">allmols</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">inchimol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromInchi</span><span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">inchimol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">allmols</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">MolToSmiles</span><span class="p">(</span><span class="n">inchimol</span><span class="p">),</span> <span class="n">inchimol</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">allmols</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">Compute2DCoords</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">batches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">multiple_batch</span> <span class="o">=</span> <span class="n">CBHCompoundMultipleBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">mol2</span> <span class="ow">in</span> <span class="n">allmols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mol2</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">from_rd_mol</span><span class="p">(</span>
                    <span class="n">mol2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">smiles</span><span class="o">=</span><span class="n">mol2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">],</span> <span class="n">reDraw</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">blinded</span><span class="p">(</span>
                    <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
                <span class="n">b</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;smilesParseError&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
                <span class="n">b</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ignore&quot;</span>
                <span class="n">b</span><span class="o">.</span><span class="n">original_smiles</span> <span class="o">=</span> <span class="n">mol2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">b</span><span class="o">.</span><span class="n">multiple_batch_id</span> <span class="o">=</span> <span class="n">multiple_batch</span><span class="o">.</span><span class="n">pk</span>
            <span class="n">b</span><span class="o">.</span><span class="n">created_by</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span>
            <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;current_batch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">multiple_batch</span><span class="o">.</span><span class="n">pk</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_multi_batch</span><span class="p">(</span><span class="n">multiple_batch</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">batches</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post_validate_drawn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Turn a drawn molfile via chemdoodle into a processable </span>
<span class="sd">        rdkit mol to be used by the rest of the architecture</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">))</span>

        <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_deserialized_detail_data</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">)</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">dict_strip_unicode_keys</span><span class="p">(</span><span class="n">deserialized</span><span class="p">),</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authorized_update_detail</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authorized_create_detail</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="c1">#now get the SDfile from the request</span>
        <span class="n">ctab</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sketch&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="c1"># first assume ctab</span>
        <span class="c1"># allmols = [(obj, Chem.MolFromSmiles(str(obj))) for obj in objects]</span>
        <span class="c1"># we need to make allmols a single-entry list in order to use the rst of the architecture</span>

        <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromMolBlock</span><span class="p">(</span><span class="n">ctab</span><span class="p">)</span>
        <span class="c1">#for each of the supplied custom fields, use set prop to replicate how this would be if it was an sd file.</span>
        <span class="n">prj_data_fields</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;custom_fields&#39;</span><span class="p">,{})</span>
        <span class="n">sup_data_fields</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;supplementary_fields&#39;</span><span class="p">,[])</span>
        <span class="k">if</span><span class="p">(</span><span class="n">mol</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k1</span><span class="p">,</span> <span class="n">v1</span> <span class="ow">in</span> <span class="n">prj_data_fields</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                    <span class="n">v1str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">v1</span><span class="p">:</span>
                        <span class="n">v1str</span> <span class="o">=</span> <span class="n">v1str</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
                    <span class="n">mol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="n">k1</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">),</span> <span class="n">v1str</span><span class="p">)</span>
                <span class="c1">#not a unicode string? Don&#39;t try and ascii encode the result, </span>
                <span class="c1">#just add it as a value converted to a string (which SetProp expects)</span>
                <span class="k">elif</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">True</span><span class="p">):</span>
                    <span class="n">mol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="n">k1</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">v1</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="n">k1</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">),</span> <span class="n">v1</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">sup_data_fields</span><span class="p">:</span>
                <span class="n">mol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">),</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">))</span>
        
        <span class="n">allmols</span> <span class="o">=</span> <span class="p">[</span> <span class="n">mol</span> <span class="p">]</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">batches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">multiple_batch</span> <span class="o">=</span> <span class="n">CBHCompoundMultipleBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">from_rd_mol</span><span class="p">(</span>
                <span class="n">mol</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">],</span> <span class="n">orig_ctab</span><span class="o">=</span><span class="n">ctab</span><span class="p">)</span>
            <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">blinded</span><span class="p">(</span>
                            <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
            <span class="n">b</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;parseerror&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
            <span class="n">b</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ignore&quot;</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
        <span class="n">b</span><span class="o">.</span><span class="n">custom_fields</span> <span class="o">=</span> <span class="n">prj_data_fields</span>
        <span class="n">b</span><span class="o">.</span><span class="n">uncurated_fields</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1">#iterate the supplementary fields</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">sup_data_fields</span><span class="p">:</span>
            <span class="n">b</span><span class="o">.</span><span class="n">uncurated_fields</span><span class="p">[</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;current_batch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">multiple_batch</span><span class="o">.</span><span class="n">pk</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">errors</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_multi_batch</span><span class="p">(</span><span class="n">multiple_batch</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">batches</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">preprocess_sdf_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_obj</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the input SDF file and add some extra information to it&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">post_validate_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Receive a CBHFlowFile ID which points at an uploaded SDF, XLSX or CDX file</span>
<span class="sd">        Perform validation on the file&#39;s contents and then send the resultant elasticsearch index</span>
<span class="sd">        to the validate mult batch method</span>
<span class="sd">        More about data import information can be found in the wiki</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">automapped_structure</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">))</span>

        <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_deserialized_detail_data</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">)</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">dict_strip_unicode_keys</span><span class="p">(</span><span class="n">deserialized</span><span class="p">),</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authorized_create_detail</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span>
        <span class="n">session_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">COOKIES</span><span class="p">[</span><span class="n">settings</span><span class="o">.</span><span class="n">SESSION_COOKIE_NAME</span><span class="p">]</span>
        <span class="n">correct_file</span> <span class="o">=</span> <span class="n">CBHFlowFile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">identifier</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">session_key</span><span class="p">,</span> <span class="n">file_name</span><span class="p">))</span>
        <span class="n">batches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fielderrors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">fielderrors</span><span class="p">[</span><span class="s2">&quot;stringdate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="n">fielderrors</span><span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="n">fielderrors</span><span class="p">[</span><span class="s2">&quot;integer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="n">structure_col</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;struccol&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;.cdx&quot;</span> <span class="ow">in</span> <span class="n">correct_file</span><span class="o">.</span><span class="n">extension</span><span class="p">):</span>
            <span class="n">mols</span> <span class="o">=</span> <span class="p">[</span><span class="n">mol</span> <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">readfile</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">correct_file</span><span class="o">.</span><span class="n">extension</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">correct_file</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="p">)]</span>
            <span class="n">rxn</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">correct_file</span><span class="o">.</span><span class="n">extension</span> <span class="o">==</span> <span class="s1">&#39;.cdxml&#39;</span><span class="p">:</span>
                <span class="c1"># Look for a stoichiometry table in the reaction file</span>
                <span class="n">rxn</span> <span class="o">=</span> <span class="n">chemdraw_reaction</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">correct_file</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;%Completion&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;%Yield&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;Expected Moles&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;Product Moles&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;Expected Mass&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;Product Mass&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;MW&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;role&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;Purity&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;Limit Moles&quot;</span><span class="p">,</span>
                           <span class="c1"># &quot;Formula&quot;,</span>
                           <span class="s2">&quot;Equivalents&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;Measured Mass&quot;</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">pybelmol</span> <span class="ow">in</span> <span class="n">mols</span><span class="p">:</span>
                <span class="n">molfile</span> <span class="o">=</span> <span class="n">pybelmol</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;mdl&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">molfile</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="n">molfile</span> <span class="o">!=</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span>
                    <span class="n">rd_mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromMolBlock</span><span class="p">(</span><span class="n">molfile</span><span class="p">,</span> <span class="n">sanitize</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                    Pybel can read some hypervalent molecules that RDKit cannot read</span>
<span class="sd">                    Therefore currently these molecules are outputted as images and sent back to the front end</span>
<span class="sd">                    https://www.mail-archive.com/rdkit-discuss@lists.sourceforge.net/msg04466.html</span>
<span class="sd">                    &#39;&#39;&#39;</span>
                    <span class="k">if</span> <span class="n">rd_mol</span><span class="p">:</span>
                        <span class="n">smiles</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolToSmiles</span><span class="p">(</span><span class="n">rd_mol</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">smiles</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">from_rd_mol</span><span class="p">(</span>
                                    <span class="n">rd_mol</span><span class="p">,</span> <span class="n">orig_ctab</span><span class="o">=</span><span class="n">molfile</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="n">smiles</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                                <span class="n">b</span> <span class="o">=</span> <span class="bp">None</span>
                                <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">b</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">rxn</span><span class="p">:</span>
                                    <span class="c1"># Here we set the uncurated fields equal to</span>
                                    <span class="c1"># the reaction data extracted from Chemdraw</span>
                                    <span class="n">b</span><span class="o">.</span><span class="n">uncurated_fields</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                        <span class="n">pybelmol</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="p">{})</span>
                                <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">pybelmol</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                    <span class="s2">&quot;svg&quot;</span><span class="p">),</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Unable to produce inchi from this molecule&quot;</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">pybelmol</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                            <span class="s2">&quot;svg&quot;</span><span class="p">),</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid valency or other error parsing this molecule&quot;</span><span class="p">})</span>
                    <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">correct_file</span><span class="o">.</span><span class="n">extension</span> <span class="o">==</span> <span class="s2">&quot;.sdf&quot;</span><span class="p">):</span>
                <span class="c1"># read in the file</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_sdf_file</span><span class="p">(</span><span class="n">correct_file</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
                <span class="n">suppl</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">ForwardSDMolSupplier</span><span class="p">(</span><span class="n">correct_file</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
                <span class="n">mols</span> <span class="o">=</span> <span class="p">[</span><span class="n">mo</span> <span class="k">for</span> <span class="n">mo</span> <span class="ow">in</span> <span class="n">suppl</span><span class="p">]</span>
                <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;file_too_large&quot;</span><span class="p">)</span>
                <span class="c1"># read the headers from the first molecule</span>

                <span class="n">headers</span> <span class="o">=</span> <span class="n">get_all_sdf_headers</span><span class="p">(</span><span class="n">correct_file</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">uncurated</span><span class="p">,</span> <span class="n">ctabs</span> <span class="o">=</span> <span class="n">get_uncurated_fields_from_file</span><span class="p">(</span><span class="n">correct_file</span><span class="p">,</span> <span class="n">fielderrors</span><span class="p">)</span>
                
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">mol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mols</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">blinded</span><span class="p">(</span>
                            <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
                        <span class="n">b</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;parseerror&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
                        <span class="n">b</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ignore&quot;</span>

                        <span class="n">b</span><span class="o">.</span><span class="n">uncurated_fields</span> <span class="o">=</span> <span class="n">uncurated</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>  <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;No structure found&quot;</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">from_rd_mol</span><span class="p">(</span>
                                <span class="n">mol</span><span class="p">,</span> <span class="n">orig_ctab</span><span class="o">=</span><span class="n">ctabs</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">blinded</span><span class="p">(</span>
                            <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
                            <span class="n">b</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;parseerror&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
                            <span class="n">b</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ignore&quot;</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>  <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
                       
                        <span class="n">b</span><span class="o">.</span><span class="n">uncurated_fields</span> <span class="o">=</span> <span class="n">uncurated</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

                    <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

            <span class="k">elif</span><span class="p">(</span><span class="n">correct_file</span><span class="o">.</span><span class="n">extension</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;.xls&quot;</span><span class="p">,</span> <span class="s2">&quot;.xlsx&quot;</span><span class="p">)):</span>
                <span class="c1"># we need to know which column contains structural info - this needs to be defined on the mapping page and passed here</span>
                <span class="c1"># read in the specified structural column</span>

                <span class="n">headerswithdata</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>

                <span class="n">df</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">correct_file</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;no_headers&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;file_too_large&quot;</span><span class="p">)</span>
                <span class="c1"># read the smiles string value out of here, when we know which</span>
                <span class="c1"># column it is.</span>
                <span class="n">row_iterator</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;__&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">]</span>
                <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">headers</span>
                <span class="c1"># Only automap on the first attempt at mapping the smiles</span>
                    <span class="c1"># column</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">structure_col</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;headers&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
                    <span class="n">max_score</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
                        <span class="c1"># fuzzy matching for smiles - this should also</span>
                        <span class="c1"># match things like &quot;canonical_smiles&quot;</span>
                        <span class="n">hdr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[^0-9a-zA-Z]+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hdr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">):</span>
                            <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">h</span><span class="p">:</span>
                                <span class="n">score</span> <span class="o">=</span> <span class="n">fuzzymatch</span><span class="p">(</span>
                                    <span class="n">a</span><span class="o">=</span><span class="s2">&quot;smiles&quot;</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span>
                                <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">max_score</span> <span class="ow">and</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">:</span>
                                    <span class="n">structure_col</span> <span class="o">=</span> <span class="n">header</span>
                                    <span class="n">max_score</span> <span class="o">=</span> <span class="n">score</span>
                                    <span class="n">automapped_structure</span> <span class="o">=</span> <span class="bp">True</span>
                
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">row_iterator</span><span class="p">:</span>
                    
                    <span class="k">if</span> <span class="n">structure_col</span><span class="p">:</span>
                        <span class="n">smiles_str</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">structure_col</span><span class="p">]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">struc</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles_str</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">struc</span><span class="p">:</span>
                                <span class="n">Compute2DCoords</span><span class="p">(</span><span class="n">struc</span><span class="p">)</span>
                                <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">from_rd_mol</span><span class="p">(</span>
                                    <span class="n">struc</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="n">smiles_str</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">],</span> <span class="n">reDraw</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                                <span class="n">b</span><span class="o">.</span><span class="n">blinded_batch_id</span> <span class="o">=</span> <span class="bp">None</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Smiles not processed&quot;</span><span class="p">)</span>

                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">blinded</span><span class="p">(</span>
                                <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
                            <span class="n">b</span><span class="o">.</span><span class="n">original_smiles</span> <span class="o">=</span> <span class="n">smiles_str</span>
                            <span class="n">b</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;parseerror&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
                            <span class="n">b</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ignore&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">blinded</span><span class="p">(</span>
                            <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>

                    <span class="k">if</span> <span class="nb">dict</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">uncurated_fields</span><span class="p">)</span> <span class="o">==</span> <span class="p">{}:</span>
                            <span class="c1"># Only rebuild the uncurated fields if this has not</span>
                            <span class="c1"># been done before</span>
                        <span class="n">parse_pandas_record</span><span class="p">(</span>
                                <span class="n">headers</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="s2">&quot;uncurated_fields&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">fielderrors</span><span class="p">,</span> <span class="n">headerswithdata</span><span class="p">)</span>
                   
                    <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="n">hdr</span> <span class="k">for</span> <span class="n">hdr</span> <span class="ow">in</span> <span class="n">headers</span> <span class="k">if</span> <span class="n">hdr</span> <span class="ow">in</span> <span class="n">headerswithdata</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;file_format_error&quot;</span><span class="p">)</span>
        <span class="n">multiple_batch</span> <span class="o">=</span> <span class="n">CBHCompoundMultipleBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">],</span>
                <span class="n">uploaded_file</span><span class="o">=</span><span class="n">correct_file</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batches</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">b</span><span class="p">:</span>
                <span class="n">b</span><span class="o">.</span><span class="n">multiple_batch_id</span> <span class="o">=</span> <span class="n">multiple_batch</span><span class="o">.</span><span class="n">pk</span>
                <span class="n">b</span><span class="o">.</span><span class="n">created_by</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span>

        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;fileerrors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">errors</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;automapped&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cfr</span> <span class="o">=</span> <span class="n">ChemRegCustomFieldConfigResource</span><span class="p">()</span>
        <span class="n">jsondata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cfr</span><span class="o">.</span><span class="n">get_detail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
            <span class="n">pk</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">custom_field_config_id</span><span class="p">)</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="n">schemaform</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="p">[</span><span class="s2">&quot;edit_form&quot;</span><span class="p">][</span><span class="s2">&quot;form&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">jsondata</span><span class="p">[</span><span class="s2">&quot;project_data_fields&quot;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;headers&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
                <span class="n">copyto</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">automapped</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">operations</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">header</span> <span class="o">==</span> <span class="n">structure_col</span><span class="p">:</span>
                    <span class="n">copyto</span> <span class="o">=</span> <span class="s2">&quot;SMILES for chemical structures&quot;</span>
                    <span class="k">if</span> <span class="n">automapped_structure</span><span class="p">:</span>
                        <span class="n">automapped</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">form</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">schemaform</span><span class="p">)</span>
                    <span class="n">copyto</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">max_score</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">form_item</span> <span class="ow">in</span> <span class="n">form</span><span class="p">:</span>
                        <span class="n">score</span> <span class="o">=</span> <span class="n">fuzzymatch</span><span class="p">(</span>
                            <span class="n">a</span><span class="o">=</span><span class="n">form_item</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">b</span><span class="o">=</span><span class="n">header</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">max_score</span> <span class="ow">and</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">:</span>
                            <span class="n">matched_item</span> <span class="o">=</span> <span class="n">form_item</span>
                            <span class="n">copyto</span> <span class="o">=</span> <span class="n">matched_item</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span>
                            <span class="n">automapped</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="k">if</span><span class="p">(</span><span class="n">matched_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;field_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;uiselecttags&quot;</span><span class="p">):</span>
                                <span class="n">operations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="p">{</span><span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="s2">&quot;split&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/uncurated_fields/&quot;</span> <span class="o">+</span> <span class="n">header</span><span class="p">})</span>
                                <span class="n">operations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="p">{</span><span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="s2">&quot;move&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/custom_fields/&quot;</span> <span class="o">+</span> <span class="n">matched_item</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">],</span> <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;/uncurated_fields/&quot;</span> <span class="o">+</span> <span class="n">header</span><span class="p">})</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">operation</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="s2">&quot;move&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/custom_fields/&quot;</span> <span class="o">+</span> <span class="n">matched_item</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">],</span> <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;/uncurated_fields/&quot;</span> <span class="o">+</span> <span class="n">header</span><span class="p">}</span>
                                <span class="n">operations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">operation</span><span class="p">)</span>
                                <span class="k">if</span><span class="p">(</span><span class="n">matched_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;format&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;date&quot;</span><span class="p">):</span>
                                    <span class="n">operations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                        <span class="p">{</span><span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="s2">&quot;convertdate&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/custom_fields/&quot;</span> <span class="o">+</span> <span class="n">matched_item</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]})</span>
                            <span class="c1">#set the max score so less well matched content than this is ignored</span>
                            <span class="n">max_score</span> <span class="o">=</span> <span class="n">score</span>

                <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">header</span><span class="p">,</span>
                    <span class="s2">&quot;automapped&quot;</span><span class="p">:</span> <span class="n">automapped</span><span class="p">,</span>
                    <span class="s2">&quot;copyto&quot;</span><span class="p">:</span> <span class="n">copyto</span><span class="p">,</span>
                    <span class="s2">&quot;operations&quot;</span><span class="p">:</span> <span class="n">operations</span><span class="p">,</span>
                    <span class="s2">&quot;fieldErrors&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;stringdate&quot;</span><span class="p">:</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">fielderrors</span><span class="p">[</span><span class="s2">&quot;stringdate&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;integer&quot;</span><span class="p">:</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">fielderrors</span><span class="p">[</span><span class="s2">&quot;integer&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">fielderrors</span><span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">]</span>
                    <span class="p">}</span>
                <span class="p">})</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_multi_batch</span><span class="p">(</span><span class="n">multiple_batch</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">batches</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">create_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">HttpResponse</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts the common &quot;which-format/serialize/return-response&quot; cycle.</span>
<span class="sd">        Mostly a useful shortcut/hook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">desired_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_format</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">serialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">desired_format</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Meta</span><span class="o">.</span><span class="n">ordrered_ftk</span><span class="p">)</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">response_class</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">serialized</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="n">build_content_type</span><span class="p">(</span>
            <span class="n">desired_format</span><span class="p">),</span> <span class="o">**</span><span class="n">response_kwargs</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">desired_format</span> <span class="o">==</span> <span class="s1">&#39;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&#39;</span><span class="p">):</span>
            <span class="n">rc</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;attachment; filename=export_from_chembiohub_chemreg</span><span class="si">%d</span><span class="s1">.xlsx&#39;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">desired_format</span> <span class="o">==</span> <span class="s1">&#39;chemical/x-mdl-sdfile&#39;</span><span class="p">):</span>
            <span class="n">rc</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;attachment; filename=export_from_chembiohub_chemreg</span><span class="si">%d</span><span class="s1">.sdf&#39;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">rc</span>

    <span class="k">def</span> <span class="nf">dehydrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tidy up the data adding timestamp etc, now mostly deprecated&quot;&quot;&quot;</span>
        <span class="c1"># try:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">related_molregno</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">for</span> <span class="n">names</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Meta</span><span class="o">.</span><span class="n">fieldnames</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">blinded_batch_id</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">deepgetattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">except</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>
                    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;chemblId&quot;</span><span class="p">:</span>
                    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">blinded_batch_id</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">created_by</span><span class="p">:</span>
          <span class="c1">#user = User.objects.get(username=bundle.obj.created_by)</span>
            <span class="n">User</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">created_by</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ObjectDoesNotExist</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">first_name</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">created_by</span><span class="o">.</span><span class="n">split</span><span class="p">[</span><span class="s2">&quot; &quot;</span><span class="p">][</span>
                                            <span class="mi">0</span><span class="p">],</span> <span class="n">last_name</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">created_by</span><span class="o">.</span><span class="n">split</span><span class="p">[</span><span class="s2">&quot; &quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">user</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">mynames</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;uncurated_fields&quot;</span><span class="p">,</span> <span class="s2">&quot;warnings&quot;</span><span class="p">,</span> <span class="s2">&quot;properties&quot;</span><span class="p">,</span> <span class="s2">&quot;custom_fields&quot;</span><span class="p">,]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">mynames</span><span class="p">:</span>
            <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            
        <span class="c1">#bundle.data[&quot;created_by&quot;] = user.__dict__</span>
        <span class="k">if</span> <span class="n">user</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">first_name</span><span class="p">:</span>
                <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;created_by&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">user</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">last_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;created_by&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;created_by&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">created_by</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;created&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
        <span class="c1"># except:</span>
        <span class="c1">#    pass</span>
        <span class="k">return</span> <span class="n">bundle</span>

    <span class="k">def</span> <span class="nf">batches_to_es_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batches</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">non_chem_data_only</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert the data to be ready to submit to elasticsearch&quot;&quot;&quot;</span>
        <span class="n">batch_dicts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">es_serializer</span> <span class="o">=</span> <span class="n">CBHCompoundBatchElasticSearchSerializer</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">batch</span><span class="p">:</span>
                <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">batch</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
                    <span class="n">batch</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">index</span>
                <span class="n">bun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
                <span class="n">bun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_dehydrate</span><span class="p">(</span><span class="n">bun</span><span class="p">,</span> <span class="n">for_list</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">bun</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">bun</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                        <span class="s2">&quot;project&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;/</span><span class="si">%s</span><span class="s1">/cbh_projects/</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">WEBSERVICES_NAME</span><span class="p">,</span> <span class="n">bun</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">project_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">non_chem_data_only</span><span class="p">:</span>
                    <span class="n">ready</span> <span class="o">=</span> <span class="n">es_serializer</span><span class="o">.</span><span class="n">to_es_ready_non_chemical_data</span><span class="p">(</span>
                        <span class="n">bun</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;underscorize&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ready</span> <span class="o">=</span> <span class="n">es_serializer</span><span class="o">.</span><span class="n">to_es_ready_data</span><span class="p">(</span>
                        <span class="n">bun</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;underscorize&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>

                <span class="n">batch_dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ready</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># preserve the line number of the batch that could not be</span>
                <span class="c1"># processed</span>
                <span class="n">batch_dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span>
                     <span class="s2">&quot;warnings&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;parseerror&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
                                  <span class="p">},</span>
                     <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;Ignore&quot;</span><span class="p">},</span>
                     <span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">)</span>
                     <span class="p">}</span>
                <span class="p">)</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">batch_dicts</span>

    <span class="k">def</span> <span class="nf">set_cached_temporary_batches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batches</span><span class="p">,</span> <span class="n">multi_batch_id</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Index the new data when a new bulk upload is done&quot;&quot;&quot;</span>
        <span class="n">es_serializer</span> <span class="o">=</span> <span class="n">CBHCompoundBatchElasticSearchSerializer</span><span class="p">()</span>
        <span class="n">batch_dicts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches_to_es_ready</span><span class="p">(</span><span class="n">batches</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="n">index_name</span> <span class="o">=</span> <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_temp_index_name</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span> <span class="n">multi_batch_id</span><span class="p">)</span>
        <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">create_temporary_index</span><span class="p">(</span>
            <span class="n">batch_dicts</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">index_name</span><span class="p">)</span>
        <span class="c1"># Now get rid of my ES preparation again</span>

    <span class="k">def</span> <span class="nf">get_cached_temporary_batches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundles</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">bundledata</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;Request the imported data which has been cached in Elasticsearch&quot;&quot;&quot;</span>
        <span class="n">fakeobj</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="n">bundledata</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">],</span> <span class="nb">id</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">bun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">fakeobj</span><span class="p">)</span>
        <span class="n">bun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_dehydrate</span><span class="p">(</span><span class="n">bun</span><span class="p">)</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="n">bun</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">datum</span> <span class="ow">in</span> <span class="n">bundles</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]:</span>
        
            <span class="n">datum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">datum</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>

            <span class="n">datum</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proj</span>
            <span class="n">datum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_hydrate</span><span class="p">(</span><span class="n">datum</span><span class="p">)</span>
            <span class="c1">#Quick hack to fix saving of sutom fields when validating a sketch</span>
            <span class="k">if</span> <span class="n">bundledata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;sketch&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">bundles</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">datum</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;custom_fields&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bundledata</span><span class="p">[</span><span class="s2">&quot;custom_fields&quot;</span><span class="p">]</span>
                <span class="n">datum</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">custom_fields</span> <span class="o">=</span> <span class="n">bundledata</span><span class="p">[</span><span class="s2">&quot;custom_fields&quot;</span><span class="p">]</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datum</span><span class="p">)</span>
        <span class="n">bundles</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">return</span> <span class="n">bundles</span>

   
    <span class="k">def</span> <span class="nf">get_cached_temporary_batch_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multi_batch_id</span><span class="p">,</span> <span class="n">get_data</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">bundledata</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;make the batch data into models so it can be serialized properly&quot;&quot;&quot;</span>
        <span class="n">es_request</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">get_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;offset&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">get_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limit&quot;</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
            <span class="s2">&quot;filter&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">get_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;query&quot;</span><span class="p">,</span> <span class="s1">&#39;{ &quot;match_all&quot; : {}}&#39;</span><span class="p">)),</span>
            <span class="s2">&quot;sort&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">get_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sorts&quot;</span><span class="p">,</span> <span class="s1">&#39;[{&quot;id&quot;: {&quot;order&quot;: &quot;asc&quot;}}]&#39;</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_temp_index_name</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span> <span class="n">multi_batch_id</span><span class="p">)</span>
        <span class="n">es_serializer</span> <span class="o">=</span> <span class="n">CBHCompoundBatchElasticSearchSerializer</span><span class="p">()</span>
        <span class="n">bundledata</span> <span class="o">=</span> <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">es_request</span><span class="p">,</span> <span class="n">bundledata</span><span class="p">)</span>
        <span class="n">bundledata</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">es_serializer</span><span class="o">.</span><span class="n">to_python_ready_data</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">bundledata</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">bundledata</span>

    <span class="k">def</span> <span class="nf">get_object_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;where to add select related etc.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CBHCompoundUploadResource</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#cbh_chem_api.compounds.CBHCompoundUploadResource">CBHCompoundUploadResource</a></li>
          <li>tastypie.resources.ModelResource</li>
          <li>tastypie.resources.BaseModelResource</li>
          <li>tastypie.resources.Resource</li>
          <li>__builtin__.object</li>
          </ul>
          <h3>Class variables</h3>
            <div class="item">
            <p id="cbh_chem_api.compounds.CBHCompoundUploadResource.Meta" class="name">var <span class="ident">Meta</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="cbh_chem_api.compounds.CBHCompoundUploadResource.base_fields" class="name">var <span class="ident">base_fields</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="cbh_chem_api.compounds.CBHCompoundUploadResource.creator" class="name">var <span class="ident">creator</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="cbh_chem_api.compounds.CBHCompoundUploadResource.declared_fields" class="name">var <span class="ident">declared_fields</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="cbh_chem_api.compounds.CBHCompoundUploadResource.project" class="name">var <span class="ident">project</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
          <h3>Instance variables</h3>
            <div class="item">
            <p id="cbh_chem_api.compounds.CBHCompoundUploadResource.urls" class="name">var <span class="ident">urls</span></p>
            

            
  
    <div class="desc"><p>The endpoints this <code>Resource</code> responds to.</p>
<p>Mostly a standard URLconf, this is suitable for either automatic use
when registered with an <code>Api</code> class or for including directly in
a URLconf should you choose to.</p></div>
  <div class="source_cont">
</div>

            </div>
          <h3>Methods</h3>
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.__init__">
    <p>def <span class="ident">__init__</span>(</p><p>self, api_name=None)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.__init__', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.__init__" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="c1"># this can cause:</span>
    <span class="c1"># TypeError: object.__new__(method-wrapper) is not safe, use method-wrapper.__new__()</span>
    <span class="c1"># when trying to copy a generator used as a default. Wrap call to</span>
    <span class="c1"># generator in lambda to get around this error.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_fields</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">api_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">api_name</span> <span class="o">=</span> <span class="n">api_name</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.after_save_and_index_hook">
    <p>def <span class="ident">after_save_and_index_hook</span>(</p><p>self, request, multi_batch_id, project_key)</p>
    </div>
    

    
  
    <div class="desc"><p>Hook used to perform operations on data that has been saved</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.after_save_and_index_hook', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.after_save_and_index_hook" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">after_save_and_index_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">multi_batch_id</span><span class="p">,</span> <span class="n">project_key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Hook used to perform operations on data that has been saved&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.alter_batch_data_after_save">
    <p>def <span class="ident">alter_batch_data_after_save</span>(</p><p>self, batch_list, python_file_object, request, multi_batch)</p>
    </div>
    

    
  
    <div class="desc"><p>Actually edit the data just after it has been saved</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.alter_batch_data_after_save', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.alter_batch_data_after_save" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">alter_batch_data_after_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_list</span><span class="p">,</span> <span class="n">python_file_object</span><span class="p">,</span><span class="n">request</span><span class="p">,</span> <span class="n">multi_batch</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Actually edit the data just after it has been saved&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.alter_deserialized_detail_data">
    <p>def <span class="ident">alter_deserialized_detail_data</span>(</p><p>self, request, deserialized)</p>
    </div>
    

    
  
    <div class="desc"><p>A project may be necessary for create statements</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.alter_deserialized_detail_data', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.alter_deserialized_detail_data" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">alter_deserialized_detail_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;A project may be necessary for create statements&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">deserialized</span><span class="p">[</span><span class="s2">&quot;project_key&quot;</span><span class="p">]:</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="n">Project</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">project_key</span><span class="o">=</span><span class="n">deserialized</span><span class="p">[</span><span class="s2">&quot;project_key&quot;</span><span class="p">])</span>
        <span class="n">deserialized</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proj</span>
    <span class="k">return</span> <span class="n">deserialized</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.alter_deserialized_list_data">
    <p>def <span class="ident">alter_deserialized_list_data</span>(</p><p>self, request, deserialized)</p>
    </div>
    

    
  
    <div class="desc"><p>Weird way we added project to input data, not reccomended, now deprecated apart from for upload</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.alter_deserialized_list_data', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.alter_deserialized_list_data" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">alter_deserialized_list_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Weird way we added project to input data, not reccomended, now deprecated apart from for upload&quot;&quot;&quot;</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">Project</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">project_key</span><span class="o">=</span><span class="n">deserialized</span><span class="p">[</span><span class="s2">&quot;project_key&quot;</span><span class="p">])</span>
    <span class="n">deserialized</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proj</span>
    <span class="k">return</span> <span class="n">deserialized</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.alter_detail_data_to_serialize">
    <p>def <span class="ident">alter_detail_data_to_serialize</span>(</p><p>self, request, data)</p>
    </div>
    

    
  
    <div class="desc"><p>A hook to alter detail data just before it gets serialized &amp; sent to the user.</p>
<p>Useful for restructuring/renaming aspects of the what's going to be
sent.</p>
<p>Should accommodate for receiving a single bundle of data.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.alter_detail_data_to_serialize', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.alter_detail_data_to_serialize" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">alter_detail_data_to_serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A hook to alter detail data just before it gets serialized &amp; sent to the user.</span>
<span class="sd">    Useful for restructuring/renaming aspects of the what&#39;s going to be</span>
<span class="sd">    sent.</span>
<span class="sd">    Should accommodate for receiving a single bundle of data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">data</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.alter_list_data_to_serialize">
    <p>def <span class="ident">alter_list_data_to_serialize</span>(</p><p>self, request, data)</p>
    </div>
    

    
  
    <div class="desc"><p>A hook to alter list data just before it gets serialized &amp; sent to the user.</p>
<p>Useful for restructuring/renaming aspects of the what's going to be
sent.</p>
<p>Should accommodate for a list of objects, generally also including
meta data.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.alter_list_data_to_serialize', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.alter_list_data_to_serialize" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">alter_list_data_to_serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A hook to alter list data just before it gets serialized &amp; sent to the user.</span>
<span class="sd">    Useful for restructuring/renaming aspects of the what&#39;s going to be</span>
<span class="sd">    sent.</span>
<span class="sd">    Should accommodate for a list of objects, generally also including</span>
<span class="sd">    meta data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">data</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.api_field_from_django_field">
    <p>def <span class="ident">api_field_from_django_field</span>(</p><p>cls, f, default=&lt;class &#39;tastypie.fields.CharField&#39;&gt;)</p>
    </div>
    

    
  
    <div class="desc"><p>Returns the field type that would likely be associated with each
Django type.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.api_field_from_django_field', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.api_field_from_django_field" class="source">
    <div class="codehilite"><pre><span></span><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">api_field_from_django_field</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">fields</span><span class="o">.</span><span class="n">CharField</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the field type that would likely be associated with each</span>
<span class="sd">    Django type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">default</span>
    <span class="n">internal_type</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_internal_type</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">internal_type</span> <span class="o">==</span> <span class="s1">&#39;DateField&#39;</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">DateField</span>
    <span class="k">elif</span> <span class="n">internal_type</span> <span class="o">==</span> <span class="s1">&#39;DateTimeField&#39;</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">DateTimeField</span>
    <span class="k">elif</span> <span class="n">internal_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;BooleanField&#39;</span><span class="p">,</span> <span class="s1">&#39;NullBooleanField&#39;</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">BooleanField</span>
    <span class="k">elif</span> <span class="n">internal_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;FloatField&#39;</span><span class="p">,):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">FloatField</span>
    <span class="k">elif</span> <span class="n">internal_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;DecimalField&#39;</span><span class="p">,):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">DecimalField</span>
    <span class="k">elif</span> <span class="n">internal_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;IntegerField&#39;</span><span class="p">,</span> <span class="s1">&#39;PositiveIntegerField&#39;</span><span class="p">,</span> <span class="s1">&#39;PositiveSmallIntegerField&#39;</span><span class="p">,</span> <span class="s1">&#39;SmallIntegerField&#39;</span><span class="p">,</span> <span class="s1">&#39;AutoField&#39;</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">IntegerField</span>
    <span class="k">elif</span> <span class="n">internal_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;FileField&#39;</span><span class="p">,</span> <span class="s1">&#39;ImageField&#39;</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">FileField</span>
    <span class="k">elif</span> <span class="n">internal_type</span> <span class="o">==</span> <span class="s1">&#39;TimeField&#39;</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">TimeField</span>
    <span class="c1"># TODO: Perhaps enable these via introspection. The reason they&#39;re not enabled</span>
    <span class="c1">#       by default is the very different ``__init__`` they have over</span>
    <span class="c1">#       the other fields.</span>
    <span class="c1"># elif internal_type == &#39;ForeignKey&#39;:</span>
    <span class="c1">#     result = ForeignKey</span>
    <span class="c1"># elif internal_type == &#39;ManyToManyField&#39;:</span>
    <span class="c1">#     result = ManyToManyField</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.apply_authorization_limits">
    <p>def <span class="ident">apply_authorization_limits</span>(</p><p>self, request, object_list)</p>
    </div>
    

    
  
    <div class="desc"><p>Deprecated.</p>
<p>FIXME: REMOVE BEFORE 1.0</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.apply_authorization_limits', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.apply_authorization_limits" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">apply_authorization_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">object_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deprecated.</span>
<span class="sd">    FIXME: REMOVE BEFORE 1.0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">authorization</span><span class="o">.</span><span class="n">apply_limits</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">object_list</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.apply_filters">
    <p>def <span class="ident">apply_filters</span>(</p><p>self, request, applicable_filters)</p>
    </div>
    

    
  
    <div class="desc"><p>An ORM-specific implementation of <code>apply_filters</code>.</p>
<p>The default simply applies the <code>applicable_filters</code> as <code>**kwargs</code>,
but should make it possible to do more advanced things.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.apply_filters', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.apply_filters" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">apply_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">applicable_filters</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An ORM-specific implementation of ``apply_filters``.</span>
<span class="sd">    The default simply applies the ``applicable_filters`` as ``**kwargs``,</span>
<span class="sd">    but should make it possible to do more advanced things.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="n">applicable_filters</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.apply_sorting">
    <p>def <span class="ident">apply_sorting</span>(</p><p>self, obj_list, options=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Given a dictionary of options, apply some ORM-level sorting to the
provided <code>QuerySet</code>.</p>
<p>Looks for the <code>order_by</code> key and handles either ascending (just the
field name) or descending (the field name with a <code>-</code> in front).</p>
<p>The field name should be the resource field, <strong>NOT</strong> model field.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.apply_sorting', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.apply_sorting" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">apply_sorting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_list</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a dictionary of options, apply some ORM-level sorting to the</span>
<span class="sd">    provided ``QuerySet``.</span>
<span class="sd">    Looks for the ``order_by`` key and handles either ascending (just the</span>
<span class="sd">    field name) or descending (the field name with a ``-`` in front).</span>
<span class="sd">    The field name should be the resource field, **NOT** model field.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">parameter_name</span> <span class="o">=</span> <span class="s1">&#39;order_by&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;order_by&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;sort_by&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
            <span class="c1"># Nothing to alter the order. Return what we&#39;ve got.</span>
            <span class="k">return</span> <span class="n">obj_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;&#39;sort_by&#39; is a deprecated parameter. Please use &#39;order_by&#39; instead.&quot;</span><span class="p">)</span>
            <span class="n">parameter_name</span> <span class="o">=</span> <span class="s1">&#39;sort_by&#39;</span>
    <span class="n">order_by_args</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="s1">&#39;getlist&#39;</span><span class="p">):</span>
        <span class="n">order_bits</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">parameter_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">order_bits</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parameter_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">order_bits</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">order_bits</span> <span class="o">=</span> <span class="p">[</span><span class="n">order_bits</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">order_by</span> <span class="ow">in</span> <span class="n">order_bits</span><span class="p">:</span>
        <span class="n">order_by_bits</span> <span class="o">=</span> <span class="n">order_by</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">LOOKUP_SEP</span><span class="p">)</span>
        <span class="n">field_name</span> <span class="o">=</span> <span class="n">order_by_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">order_by_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">):</span>
            <span class="n">field_name</span> <span class="o">=</span> <span class="n">order_by_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
        <span class="k">if</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="c1"># It&#39;s not a field we know about. Move along citizen.</span>
            <span class="k">raise</span> <span class="n">InvalidSortError</span><span class="p">(</span><span class="s2">&quot;No matching &#39;</span><span class="si">%s</span><span class="s2">&#39; field for ordering on.&quot;</span> <span class="o">%</span> <span class="n">field_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">ordering</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidSortError</span><span class="p">(</span><span class="s2">&quot;The &#39;</span><span class="si">%s</span><span class="s2">&#39; field does not allow ordering.&quot;</span> <span class="o">%</span> <span class="n">field_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">attribute</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidSortError</span><span class="p">(</span><span class="s2">&quot;The &#39;</span><span class="si">%s</span><span class="s2">&#39; field has no &#39;attribute&#39; for ordering with.&quot;</span> <span class="o">%</span> <span class="n">field_name</span><span class="p">)</span>
        <span class="n">order_by_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">LOOKUP_SEP</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">attribute</span><span class="p">]</span> <span class="o">+</span> <span class="n">order_by_bits</span><span class="p">[</span><span class="mi">1</span><span class="p">:])))</span>
    <span class="k">return</span> <span class="n">obj_list</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="o">*</span><span class="n">order_by_args</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_create_detail">
    <p>def <span class="ident">authorized_create_detail</span>(</p><p>self, object_list, bundle)</p>
    </div>
    

    
  
    <div class="desc"><p>Handles checking of permissions to see if the user has authorization
to POST this resource.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_create_detail', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_create_detail" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">authorized_create_detail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_list</span><span class="p">,</span> <span class="n">bundle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles checking of permissions to see if the user has authorization</span>
<span class="sd">    to POST this resource.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">auth_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">authorization</span><span class="o">.</span><span class="n">create_detail</span><span class="p">(</span><span class="n">object_list</span><span class="p">,</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">auth_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Unauthorized</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">Unauthorized</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unauthorized_result</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">auth_result</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_create_list">
    <p>def <span class="ident">authorized_create_list</span>(</p><p>self, object_list, bundle)</p>
    </div>
    

    
  
    <div class="desc"><p>Handles checking of permissions to see if the user has authorization
to POST this resource.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_create_list', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_create_list" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">authorized_create_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_list</span><span class="p">,</span> <span class="n">bundle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles checking of permissions to see if the user has authorization</span>
<span class="sd">    to POST this resource.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">auth_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">authorization</span><span class="o">.</span><span class="n">create_list</span><span class="p">(</span><span class="n">object_list</span><span class="p">,</span> <span class="n">bundle</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Unauthorized</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unauthorized_result</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">auth_result</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_delete_detail">
    <p>def <span class="ident">authorized_delete_detail</span>(</p><p>self, object_list, bundle)</p>
    </div>
    

    
  
    <div class="desc"><p>Handles checking of permissions to see if the user has authorization
to DELETE this resource.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_delete_detail', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_delete_detail" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">authorized_delete_detail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_list</span><span class="p">,</span> <span class="n">bundle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles checking of permissions to see if the user has authorization</span>
<span class="sd">    to DELETE this resource.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">auth_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">authorization</span><span class="o">.</span><span class="n">delete_detail</span><span class="p">(</span><span class="n">object_list</span><span class="p">,</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">auth_result</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Unauthorized</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">Unauthorized</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unauthorized_result</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">auth_result</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_delete_list">
    <p>def <span class="ident">authorized_delete_list</span>(</p><p>self, object_list, bundle)</p>
    </div>
    

    
  
    <div class="desc"><p>Handles checking of permissions to see if the user has authorization
to DELETE this resource.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_delete_list', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_delete_list" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">authorized_delete_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_list</span><span class="p">,</span> <span class="n">bundle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles checking of permissions to see if the user has authorization</span>
<span class="sd">    to DELETE this resource.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">auth_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">authorization</span><span class="o">.</span><span class="n">delete_list</span><span class="p">(</span><span class="n">object_list</span><span class="p">,</span> <span class="n">bundle</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Unauthorized</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unauthorized_result</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">auth_result</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_read_detail">
    <p>def <span class="ident">authorized_read_detail</span>(</p><p>self, object_list, bundle)</p>
    </div>
    

    
  
    <div class="desc"><p>Handles checking of permissions to see if the user has authorization
to GET this resource.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_read_detail', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_read_detail" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">authorized_read_detail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_list</span><span class="p">,</span> <span class="n">bundle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles checking of permissions to see if the user has authorization</span>
<span class="sd">    to GET this resource.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">auth_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">authorization</span><span class="o">.</span><span class="n">read_detail</span><span class="p">(</span><span class="n">object_list</span><span class="p">,</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">auth_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Unauthorized</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">Unauthorized</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unauthorized_result</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">auth_result</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_read_list">
    <p>def <span class="ident">authorized_read_list</span>(</p><p>self, object_list, bundle)</p>
    </div>
    

    
  
    <div class="desc"><p>Handles checking of permissions to see if the user has authorization
to GET this resource.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_read_list', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_read_list" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">authorized_read_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_list</span><span class="p">,</span> <span class="n">bundle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles checking of permissions to see if the user has authorization</span>
<span class="sd">    to GET this resource.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">auth_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">authorization</span><span class="o">.</span><span class="n">read_list</span><span class="p">(</span><span class="n">object_list</span><span class="p">,</span> <span class="n">bundle</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Unauthorized</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unauthorized_result</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">auth_result</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_update_detail">
    <p>def <span class="ident">authorized_update_detail</span>(</p><p>self, object_list, bundle)</p>
    </div>
    

    
  
    <div class="desc"><p>Handles checking of permissions to see if the user has authorization
to PUT this resource.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_update_detail', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_update_detail" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">authorized_update_detail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_list</span><span class="p">,</span> <span class="n">bundle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles checking of permissions to see if the user has authorization</span>
<span class="sd">    to PUT this resource.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">auth_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">authorization</span><span class="o">.</span><span class="n">update_detail</span><span class="p">(</span><span class="n">object_list</span><span class="p">,</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">auth_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Unauthorized</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">Unauthorized</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unauthorized_result</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">auth_result</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_update_list">
    <p>def <span class="ident">authorized_update_list</span>(</p><p>self, object_list, bundle)</p>
    </div>
    

    
  
    <div class="desc"><p>Handles checking of permissions to see if the user has authorization
to PUT this resource.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_update_list', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.authorized_update_list" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">authorized_update_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_list</span><span class="p">,</span> <span class="n">bundle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles checking of permissions to see if the user has authorization</span>
<span class="sd">    to PUT this resource.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">auth_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">authorization</span><span class="o">.</span><span class="n">update_list</span><span class="p">(</span><span class="n">object_list</span><span class="p">,</span> <span class="n">bundle</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Unauthorized</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unauthorized_result</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">auth_result</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.base_urls">
    <p>def <span class="ident">base_urls</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>The standard URLs this <code>Resource</code> should respond to.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.base_urls', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.base_urls" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">base_urls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The standard URLs this ``Resource`` should respond to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">url</span><span class="p">(</span><span class="s2">r&quot;^(?P&lt;resource_name&gt;</span><span class="si">%s</span><span class="s2">)</span><span class="si">%s</span><span class="s2">$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span> <span class="n">trailing_slash</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_view</span><span class="p">(</span><span class="s1">&#39;dispatch_list&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;api_dispatch_list&quot;</span><span class="p">),</span>
        <span class="n">url</span><span class="p">(</span><span class="s2">r&quot;^(?P&lt;resource_name&gt;</span><span class="si">%s</span><span class="s2">)/schema</span><span class="si">%s</span><span class="s2">$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span> <span class="n">trailing_slash</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_view</span><span class="p">(</span><span class="s1">&#39;get_schema&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;api_get_schema&quot;</span><span class="p">),</span>
        <span class="n">url</span><span class="p">(</span><span class="s2">r&quot;^(?P&lt;resource_name&gt;</span><span class="si">%s</span><span class="s2">)/set/(?P&lt;</span><span class="si">%s</span><span class="s2">_list&gt;.*?)</span><span class="si">%s</span><span class="s2">$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">detail_uri_name</span><span class="p">,</span> <span class="n">trailing_slash</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_view</span><span class="p">(</span><span class="s1">&#39;get_multiple&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;api_get_multiple&quot;</span><span class="p">),</span>
        <span class="n">url</span><span class="p">(</span><span class="s2">r&quot;^(?P&lt;resource_name&gt;</span><span class="si">%s</span><span class="s2">)/(?P&lt;</span><span class="si">%s</span><span class="s2">&gt;.*?)</span><span class="si">%s</span><span class="s2">$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">detail_uri_name</span><span class="p">,</span> <span class="n">trailing_slash</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_view</span><span class="p">(</span><span class="s1">&#39;dispatch_detail&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;api_dispatch_detail&quot;</span><span class="p">),</span>
    <span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.batches_to_es_ready">
    <p>def <span class="ident">batches_to_es_ready</span>(</p><p>self, batches, request, non_chem_data_only=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Convert the data to be ready to submit to elasticsearch</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.batches_to_es_ready', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.batches_to_es_ready" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">batches_to_es_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batches</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">non_chem_data_only</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert the data to be ready to submit to elasticsearch&quot;&quot;&quot;</span>
    <span class="n">batch_dicts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">es_serializer</span> <span class="o">=</span> <span class="n">CBHCompoundBatchElasticSearchSerializer</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">batch</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">batch</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">index</span>
            <span class="n">bun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
            <span class="n">bun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_dehydrate</span><span class="p">(</span><span class="n">bun</span><span class="p">,</span> <span class="n">for_list</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bun</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">bun</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                    <span class="s2">&quot;project&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;/</span><span class="si">%s</span><span class="s1">/cbh_projects/</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">WEBSERVICES_NAME</span><span class="p">,</span> <span class="n">bun</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">project_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">non_chem_data_only</span><span class="p">:</span>
                <span class="n">ready</span> <span class="o">=</span> <span class="n">es_serializer</span><span class="o">.</span><span class="n">to_es_ready_non_chemical_data</span><span class="p">(</span>
                    <span class="n">bun</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;underscorize&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ready</span> <span class="o">=</span> <span class="n">es_serializer</span><span class="o">.</span><span class="n">to_es_ready_data</span><span class="p">(</span>
                    <span class="n">bun</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;underscorize&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>
            <span class="n">batch_dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ready</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># preserve the line number of the batch that could not be</span>
            <span class="c1"># processed</span>
            <span class="n">batch_dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span>
                 <span class="s2">&quot;warnings&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;parseerror&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
                              <span class="p">},</span>
                 <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;Ignore&quot;</span><span class="p">},</span>
                 <span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">)</span>
                 <span class="p">}</span>
            <span class="p">)</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">batch_dicts</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.build_bundle">
    <p>def <span class="ident">build_bundle</span>(</p><p>self, obj=None, data=None, request=None, objects_saved=None, via_uri=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Given either an object, a data dictionary or both, builds a <code>Bundle</code>
for use throughout the <code>dehydrate/hydrate</code> cycle.</p>
<p>If no object is provided, an empty object from
<code>Resource._meta.object_class</code> is created so that attempts to access
<code>bundle.obj</code> do not fail.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.build_bundle', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.build_bundle" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">build_bundle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">objects_saved</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">via_uri</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given either an object, a data dictionary or both, builds a ``Bundle``</span>
<span class="sd">    for use throughout the ``dehydrate/hydrate`` cycle.</span>
<span class="sd">    If no object is provided, an empty object from</span>
<span class="sd">    ``Resource._meta.object_class`` is created so that attempts to access</span>
<span class="sd">    ``bundle.obj`` do not fail.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_class</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_class</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">Bundle</span><span class="p">(</span>
        <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
        <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span>
        <span class="n">objects_saved</span><span class="o">=</span><span class="n">objects_saved</span><span class="p">,</span>
        <span class="n">via_uri</span><span class="o">=</span><span class="n">via_uri</span>
    <span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.build_filters">
    <p>def <span class="ident">build_filters</span>(</p><p>self, filters=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Given a dictionary of filters, create the necessary ORM-level filters.</p>
<p>Keys should be resource fields, <strong>NOT</strong> model fields.</p>
<p>Valid values are either a list of Django filter types (i.e.
<code>['startswith', 'exact', 'lte']</code>), the <code>ALL</code> constant or the
<code>ALL_WITH_RELATIONS</code> constant.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.build_filters', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.build_filters" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">build_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a dictionary of filters, create the necessary ORM-level filters.</span>
<span class="sd">    Keys should be resource fields, **NOT** model fields.</span>
<span class="sd">    Valid values are either a list of Django filter types (i.e.</span>
<span class="sd">    ``[&#39;startswith&#39;, &#39;exact&#39;, &#39;lte&#39;]``), the ``ALL`` constant or the</span>
<span class="sd">    ``ALL_WITH_RELATIONS`` constant.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># At the declarative level:</span>
    <span class="c1">#     filtering = {</span>
    <span class="c1">#         &#39;resource_field_name&#39;: [&#39;exact&#39;, &#39;startswith&#39;, &#39;endswith&#39;, &#39;contains&#39;],</span>
    <span class="c1">#         &#39;resource_field_name_2&#39;: [&#39;exact&#39;, &#39;gt&#39;, &#39;gte&#39;, &#39;lt&#39;, &#39;lte&#39;, &#39;range&#39;],</span>
    <span class="c1">#         &#39;resource_field_name_3&#39;: ALL,</span>
    <span class="c1">#         &#39;resource_field_name_4&#39;: ALL_WITH_RELATIONS,</span>
    <span class="c1">#         ...</span>
    <span class="c1">#     }</span>
    <span class="c1"># Accepts the filters as a dict. None by default, meaning no filters.</span>
    <span class="k">if</span> <span class="n">filters</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">qs_filters</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">,</span> <span class="s1">&#39;queryset&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c1"># Get the possible query terms from the current QuerySet.</span>
        <span class="n">query_terms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">queryset</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">query_terms</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">query_terms</span> <span class="o">=</span> <span class="n">QUERY_TERMS</span>
    <span class="k">if</span> <span class="n">django</span><span class="o">.</span><span class="n">VERSION</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="ow">and</span> <span class="n">GeometryField</span><span class="p">:</span>
        <span class="n">query_terms</span> <span class="o">=</span> <span class="n">query_terms</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">GeometryField</span><span class="o">.</span><span class="n">class_lookups</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">filter_expr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">filters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">filter_bits</span> <span class="o">=</span> <span class="n">filter_expr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">LOOKUP_SEP</span><span class="p">)</span>
        <span class="n">field_name</span> <span class="o">=</span> <span class="n">filter_bits</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">filter_type</span> <span class="o">=</span> <span class="s1">&#39;exact&#39;</span>
        <span class="k">if</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="c1"># It&#39;s not a field we know about. Move along citizen.</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filter_bits</span><span class="p">)</span> <span class="ow">and</span> <span class="n">filter_bits</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">query_terms</span><span class="p">:</span>
            <span class="n">filter_type</span> <span class="o">=</span> <span class="n">filter_bits</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">lookup_bits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_filtering</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">filter_type</span><span class="p">,</span> <span class="n">filter_bits</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_value_to_python</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">filter_expr</span><span class="p">,</span> <span class="n">filter_type</span><span class="p">)</span>
        <span class="n">db_field_name</span> <span class="o">=</span> <span class="n">LOOKUP_SEP</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lookup_bits</span><span class="p">)</span>
        <span class="n">qs_filter</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db_field_name</span><span class="p">,</span> <span class="n">LOOKUP_SEP</span><span class="p">,</span> <span class="n">filter_type</span><span class="p">)</span>
        <span class="n">qs_filters</span><span class="p">[</span><span class="n">qs_filter</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">dict_strip_unicode_keys</span><span class="p">(</span><span class="n">qs_filters</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.build_schema">
    <p>def <span class="ident">build_schema</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Returns a dictionary of all the fields on the resource and some
properties about those fields.</p>
<p>Used by the <code>schema/</code> endpoint to describe what will be available.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.build_schema', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.build_schema" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">build_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a dictionary of all the fields on the resource and some</span>
<span class="sd">    properties about those fields.</span>
<span class="sd">    Used by the ``schema/`` endpoint to describe what will be available.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;fields&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;default_format&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">default_format</span><span class="p">,</span>
        <span class="s1">&#39;allowed_list_http_methods&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">list_allowed_methods</span><span class="p">,</span>
        <span class="s1">&#39;allowed_detail_http_methods&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">detail_allowed_methods</span><span class="p">,</span>
        <span class="s1">&#39;default_limit&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">limit</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">ordering</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ordering&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">ordering</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">filtering</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;filtering&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">filtering</span>
    <span class="c1"># Skip assigning pk_field_name for non-model resources</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pk_field_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">queryset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">pk</span><span class="o">.</span><span class="n">name</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">pk_field_name</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_object</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="n">field_object</span><span class="o">.</span><span class="n">default</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">field_object</span><span class="o">.</span><span class="n">dehydrated_type</span><span class="p">,</span>
            <span class="s1">&#39;nullable&#39;</span><span class="p">:</span> <span class="n">field_object</span><span class="o">.</span><span class="n">null</span><span class="p">,</span>
            <span class="s1">&#39;blank&#39;</span><span class="p">:</span> <span class="n">field_object</span><span class="o">.</span><span class="n">blank</span><span class="p">,</span>
            <span class="s1">&#39;readonly&#39;</span><span class="p">:</span> <span class="n">field_object</span><span class="o">.</span><span class="n">readonly</span><span class="p">,</span>
            <span class="s1">&#39;help_text&#39;</span><span class="p">:</span> <span class="n">field_object</span><span class="o">.</span><span class="n">help_text</span><span class="p">,</span>
            <span class="s1">&#39;unique&#39;</span><span class="p">:</span> <span class="n">field_object</span><span class="o">.</span><span class="n">unique</span><span class="p">,</span>
            <span class="s1">&#39;primary_key&#39;</span><span class="p">:</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">field_name</span> <span class="o">==</span> <span class="n">pk_field_name</span> <span class="k">else</span> <span class="bp">False</span><span class="p">,</span>
            <span class="s1">&#39;verbose_name&#39;</span><span class="p">:</span> <span class="n">field_object</span><span class="o">.</span><span class="n">verbose_name</span> <span class="ow">or</span> <span class="n">field_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">field_object</span><span class="o">.</span><span class="n">dehydrated_type</span> <span class="o">==</span> <span class="s1">&#39;related&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field_object</span><span class="o">.</span><span class="n">is_m2m</span><span class="p">:</span>
                <span class="n">related_type</span> <span class="o">=</span> <span class="s1">&#39;to_many&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">related_type</span> <span class="o">=</span> <span class="s1">&#39;to_one&#39;</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">][</span><span class="s1">&#39;related_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">related_type</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;api_get_schema&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;api_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">api_name</span><span class="p">,</span> <span class="s1">&#39;resource_name&#39;</span><span class="p">:</span> <span class="n">field_object</span><span class="o">.</span><span class="n">to_class</span><span class="p">()</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">})</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">][</span><span class="s1">&#39;related_schema&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uri</span>
    <span class="k">return</span> <span class="n">data</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.cached_obj_get">
    <p>def <span class="ident">cached_obj_get</span>(</p><p>self, bundle, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>A version of <code>obj_get</code> that uses the cache as a means to get
commonly-accessed data faster.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.cached_obj_get', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.cached_obj_get" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">cached_obj_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A version of ``obj_get`` that uses the cache as a means to get</span>
<span class="sd">    commonly-accessed data faster.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cache_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_cache_key</span><span class="p">(</span><span class="s1">&#39;detail&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">cached_bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cached_bundle</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">cached_bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_get</span><span class="p">(</span><span class="n">bundle</span><span class="o">=</span><span class="n">bundle</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">cached_bundle</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cached_bundle</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.cached_obj_get_list">
    <p>def <span class="ident">cached_obj_get_list</span>(</p><p>self, bundle, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>A version of <code>obj_get_list</code> that uses the cache as a means to get
commonly-accessed data faster.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.cached_obj_get_list', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.cached_obj_get_list" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">cached_obj_get_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A version of ``obj_get_list`` that uses the cache as a means to get</span>
<span class="sd">    commonly-accessed data faster.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cache_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_cache_key</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">obj_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">obj_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">obj_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_get_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">=</span><span class="n">bundle</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">obj_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">obj_list</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.can_create">
    <p>def <span class="ident">can_create</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Checks to ensure <code>post</code> is within <code>allowed_methods</code>.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.can_create', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.can_create" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">can_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks to ensure ``post`` is within ``allowed_methods``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">allowed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">list_allowed_methods</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">detail_allowed_methods</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;post&#39;</span> <span class="ow">in</span> <span class="n">allowed</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.can_delete">
    <p>def <span class="ident">can_delete</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Checks to ensure <code>delete</code> is within <code>allowed_methods</code>.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.can_delete', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.can_delete" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">can_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks to ensure ``delete`` is within ``allowed_methods``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">allowed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">list_allowed_methods</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">detail_allowed_methods</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;delete&#39;</span> <span class="ow">in</span> <span class="n">allowed</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.can_update">
    <p>def <span class="ident">can_update</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Checks to ensure <code>put</code> is within <code>allowed_methods</code>.</p>
<p>Used when hydrating related data.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.can_update', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.can_update" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">can_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks to ensure ``put`` is within ``allowed_methods``.</span>
<span class="sd">    Used when hydrating related data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">allowed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">list_allowed_methods</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">detail_allowed_methods</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;put&#39;</span> <span class="ow">in</span> <span class="n">allowed</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.check_filtering">
    <p>def <span class="ident">check_filtering</span>(</p><p>self, field_name, filter_type=u&#39;exact&#39;, filter_bits=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Given a field name, a optional filter type and an optional list of
additional relations, determine if a field can be filtered on.</p>
<p>If a filter does not meet the needed conditions, it should raise an
<code>InvalidFilterError</code>.</p>
<p>If the filter meets the conditions, a list of attribute names (not
field names) will be returned.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.check_filtering', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.check_filtering" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">check_filtering</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">=</span><span class="s1">&#39;exact&#39;</span><span class="p">,</span> <span class="n">filter_bits</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a field name, a optional filter type and an optional list of</span>
<span class="sd">    additional relations, determine if a field can be filtered on.</span>
<span class="sd">    If a filter does not meet the needed conditions, it should raise an</span>
<span class="sd">    ``InvalidFilterError``.</span>
<span class="sd">    If the filter meets the conditions, a list of attribute names (not</span>
<span class="sd">    field names) will be returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">filter_bits</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">filter_bits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">filtering</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InvalidFilterError</span><span class="p">(</span><span class="s2">&quot;The &#39;</span><span class="si">%s</span><span class="s2">&#39; field does not allow filtering.&quot;</span> <span class="o">%</span> <span class="n">field_name</span><span class="p">)</span>
    <span class="c1"># Check to see if it&#39;s an allowed lookup type.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">filtering</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ALL</span><span class="p">,</span> <span class="n">ALL_WITH_RELATIONS</span><span class="p">):</span>
        <span class="c1"># Must be an explicit whitelist.</span>
        <span class="k">if</span> <span class="n">filter_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">filtering</span><span class="p">[</span><span class="n">field_name</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">InvalidFilterError</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; is not an allowed filter on the &#39;</span><span class="si">%s</span><span class="s2">&#39; field.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filter_type</span><span class="p">,</span> <span class="n">field_name</span><span class="p">))</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">attribute</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InvalidFilterError</span><span class="p">(</span><span class="s2">&quot;The &#39;</span><span class="si">%s</span><span class="s2">&#39; field has no &#39;attribute&#39; for searching with.&quot;</span> <span class="o">%</span> <span class="n">field_name</span><span class="p">)</span>
    <span class="c1"># Check to see if it&#39;s a relational lookup and if that&#39;s allowed.</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filter_bits</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">],</span> <span class="s1">&#39;is_related&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">InvalidFilterError</span><span class="p">(</span><span class="s2">&quot;The &#39;</span><span class="si">%s</span><span class="s2">&#39; field does not support relations.&quot;</span> <span class="o">%</span> <span class="n">field_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">filtering</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">==</span> <span class="n">ALL_WITH_RELATIONS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidFilterError</span><span class="p">(</span><span class="s2">&quot;Lookups are not allowed more than one level deep on the &#39;</span><span class="si">%s</span><span class="s2">&#39; field.&quot;</span> <span class="o">%</span> <span class="n">field_name</span><span class="p">)</span>
        <span class="c1"># Recursively descend through the remaining lookups in the filter,</span>
        <span class="c1"># if any. We should ensure that all along the way, we&#39;re allowed</span>
        <span class="c1"># to filter on that field by the related resource.</span>
        <span class="n">related_resource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_related_resource</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">attribute</span><span class="p">]</span> <span class="o">+</span> <span class="n">related_resource</span><span class="o">.</span><span class="n">check_filtering</span><span class="p">(</span><span class="n">filter_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">filter_type</span><span class="p">,</span> <span class="n">filter_bits</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">attribute</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.convert_custom_field">
    <p>def <span class="ident">convert_custom_field</span>(</p><p>self, uncurated_value, field_schema)</p>
    </div>
    

    
  
    <div class="desc"><p>Tidy up the custom field values</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.convert_custom_field', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.convert_custom_field" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">convert_custom_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uncurated_value</span><span class="p">,</span> <span class="n">field_schema</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tidy up the custom field values&quot;&quot;&quot;</span>
    <span class="n">curated_value</span> <span class="o">=</span> <span class="n">uncurated_value</span>
    <span class="k">if</span> <span class="n">field_schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;format&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;yyyy-mm-dd&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">uncurated_value</span><span class="p">:</span>
            <span class="n">curated_value</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
                <span class="n">uncurated_value</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">field_schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;field_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">PinnedCustomField</span><span class="o">.</span><span class="n">UISELECTTAGS</span><span class="p">):</span>
        <span class="n">curated_value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">uncurated_value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">field_schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;field_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">PinnedCustomField</span><span class="o">.</span><span class="n">INTEGER</span><span class="p">):</span>
        <span class="n">curated_value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">uncurated_value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">field_schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;field_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">PinnedCustomField</span><span class="o">.</span><span class="n">NUMBER</span><span class="p">,</span> <span class="n">PinnedCustomField</span><span class="o">.</span><span class="n">PERCENTAGE</span><span class="p">]):</span>
        <span class="n">curated_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">uncurated_value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">curated_value</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.create_identifier">
    <p>def <span class="ident">create_identifier</span>(</p><p>self, obj)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.create_identifier', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.create_identifier" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">create_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">u&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span> <span class="n">get_module_name</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_meta</span><span class="p">),</span> <span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.create_response">
    <p>def <span class="ident">create_response</span>(</p><p>self, request, data, response_class=&lt;class &#39;django.http.response.HttpResponse&#39;&gt;, **response_kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Extracts the common "which-format/serialize/return-response" cycle.
Mostly a useful shortcut/hook.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.create_response', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.create_response" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">create_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">HttpResponse</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts the common &quot;which-format/serialize/return-response&quot; cycle.</span>
<span class="sd">    Mostly a useful shortcut/hook.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">desired_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_format</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">serialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">desired_format</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Meta</span><span class="o">.</span><span class="n">ordrered_ftk</span><span class="p">)</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">response_class</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">serialized</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="n">build_content_type</span><span class="p">(</span>
        <span class="n">desired_format</span><span class="p">),</span> <span class="o">**</span><span class="n">response_kwargs</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">desired_format</span> <span class="o">==</span> <span class="s1">&#39;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&#39;</span><span class="p">):</span>
        <span class="n">rc</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;attachment; filename=export_from_chembiohub_chemreg</span><span class="si">%d</span><span class="s1">.xlsx&#39;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">desired_format</span> <span class="o">==</span> <span class="s1">&#39;chemical/x-mdl-sdfile&#39;</span><span class="p">):</span>
        <span class="n">rc</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;attachment; filename=export_from_chembiohub_chemreg</span><span class="si">%d</span><span class="s1">.sdf&#39;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">rc</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.dehydrate">
    <p>def <span class="ident">dehydrate</span>(</p><p>self, bundle)</p>
    </div>
    

    
  
    <div class="desc"><p>Tidy up the data adding timestamp etc, now mostly deprecated</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.dehydrate', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.dehydrate" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">dehydrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tidy up the data adding timestamp etc, now mostly deprecated&quot;&quot;&quot;</span>
    <span class="c1"># try:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">related_molregno</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">names</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Meta</span><span class="o">.</span><span class="n">fieldnames</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">blinded_batch_id</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">deepgetattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">except</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>
                <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;chemblId&quot;</span><span class="p">:</span>
                <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">blinded_batch_id</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">created_by</span><span class="p">:</span>
      <span class="c1">#user = User.objects.get(username=bundle.obj.created_by)</span>
        <span class="n">User</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">created_by</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ObjectDoesNotExist</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">first_name</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">created_by</span><span class="o">.</span><span class="n">split</span><span class="p">[</span><span class="s2">&quot; &quot;</span><span class="p">][</span>
                                        <span class="mi">0</span><span class="p">],</span> <span class="n">last_name</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">created_by</span><span class="o">.</span><span class="n">split</span><span class="p">[</span><span class="s2">&quot; &quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">mynames</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;uncurated_fields&quot;</span><span class="p">,</span> <span class="s2">&quot;warnings&quot;</span><span class="p">,</span> <span class="s2">&quot;properties&quot;</span><span class="p">,</span> <span class="s2">&quot;custom_fields&quot;</span><span class="p">,]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">mynames</span><span class="p">:</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
        
    <span class="c1">#bundle.data[&quot;created_by&quot;] = user.__dict__</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">first_name</span><span class="p">:</span>
            <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;created_by&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">user</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">last_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;created_by&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;created_by&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">created_by</span>
    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;created&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
    <span class="c1"># except:</span>
    <span class="c1">#    pass</span>
    <span class="k">return</span> <span class="n">bundle</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.dehydrate_resource_uri">
    <p>def <span class="ident">dehydrate_resource_uri</span>(</p><p>self, bundle)</p>
    </div>
    

    
  
    <div class="desc"><p>For the automatically included <code>resource_uri</code> field, dehydrate
the URI for the given bundle.</p>
<p>Returns empty string if no URI can be generated.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.dehydrate_resource_uri', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.dehydrate_resource_uri" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">dehydrate_resource_uri</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For the automatically included ``resource_uri`` field, dehydrate</span>
<span class="sd">    the URI for the given bundle.</span>
<span class="sd">    Returns empty string if no URI can be generated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_resource_uri</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
    <span class="k">except</span> <span class="n">NoReverseMatch</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.delete_detail">
    <p>def <span class="ident">delete_detail</span>(</p><p>self, request, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Destroys a single resource/object.</p>
<p>Calls <code>obj_delete</code>.</p>
<p>If the resource is deleted, return <code>HttpNoContent</code> (204 No Content).
If the resource did not exist, return <code>Http404</code> (404 Not Found).</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.delete_detail', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.delete_detail" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">delete_detail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Destroys a single resource/object.</span>
<span class="sd">    Calls ``obj_delete``.</span>
<span class="sd">    If the resource is deleted, return ``HttpNoContent`` (204 No Content).</span>
<span class="sd">    If the resource did not exist, return ``Http404`` (404 Not Found).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Manually construct the bundle here, since we don&#39;t want to try to</span>
    <span class="c1"># delete an empty instance.</span>
    <span class="n">bundle</span> <span class="o">=</span> <span class="n">Bundle</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj_delete</span><span class="p">(</span><span class="n">bundle</span><span class="o">=</span><span class="n">bundle</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_api_resource_names</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="n">HttpNoContent</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">NotFound</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="n">HttpNotFound</span><span class="p">()</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.delete_index">
    <p>def <span class="ident">delete_index</span>(</p><p>self, request, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Delete the index that was created for a multiple batch</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.delete_index', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.delete_index" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">delete_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Delete the index that was created for a multiple batch&quot;&quot;&quot;</span>
    <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">))</span>
    <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_deserialized_detail_data</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">)</span>
    <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">dict_strip_unicode_keys</span><span class="p">(</span><span class="n">deserialized</span><span class="p">),</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authorized_update_detail</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authorized_create_detail</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;multiplebatch&quot;</span><span class="p">]</span>
    <span class="n">mb</span> <span class="o">=</span> <span class="n">CBHCompoundMultipleBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
    <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">delete_index</span><span class="p">(</span>
        <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_temp_index_name</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">mb</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">http</span><span class="o">.</span><span class="n">HttpAccepted</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.delete_list">
    <p>def <span class="ident">delete_list</span>(</p><p>self, request, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Destroys a collection of resources/objects.</p>
<p>Calls <code>obj_delete_list</code>.</p>
<p>If the resources are deleted, return <code>HttpNoContent</code> (204 No Content).</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.delete_list', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.delete_list" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">delete_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Destroys a collection of resources/objects.</span>
<span class="sd">    Calls ``obj_delete_list``.</span>
<span class="sd">    If the resources are deleted, return ``HttpNoContent`` (204 No Content).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">obj_delete_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">=</span><span class="n">bundle</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_api_resource_names</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="n">HttpNoContent</span><span class="p">()</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.deserialize">
    <p>def <span class="ident">deserialize</span>(</p><p>self, request, data, format=u&#39;application/json&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>Given a request, data and a format, deserializes the given data.</p>
<p>It relies on the request properly sending a <code>CONTENT_TYPE</code> header,
falling back to <code>application/json</code> if not provided.</p>
<p>Mostly a hook, this uses the <code>Serializer</code> from <code>Resource._meta</code>.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.deserialize', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.deserialize" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">deserialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a request, data and a format, deserializes the given data.</span>
<span class="sd">    It relies on the request properly sending a ``CONTENT_TYPE`` header,</span>
<span class="sd">    falling back to ``application/json`` if not provided.</span>
<span class="sd">    Mostly a hook, this uses the ``Serializer`` from ``Resource._meta``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">serializer</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="n">format</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">deserialized</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.detail_uri_kwargs">
    <p>def <span class="ident">detail_uri_kwargs</span>(</p><p>self, bundle_or_obj)</p>
    </div>
    

    
  
    <div class="desc"><p>Given a <code>Bundle</code> or an object (typically a <code>Model</code> instance),
it returns the extra kwargs needed to generate a detail URI.</p>
<p>By default, it uses the model's <code>pk</code> in order to create the URI.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.detail_uri_kwargs', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.detail_uri_kwargs" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">detail_uri_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle_or_obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a ``Bundle`` or an object (typically a ``Model`` instance),</span>
<span class="sd">    it returns the extra kwargs needed to generate a detail URI.</span>
<span class="sd">    By default, it uses the model&#39;s ``pk`` in order to create the URI.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bundle_or_obj</span><span class="p">,</span> <span class="n">Bundle</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">detail_uri_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">bundle_or_obj</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">detail_uri_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">detail_uri_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">bundle_or_obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">detail_uri_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">kwargs</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.determine_format">
    <p>def <span class="ident">determine_format</span>(</p><p>self, request)</p>
    </div>
    

    
  
    <div class="desc"><p>Used to determine the desired format.</p>
<p>Largely relies on <code>tastypie.utils.mime.determine_format</code> but here
as a point of extension.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.determine_format', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.determine_format" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">determine_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used to determine the desired format.</span>
<span class="sd">    Largely relies on ``tastypie.utils.mime.determine_format`` but here</span>
<span class="sd">    as a point of extension.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">determine_format</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">serializer</span><span class="p">,</span> <span class="n">default_format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">default_format</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.dispatch">
    <p>def <span class="ident">dispatch</span>(</p><p>self, request_type, request, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Handles the common operations (allowed HTTP method, authentication,
throttling, method lookup) surrounding most CRUD interactions.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.dispatch', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.dispatch" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_type</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles the common operations (allowed HTTP method, authentication,</span>
<span class="sd">    throttling, method lookup) surrounding most CRUD interactions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">allowed_methods</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_allowed_methods&quot;</span> <span class="o">%</span> <span class="n">request_type</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;HTTP_X_HTTP_METHOD_OVERRIDE&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">:</span>
        <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s1">&#39;HTTP_X_HTTP_METHOD_OVERRIDE&#39;</span><span class="p">]</span>
    <span class="n">request_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_check</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">allowed</span><span class="o">=</span><span class="n">allowed_methods</span><span class="p">)</span>
    <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">request_method</span><span class="p">,</span> <span class="n">request_type</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ImmediateHttpResponse</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="n">http</span><span class="o">.</span><span class="n">HttpNotImplemented</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">throttle_check</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="c1"># All clear. Process the request.</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">convert_post_to_put</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c1"># Add the throttled request.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log_throttled_access</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="c1"># If what comes back isn&#39;t a ``HttpResponse``, assume that the</span>
    <span class="c1"># request was accepted and that some action occurred. This also</span>
    <span class="c1"># prevents Django from freaking out.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">HttpResponse</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="n">HttpNoContent</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">response</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.dispatch_detail">
    <p>def <span class="ident">dispatch_detail</span>(</p><p>self, request, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>A view for handling the various HTTP methods (GET/POST/PUT/DELETE) on
a single resource.</p>
<p>Relies on <code>Resource.dispatch</code> for the heavy-lifting.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.dispatch_detail', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.dispatch_detail" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">dispatch_detail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A view for handling the various HTTP methods (GET/POST/PUT/DELETE) on</span>
<span class="sd">    a single resource.</span>
<span class="sd">    Relies on ``Resource.dispatch`` for the heavy-lifting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="s1">&#39;detail&#39;</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.dispatch_list">
    <p>def <span class="ident">dispatch_list</span>(</p><p>self, request, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>A view for handling the various HTTP methods (GET/POST/PUT/DELETE) over
the entire list of resources.</p>
<p>Relies on <code>Resource.dispatch</code> for the heavy-lifting.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.dispatch_list', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.dispatch_list" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">dispatch_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A view for handling the various HTTP methods (GET/POST/PUT/DELETE) over</span>
<span class="sd">    the entire list of resources.</span>
<span class="sd">    Relies on ``Resource.dispatch`` for the heavy-lifting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.error_response">
    <p>def <span class="ident">error_response</span>(</p><p>self, request, errors, response_class=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Extracts the common "which-format/serialize/return-error-response"
cycle.</p>
<p>Should be used as much as possible to return errors.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.error_response', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.error_response" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">error_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts the common &quot;which-format/serialize/return-error-response&quot;</span>
<span class="sd">    cycle.</span>
<span class="sd">    Should be used as much as possible to return errors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">response_class</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">response_class</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">HttpBadRequest</span>
    <span class="n">desired_format</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">desired_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_format</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">BadRequest</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c1"># Fall through to default handler below</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># JSONP can cause extra breakage.</span>
            <span class="n">desired_format</span> <span class="o">=</span> <span class="s1">&#39;application/json&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">desired_format</span><span class="p">:</span>
        <span class="n">desired_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">default_format</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">serialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">desired_format</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;Additional errors occurred, but serialization of those errors failed.&quot;</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">+=</span> <span class="s2">&quot; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span>
        <span class="k">return</span> <span class="n">response_class</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">error</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/plain&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response_class</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">serialized</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="n">build_content_type</span><span class="p">(</span><span class="n">desired_format</span><span class="p">))</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.filter_value_to_python">
    <p>def <span class="ident">filter_value_to_python</span>(</p><p>self, value, field_name, filters, filter_expr, filter_type)</p>
    </div>
    

    
  
    <div class="desc"><p>Turn the string <code>value</code> into a python object.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.filter_value_to_python', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.filter_value_to_python" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">filter_value_to_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">filter_expr</span><span class="p">,</span>
        <span class="n">filter_type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Turn the string ``value`` into a python object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Simple values</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">string_to_python</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="c1"># Split on &#39;,&#39; if not empty string and either an in or range filter.</span>
    <span class="k">if</span> <span class="n">filter_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;range&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="s1">&#39;getlist&#39;</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">filters</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">filter_expr</span><span class="p">):</span>
                <span class="n">value</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.full_dehydrate">
    <p>def <span class="ident">full_dehydrate</span>(</p><p>self, bundle, for_list=False)</p>
    </div>
    

    
  
    <div class="desc"><p>Given a bundle with an object instance, extract the information from it
to populate the resource.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.full_dehydrate', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.full_dehydrate" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">full_dehydrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">for_list</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a bundle with an object instance, extract the information from it</span>
<span class="sd">    to populate the resource.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span>
    <span class="n">api_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">api_name</span>
    <span class="n">resource_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span>
    <span class="c1"># Dehydrate each field.</span>
    <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_object</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># If it&#39;s not for use in this mode, skip</span>
        <span class="n">field_use_in</span> <span class="o">=</span> <span class="n">field_object</span><span class="o">.</span><span class="n">use_in</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">field_use_in</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">field_use_in</span><span class="p">(</span><span class="n">bundle</span><span class="p">):</span>
                <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field_use_in</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span> <span class="k">if</span> <span class="n">for_list</span> <span class="k">else</span> <span class="s1">&#39;detail&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>
        <span class="c1"># A touch leaky but it makes URI resolution work.</span>
        <span class="k">if</span> <span class="n">field_object</span><span class="o">.</span><span class="n">dehydrated_type</span> <span class="o">==</span> <span class="s1">&#39;related&#39;</span><span class="p">:</span>
            <span class="n">field_object</span><span class="o">.</span><span class="n">api_name</span> <span class="o">=</span> <span class="n">api_name</span>
            <span class="n">field_object</span><span class="o">.</span><span class="n">resource_name</span> <span class="o">=</span> <span class="n">resource_name</span>
        <span class="n">data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_object</span><span class="o">.</span><span class="n">dehydrate</span><span class="p">(</span><span class="n">bundle</span><span class="p">,</span> <span class="n">for_list</span><span class="o">=</span><span class="n">for_list</span><span class="p">)</span>
        <span class="c1"># Check for an optional method to do further dehydration.</span>
        <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;dehydrate_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">field_name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span>
    <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dehydrate</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bundle</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.full_hydrate">
    <p>def <span class="ident">full_hydrate</span>(</p><p>self, bundle)</p>
    </div>
    

    
  
    <div class="desc"><p>As the object is created we run the validate code on it</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.full_hydrate', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.full_hydrate" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">full_hydrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;As the object is created we run the validate code on it&#39;&#39;&#39;</span>
    <span class="n">bundle</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CBHCompoundUploadResource</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">full_hydrate</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">created_by</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">created_by_id</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
        <span class="c1"># bundle.obj.validate()</span>
        <span class="c1"># self.match_list_to_moleculedictionaries(bundle.obj,bundle.data[&quot;project&quot;] )</span>
    <span class="k">return</span> <span class="n">bundle</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.generate_cache_key">
    <p>def <span class="ident">generate_cache_key</span>(</p><p>self, *args, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Creates a unique-enough cache key.</p>
<p>This is based off the current api_name/resource_name/args/kwargs.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.generate_cache_key', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.generate_cache_key" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">generate_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a unique-enough cache key.</span>
<span class="sd">    This is based off the current api_name/resource_name/args/kwargs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">smooshed</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
    <span class="c1"># Use a list plus a ``.join()`` because it&#39;s faster than concatenation.</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">api_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">smooshed</span><span class="p">)))</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.get_bundle_detail_data">
    <p>def <span class="ident">get_bundle_detail_data</span>(</p><p>self, bundle)</p>
    </div>
    

    
  
    <div class="desc"><p>Convenience method to return the <code>detail_uri_name</code> attribute off
<code>bundle.obj</code>.</p>
<p>Usually just accesses <code>bundle.obj.pk</code> by default.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.get_bundle_detail_data', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.get_bundle_detail_data" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_bundle_detail_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience method to return the ``detail_uri_name`` attribute off</span>
<span class="sd">    ``bundle.obj``.</span>
<span class="sd">    Usually just accesses ``bundle.obj.pk`` by default.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">detail_uri_name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.get_cached_temporary_batch_data">
    <p>def <span class="ident">get_cached_temporary_batch_data</span>(</p><p>self, multi_batch_id, get_data, request, bundledata={})</p>
    </div>
    

    
  
    <div class="desc"><p>make the batch data into models so it can be serialized properly</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.get_cached_temporary_batch_data', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.get_cached_temporary_batch_data" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_cached_temporary_batch_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multi_batch_id</span><span class="p">,</span> <span class="n">get_data</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">bundledata</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">&quot;&quot;&quot;make the batch data into models so it can be serialized properly&quot;&quot;&quot;</span>
    <span class="n">es_request</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">get_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;offset&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">get_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limit&quot;</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
        <span class="s2">&quot;filter&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">get_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;query&quot;</span><span class="p">,</span> <span class="s1">&#39;{ &quot;match_all&quot; : {}}&#39;</span><span class="p">)),</span>
        <span class="s2">&quot;sort&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">get_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sorts&quot;</span><span class="p">,</span> <span class="s1">&#39;[{&quot;id&quot;: {&quot;order&quot;: &quot;asc&quot;}}]&#39;</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_temp_index_name</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span> <span class="n">multi_batch_id</span><span class="p">)</span>
    <span class="n">es_serializer</span> <span class="o">=</span> <span class="n">CBHCompoundBatchElasticSearchSerializer</span><span class="p">()</span>
    <span class="n">bundledata</span> <span class="o">=</span> <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">es_request</span><span class="p">,</span> <span class="n">bundledata</span><span class="p">)</span>
    <span class="n">bundledata</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">es_serializer</span><span class="o">.</span><span class="n">to_python_ready_data</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">bundledata</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">bundledata</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.get_cached_temporary_batches">
    <p>def <span class="ident">get_cached_temporary_batches</span>(</p><p>self, bundles, request, bundledata={})</p>
    </div>
    

    
  
    <div class="desc"><p>Request the imported data which has been cached in Elasticsearch</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.get_cached_temporary_batches', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.get_cached_temporary_batches" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_cached_temporary_batches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundles</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">bundledata</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">&quot;&quot;&quot;Request the imported data which has been cached in Elasticsearch&quot;&quot;&quot;</span>
    <span class="n">fakeobj</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="n">bundledata</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">],</span> <span class="nb">id</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">bun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">fakeobj</span><span class="p">)</span>
    <span class="n">bun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_dehydrate</span><span class="p">(</span><span class="n">bun</span><span class="p">)</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">bun</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">datum</span> <span class="ow">in</span> <span class="n">bundles</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]:</span>
    
        <span class="n">datum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">datum</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
        <span class="n">datum</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proj</span>
        <span class="n">datum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_hydrate</span><span class="p">(</span><span class="n">datum</span><span class="p">)</span>
        <span class="c1">#Quick hack to fix saving of sutom fields when validating a sketch</span>
        <span class="k">if</span> <span class="n">bundledata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;sketch&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">bundles</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">datum</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;custom_fields&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bundledata</span><span class="p">[</span><span class="s2">&quot;custom_fields&quot;</span><span class="p">]</span>
            <span class="n">datum</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">custom_fields</span> <span class="o">=</span> <span class="n">bundledata</span><span class="p">[</span><span class="s2">&quot;custom_fields&quot;</span><span class="p">]</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datum</span><span class="p">)</span>
    <span class="n">bundles</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">return</span> <span class="n">bundles</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.get_detail">
    <p>def <span class="ident">get_detail</span>(</p><p>self, request, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Returns a single serialized resource.</p>
<p>Calls <code>cached_obj_get/obj_get</code> to provide the data, then handles that result
set and serializes it.</p>
<p>Should return a HttpResponse (200 OK).</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.get_detail', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.get_detail" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_detail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a single serialized resource.</span>
<span class="sd">    Calls ``cached_obj_get/obj_get`` to provide the data, then handles that result</span>
<span class="sd">    set and serializes it.</span>
<span class="sd">    Should return a HttpResponse (200 OK).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">basic_bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cached_obj_get</span><span class="p">(</span><span class="n">bundle</span><span class="o">=</span><span class="n">basic_bundle</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_api_resource_names</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">ObjectDoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="n">HttpNotFound</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">MultipleObjectsReturned</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="n">HttpMultipleChoices</span><span class="p">(</span><span class="s2">&quot;More than one resource is found at this URI.&quot;</span><span class="p">)</span>
    <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
    <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_dehydrate</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span>
    <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_detail_data_to_serialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">bundle</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">bundle</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.get_fields">
    <p>def <span class="ident">get_fields</span>(</p><p>cls, fields=None, excludes=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Given any explicit fields to include and fields to exclude, add
additional fields based on the associated model.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.get_fields', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.get_fields" class="source">
    <div class="codehilite"><pre><span></span><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">get_fields</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">excludes</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given any explicit fields to include and fields to exclude, add</span>
<span class="sd">    additional fields based on the associated model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">final_fields</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">excludes</span> <span class="o">=</span> <span class="n">excludes</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_class</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">final_fields</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
        <span class="c1"># If the field name is already present, skip</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">base_fields</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># If field is not present in explicit field listing, skip</span>
        <span class="k">if</span> <span class="n">fields</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># If field is in exclude list, skip</span>
        <span class="k">if</span> <span class="n">excludes</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">excludes</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">cls</span><span class="o">.</span><span class="n">should_skip_field</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">api_field_class</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">api_field_from_django_field</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;attribute&#39;</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;help_text&#39;</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">help_text</span><span class="p">,</span>
            <span class="s1">&#39;verbose_name&#39;</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">verbose_name</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">null</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;null&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;unique&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">unique</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">null</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">blank</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;blank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get_internal_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;TextField&#39;</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">has_default</span><span class="p">():</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">default</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;auto_now&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">auto_now</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;auto_now_add&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">auto_now_add</span>
        <span class="n">final_fields</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">api_field_class</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">final_fields</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">instance_name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span>
    <span class="k">return</span> <span class="n">final_fields</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.get_list">
    <p>def <span class="ident">get_list</span>(</p><p>self, request, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Returns a serialized list of resources.</p>
<p>Calls <code>obj_get_list</code> to provide the data, then handles that result
set and serializes it.</p>
<p>Should return a HttpResponse (200 OK).</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.get_list', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.get_list" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a serialized list of resources.</span>
<span class="sd">    Calls ``obj_get_list`` to provide the data, then handles that result</span>
<span class="sd">    set and serializes it.</span>
<span class="sd">    Should return a HttpResponse (200 OK).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Uncached for now. Invalidation that works for everyone may be</span>
    <span class="c1">#       impossible.</span>
    <span class="n">base_bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_get_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">=</span><span class="n">base_bundle</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_api_resource_names</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
    <span class="n">sorted_objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_sorting</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">)</span>
    <span class="n">paginator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">paginator_class</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span> <span class="n">sorted_objects</span><span class="p">,</span> <span class="n">resource_uri</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_resource_uri</span><span class="p">(),</span> <span class="n">limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">limit</span><span class="p">,</span> <span class="n">max_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">max_limit</span><span class="p">,</span> <span class="n">collection_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">collection_name</span><span class="p">)</span>
    <span class="n">to_be_serialized</span> <span class="o">=</span> <span class="n">paginator</span><span class="o">.</span><span class="n">page</span><span class="p">()</span>
    <span class="c1"># Dehydrate the bundles in preparation for serialization.</span>
    <span class="n">bundles</span> <span class="o">=</span> <span class="p">[</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_dehydrate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">),</span> <span class="n">for_list</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">to_be_serialized</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">collection_name</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="n">to_be_serialized</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">collection_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">bundles</span>
    <span class="n">to_be_serialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_list_data_to_serialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">to_be_serialized</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">to_be_serialized</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.get_multiple">
    <p>def <span class="ident">get_multiple</span>(</p><p>self, request, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Returns a serialized list of resources based on the identifiers
from the URL.</p>
<p>Calls <code>obj_get</code> to fetch only the objects requested. This method
only responds to HTTP GET.</p>
<p>Should return a HttpResponse (200 OK).</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.get_multiple', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.get_multiple" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_multiple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a serialized list of resources based on the identifiers</span>
<span class="sd">    from the URL.</span>
<span class="sd">    Calls ``obj_get`` to fetch only the objects requested. This method</span>
<span class="sd">    only responds to HTTP GET.</span>
<span class="sd">    Should return a HttpResponse (200 OK).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">method_check</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">allowed</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">throttle_check</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="c1"># Rip apart the list then iterate.</span>
    <span class="n">kwarg_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_list&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">detail_uri_name</span>
    <span class="n">obj_identifiers</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">kwarg_name</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">not_found</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">base_bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">obj_identifiers</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_get</span><span class="p">(</span><span class="n">bundle</span><span class="o">=</span><span class="n">base_bundle</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">detail_uri_name</span><span class="p">:</span> <span class="n">identifier</span><span class="p">})</span>
            <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
            <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_dehydrate</span><span class="p">(</span><span class="n">bundle</span><span class="p">,</span> <span class="n">for_list</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">ObjectDoesNotExist</span><span class="p">,</span> <span class="n">Unauthorized</span><span class="p">):</span>
            <span class="n">not_found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
    <span class="n">object_list</span> <span class="o">=</span> <span class="p">{</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">collection_name</span><span class="p">:</span> <span class="n">objects</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_found</span><span class="p">):</span>
        <span class="n">object_list</span><span class="p">[</span><span class="s1">&#39;not_found&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">not_found</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log_throttled_access</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">object_list</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.get_object_list">
    <p>def <span class="ident">get_object_list</span>(</p><p>self, request)</p>
    </div>
    

    
  
    <div class="desc"><p>where to add select related etc.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.get_object_list', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.get_object_list" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_object_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;where to add select related etc.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CBHCompoundUploadResource</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.get_part_processed_multiple_batch">
    <p>def <span class="ident">get_part_processed_multiple_batch</span>(</p><p>self, request, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Get the part processed data from elasticsearch and the stats about the
multiple batch</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.get_part_processed_multiple_batch', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.get_part_processed_multiple_batch" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_part_processed_multiple_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the part processed data from elasticsearch and the stats about the</span>
<span class="sd">    multiple batch</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Uncached for now. Invalidation that works for everyone may be</span>
    <span class="c1">#       impossible.</span>
    <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
    <span class="c1"># self.authorized_create_detail(self.get_object_list(bundle.request), bundle)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;multi_batch&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)):</span>
        <span class="n">mb</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;multi_batch&quot;</span><span class="p">)</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">id</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;current_batch&quot;</span><span class="p">)</span>
        <span class="n">mb</span> <span class="o">=</span> <span class="n">CBHCompoundMultipleBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
    <span class="n">to_be_serialized</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">uploaded_data</span>
    <span class="n">to_be_serialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cached_temporary_batch_data</span><span class="p">(</span>
        <span class="nb">id</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">bundledata</span><span class="o">=</span><span class="n">to_be_serialized</span><span class="p">)</span>
    <span class="n">index_name</span> <span class="o">=</span> <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_temp_index_name</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
    <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_action_totals</span><span class="p">(</span><span class="n">index_name</span><span class="p">,</span> <span class="n">to_be_serialized</span><span class="p">)</span>
    <span class="n">to_be_serialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_list_data_to_serialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">to_be_serialized</span><span class="p">,</span> <span class="n">permanent_data</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">to_be_serialized</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.get_resource_uri">
    <p>def <span class="ident">get_resource_uri</span>(</p><p>self, bundle_or_obj=None, url_name=u&#39;api_dispatch_list&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>Handles generating a resource URI.</p>
<p>If the <code>bundle_or_obj</code> argument is not provided, it builds the URI
for the list endpoint.</p>
<p>If the <code>bundle_or_obj</code> argument is provided, it builds the URI for
the detail endpoint.</p>
<p>Return the generated URI. If that URI can not be reversed (not found
in the URLconf), it will return an empty string.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.get_resource_uri', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.get_resource_uri" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_resource_uri</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle_or_obj</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">url_name</span><span class="o">=</span><span class="s1">&#39;api_dispatch_list&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles generating a resource URI.</span>
<span class="sd">    If the ``bundle_or_obj`` argument is not provided, it builds the URI</span>
<span class="sd">    for the list endpoint.</span>
<span class="sd">    If the ``bundle_or_obj`` argument is provided, it builds the URI for</span>
<span class="sd">    the detail endpoint.</span>
<span class="sd">    Return the generated URI. If that URI can not be reversed (not found</span>
<span class="sd">    in the URLconf), it will return an empty string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">bundle_or_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">url_name</span> <span class="o">=</span> <span class="s1">&#39;api_dispatch_detail&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_reverse_url</span><span class="p">(</span><span class="n">url_name</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_uri_kwargs</span><span class="p">(</span><span class="n">bundle_or_obj</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">NoReverseMatch</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.get_schema">
    <p>def <span class="ident">get_schema</span>(</p><p>self, request, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Returns a serialized form of the schema of the resource.</p>
<p>Calls <code>build_schema</code> to generate the data. This method only responds
to HTTP GET.</p>
<p>Should return a HttpResponse (200 OK).</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.get_schema', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.get_schema" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a serialized form of the schema of the resource.</span>
<span class="sd">    Calls ``build_schema`` to generate the data. This method only responds</span>
<span class="sd">    to HTTP GET.</span>
<span class="sd">    Should return a HttpResponse (200 OK).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">method_check</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">allowed</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">throttle_check</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log_throttled_access</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">authorized_read_detail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_schema</span><span class="p">())</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.get_via_uri">
    <p>def <span class="ident">get_via_uri</span>(</p><p>self, uri, request=None)</p>
    </div>
    

    
  
    <div class="desc"><p>This pulls apart the salient bits of the URI and populates the
resource via a <code>obj_get</code>.</p>
<p>Optionally accepts a <code>request</code>.</p>
<p>If you need custom behavior based on other portions of the URI,
simply override this method.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.get_via_uri', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.get_via_uri" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_via_uri</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This pulls apart the salient bits of the URI and populates the</span>
<span class="sd">    resource via a ``obj_get``.</span>
<span class="sd">    Optionally accepts a ``request``.</span>
<span class="sd">    If you need custom behavior based on other portions of the URI,</span>
<span class="sd">    simply override this method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">get_script_prefix</span><span class="p">()</span>
    <span class="n">chomped_uri</span> <span class="o">=</span> <span class="n">uri</span>
    <span class="k">if</span> <span class="n">prefix</span> <span class="ow">and</span> <span class="n">chomped_uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
        <span class="n">chomped_uri</span> <span class="o">=</span> <span class="n">chomped_uri</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="c1"># We mangle the path a bit further &amp; run URL resolution against *only*</span>
    <span class="c1"># the current class. This ought to prevent bad URLs from resolving to</span>
    <span class="c1"># incorrect data.</span>
    <span class="n">found_at</span> <span class="o">=</span> <span class="n">chomped_uri</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">found_at</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NotFound</span><span class="p">(</span><span class="s2">&quot;An incorrect URL was provided &#39;</span><span class="si">%s</span><span class="s2">&#39; for the &#39;</span><span class="si">%s</span><span class="s2">&#39; resource.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
    <span class="n">chomped_uri</span> <span class="o">=</span> <span class="n">chomped_uri</span><span class="p">[</span><span class="n">found_at</span><span class="p">:]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">url_resolver</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;urls&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">url_resolver</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">chomped_uri</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">view</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">result</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Resolver404</span><span class="p">(</span><span class="s2">&quot;URI not found in &#39;self.urls&#39;.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Resolver404</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NotFound</span><span class="p">(</span><span class="s2">&quot;The URL provided &#39;</span><span class="si">%s</span><span class="s2">&#39; was not a link to a valid resource.&quot;</span> <span class="o">%</span> <span class="n">uri</span><span class="p">)</span>
    <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_get</span><span class="p">(</span><span class="n">bundle</span><span class="o">=</span><span class="n">bundle</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_api_resource_names</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.hydrate">
    <p>def <span class="ident">hydrate</span>(</p><p>self, bundle)</p>
    </div>
    

    
  
    <div class="desc"><p>A hook to allow an initial manipulation of data before all methods/fields
have built out the hydrated data.</p>
<p>Useful if you need to access more than one hydrated field or want
to annotate on additional data.</p>
<p>Must return the modified bundle.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.hydrate', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.hydrate" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">hydrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A hook to allow an initial manipulation of data before all methods/fields</span>
<span class="sd">    have built out the hydrated data.</span>
<span class="sd">    Useful if you need to access more than one hydrated field or want</span>
<span class="sd">    to annotate on additional data.</span>
<span class="sd">    Must return the modified bundle.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">bundle</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.hydrate_m2m">
    <p>def <span class="ident">hydrate_m2m</span>(</p><p>self, bundle)</p>
    </div>
    

    
  
    <div class="desc"><p>Populate the ManyToMany data on the instance.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.hydrate_m2m', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.hydrate_m2m" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">hydrate_m2m</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Populate the ManyToMany data on the instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HydrationError</span><span class="p">(</span><span class="s2">&quot;You must call &#39;full_hydrate&#39; before attempting to run &#39;hydrate_m2m&#39; on </span><span class="si">%r</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_object</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field_object</span><span class="o">.</span><span class="n">is_m2m</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">field_object</span><span class="o">.</span><span class="n">attribute</span><span class="p">:</span>
            <span class="c1"># Note that we only hydrate the data, leaving the instance</span>
            <span class="c1"># unmodified. It&#39;s up to the user&#39;s code to handle this.</span>
            <span class="c1"># The ``ModelResource`` provides a working baseline</span>
            <span class="c1"># in this regard.</span>
            <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_object</span><span class="o">.</span><span class="n">hydrate_m2m</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_object</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field_object</span><span class="o">.</span><span class="n">is_m2m</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;hydrate_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">field_name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span><span class="p">:</span>
            <span class="n">method</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bundle</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.is_authenticated">
    <p>def <span class="ident">is_authenticated</span>(</p><p>self, request)</p>
    </div>
    

    
  
    <div class="desc"><p>Handles checking if the user is authenticated and dealing with
unauthenticated users.</p>
<p>Mostly a hook, this uses class assigned to <code>authentication</code> from
<code>Resource._meta</code>.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.is_authenticated', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.is_authenticated" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">is_authenticated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles checking if the user is authenticated and dealing with</span>
<span class="sd">    unauthenticated users.</span>
<span class="sd">    Mostly a hook, this uses class assigned to ``authentication`` from</span>
<span class="sd">    ``Resource._meta``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Authenticate the request as needed.</span>
    <span class="n">auth_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">auth_result</span><span class="p">,</span> <span class="n">HttpResponse</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ImmediateHttpResponse</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="n">auth_result</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">auth_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ImmediateHttpResponse</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="n">http</span><span class="o">.</span><span class="n">HttpUnauthorized</span><span class="p">())</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.is_valid">
    <p>def <span class="ident">is_valid</span>(</p><p>self, bundle)</p>
    </div>
    

    
  
    <div class="desc"><p>Handles checking if the data provided by the user is valid.</p>
<p>Mostly a hook, this uses class assigned to <code>validation</code> from
<code>Resource._meta</code>.</p>
<p>If validation fails, an error is raised with the error messages
serialized inside it.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.is_valid', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.is_valid" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">is_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles checking if the data provided by the user is valid.</span>
<span class="sd">    Mostly a hook, this uses class assigned to ``validation`` from</span>
<span class="sd">    ``Resource._meta``.</span>
<span class="sd">    If validation fails, an error is raised with the error messages</span>
<span class="sd">    serialized inside it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">bundle</span><span class="p">,</span> <span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">errors</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.log_throttled_access">
    <p>def <span class="ident">log_throttled_access</span>(</p><p>self, request)</p>
    </div>
    

    
  
    <div class="desc"><p>Handles the recording of the user's access for throttling purposes.</p>
<p>Mostly a hook, this uses class assigned to <code>throttle</code> from
<code>Resource._meta</code>.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.log_throttled_access', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.log_throttled_access" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">log_throttled_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles the recording of the user&#39;s access for throttling purposes.</span>
<span class="sd">    Mostly a hook, this uses class assigned to ``throttle`` from</span>
<span class="sd">    ``Resource._meta``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">request_method</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">throttle</span><span class="o">.</span><span class="n">accessed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">get_identifier</span><span class="p">(</span><span class="n">request</span><span class="p">),</span> <span class="n">url</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">get_full_path</span><span class="p">(),</span> <span class="n">request_method</span><span class="o">=</span><span class="n">request_method</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.lookup_kwargs_with_identifiers">
    <p>def <span class="ident">lookup_kwargs_with_identifiers</span>(</p><p>self, bundle, kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Kwargs here represent uri identifiers Ex: /repos/<user_id>/<repo_name>/
We need to turn those identifiers into Python objects for generating
lookup parameters that can find them in the DB</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.lookup_kwargs_with_identifiers', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.lookup_kwargs_with_identifiers" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">lookup_kwargs_with_identifiers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Kwargs here represent uri identifiers Ex: /repos/&lt;user_id&gt;/&lt;repo_name&gt;/</span>
<span class="sd">    We need to turn those identifiers into Python objects for generating</span>
<span class="sd">    lookup parameters that can find them in the DB</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lookup_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
    <span class="c1"># Override data values, we rely on uri identifiers</span>
    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c1"># We&#39;re going to manually hydrate, as opposed to calling</span>
    <span class="c1"># ``full_hydrate``, to ensure we don&#39;t try to flesh out related</span>
    <span class="c1"># resources &amp; keep things speedy.</span>
    <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hydrate</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">identifier</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">detail_uri_name</span><span class="p">:</span>
            <span class="n">lookup_kwargs</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span>
            <span class="k">continue</span>
        <span class="n">field_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span>
        <span class="c1"># Skip readonly or related fields.</span>
        <span class="k">if</span> <span class="n">field_object</span><span class="o">.</span><span class="n">readonly</span> <span class="ow">is</span> <span class="bp">True</span> <span class="ow">or</span> <span class="n">field_object</span><span class="o">.</span><span class="n">is_related</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># Check for an optional method to do further hydration.</span>
        <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;hydrate_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span><span class="p">:</span>
            <span class="n">bundle</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field_object</span><span class="o">.</span><span class="n">attribute</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">field_object</span><span class="o">.</span><span class="n">hydrate</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span>
        <span class="n">lookup_kwargs</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">lookup_kwargs</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.method_check">
    <p>def <span class="ident">method_check</span>(</p><p>self, request, allowed=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Ensures that the HTTP method used on the request is allowed to be
handled by the resource.</p>
<p>Takes an <code>allowed</code> parameter, which should be a list of lowercase
HTTP methods to check against. Usually, this looks like::</p>
<div class="codehilite"><pre><span></span># The most generic lookup.
self.method_check(request, self._meta.allowed_methods)

# A lookup against what&#39;s allowed for list-type methods.
self.method_check(request, self._meta.list_allowed_methods)

# A useful check when creating a new endpoint that only handles
# GET.
self.method_check(request, [&#39;get&#39;])
</pre></div></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.method_check', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.method_check" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">method_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">allowed</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ensures that the HTTP method used on the request is allowed to be</span>
<span class="sd">    handled by the resource.</span>
<span class="sd">    Takes an ``allowed`` parameter, which should be a list of lowercase</span>
<span class="sd">    HTTP methods to check against. Usually, this looks like::</span>
<span class="sd">        # The most generic lookup.</span>
<span class="sd">        self.method_check(request, self._meta.allowed_methods)</span>
<span class="sd">        # A lookup against what&#39;s allowed for list-type methods.</span>
<span class="sd">        self.method_check(request, self._meta.list_allowed_methods)</span>
<span class="sd">        # A useful check when creating a new endpoint that only handles</span>
<span class="sd">        # GET.</span>
<span class="sd">        self.method_check(request, [&#39;get&#39;])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">allowed</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">allowed</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">request_method</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">allows</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">meth</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">meth</span> <span class="ow">in</span> <span class="n">allowed</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">request_method</span> <span class="o">==</span> <span class="s2">&quot;options&quot;</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">allows</span><span class="p">)</span>
        <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Allow&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">allows</span>
        <span class="k">raise</span> <span class="n">ImmediateHttpResponse</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">HttpMethodNotAllowed</span><span class="p">(</span><span class="n">allows</span><span class="p">)</span>
        <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Allow&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">allows</span>
        <span class="k">raise</span> <span class="n">ImmediateHttpResponse</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">request_method</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.multi_batch_custom_fields">
    <p>def <span class="ident">multi_batch_custom_fields</span>(</p><p>self, request, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>change the structure column for an excel file</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.multi_batch_custom_fields', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.multi_batch_custom_fields" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">multi_batch_custom_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;change the structure column for an excel file&#39;&#39;&#39;</span>
    <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">))</span>
    <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_deserialized_detail_data</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">)</span>
    <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">dict_strip_unicode_keys</span><span class="p">(</span><span class="n">deserialized</span><span class="p">),</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authorized_update_detail</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authorized_create_detail</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;multiplebatch&quot;</span><span class="p">]</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span>
    <span class="c1"># structure_col = bundle.data.get(&quot;structure_col&quot;, None)</span>
    <span class="n">mb</span> <span class="o">=</span> <span class="n">CBHCompoundMultipleBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
    <span class="n">processSmiles</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c1"># if structure_col and structure_col != mb.uploaded_data.get(&quot;structure_col&quot;, &quot;&quot;):</span>
    <span class="c1">#     processSmiles =  True</span>
    <span class="n">index_name</span> <span class="o">=</span> <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_temp_index_name</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">mb</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_action_totals</span><span class="p">(</span><span class="n">index_name</span><span class="p">,</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="n">mb</span><span class="o">.</span><span class="n">uploaded_data</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span>
    <span class="n">mb</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">http</span><span class="o">.</span><span class="n">HttpAccepted</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.multi_batch_save">
    <p>def <span class="ident">multi_batch_save</span>(</p><p>self, request, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Save the data which has been cached in Elasticsearch</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.multi_batch_save', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.multi_batch_save" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">multi_batch_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Save the data which has been cached in Elasticsearch&quot;&quot;&quot;</span>
    <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">))</span>
    <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_deserialized_detail_data</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">)</span>
    <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">dict_strip_unicode_keys</span><span class="p">(</span><span class="n">deserialized</span><span class="p">),</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authorized_update_detail</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authorized_create_detail</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
    
    <span class="nb">id</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;multiplebatch&quot;</span><span class="p">]</span>
    <span class="n">mb</span> <span class="o">=</span> <span class="n">CBHCompoundMultipleBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">Serializer</span><span class="p">()</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">mb</span><span class="p">)</span>
    <span class="n">limit</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">batches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">hasMoreData</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">mb</span><span class="o">.</span><span class="n">saved</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">mb</span><span class="o">.</span><span class="n">created_by</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span>
    <span class="n">mb</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;saved&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;ignored&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">datasets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">hasMoreData</span><span class="p">:</span>
        <span class="n">bundles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cached_temporary_batch_data</span><span class="p">(</span>
            <span class="n">mb</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>  <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="s1">&#39;{&quot;term&quot; : {&quot;properties.action.raw&quot; : &quot;New Batch&quot;}}&#39;</span><span class="p">,</span><span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="n">limit</span><span class="p">,</span> <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="n">offset</span><span class="p">,</span> <span class="s2">&quot;sorts&quot;</span><span class="p">:</span> <span class="s1">&#39;[{&quot;id&quot;: {&quot;order&quot;: &quot;desc&quot;}}]&#39;</span><span class="p">},</span> <span class="n">request</span><span class="p">)</span>
       <span class="c1"># allowing setting of headers to be fale during saving of drawn molecule</span>
        <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">bundles</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">patch_dict</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]))</span>
        <span class="n">set_of_batches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cached_temporary_batches</span><span class="p">(</span>
            <span class="n">bundles</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span>  <span class="n">bundledata</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">set_of_batches</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]:</span>
            <span class="k">if</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;New Batch&quot;</span><span class="p">):</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">created_by</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">created_by_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">multiple_batch_id</span> <span class="o">=</span> <span class="nb">id</span>
                <span class="c1"># batch.multi_batch_id = id</span>
                <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;saved&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">b</span><span class="o">.</span><span class="n">obj</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">set_of_batches</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]])</span>
        <span class="n">offset</span> <span class="o">+=</span> <span class="n">limit</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">set_of_batches</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">hasMoreData</span> <span class="o">=</span> <span class="bp">None</span>
    
    <span class="n">processed</span> <span class="o">=</span> <span class="p">[</span><span class="n">process_batch_list</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span> <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">]</span>
    <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">delete_index</span><span class="p">(</span>
        <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_temp_index_name</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">mb</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">after_save_and_index_hook</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">mb</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">project_key</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">http</span><span class="o">.</span><span class="n">HttpCreated</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.obj_create">
    <p>def <span class="ident">obj_create</span>(</p><p>self, bundle, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>A ORM-specific implementation of <code>obj_create</code>.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.obj_create', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.obj_create" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">obj_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A ORM-specific implementation of ``obj_create``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_class</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_hydrate</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.obj_delete">
    <p>def <span class="ident">obj_delete</span>(</p><p>self, bundle, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>A ORM-specific implementation of <code>obj_delete</code>.</p>
<p>Takes optional <code>kwargs</code>, which are used to narrow the query to find
the instance.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.obj_delete', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.obj_delete" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">obj_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A ORM-specific implementation of ``obj_delete``.</span>
<span class="sd">    Takes optional ``kwargs``, which are used to narrow the query to find</span>
<span class="sd">    the instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_get</span><span class="p">(</span><span class="n">bundle</span><span class="o">=</span><span class="n">bundle</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ObjectDoesNotExist</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotFound</span><span class="p">(</span><span class="s2">&quot;A model instance matching the provided arguments could not be found.&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">authorized_delete_detail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
    <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.obj_delete_list">
    <p>def <span class="ident">obj_delete_list</span>(</p><p>self, bundle, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>A ORM-specific implementation of <code>obj_delete_list</code>.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.obj_delete_list', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.obj_delete_list" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">obj_delete_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A ORM-specific implementation of ``obj_delete_list``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">objects_to_delete</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_get_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">=</span><span class="n">bundle</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">deletable_objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authorized_delete_list</span><span class="p">(</span><span class="n">objects_to_delete</span><span class="p">,</span> <span class="n">bundle</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">deletable_objects</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">):</span>
        <span class="c1"># It&#39;s likely a ``QuerySet``. Call ``.delete()`` for efficiency.</span>
        <span class="n">deletable_objects</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">authed_obj</span> <span class="ow">in</span> <span class="n">deletable_objects</span><span class="p">:</span>
            <span class="n">authed_obj</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.obj_delete_list_for_update">
    <p>def <span class="ident">obj_delete_list_for_update</span>(</p><p>self, bundle, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>A ORM-specific implementation of <code>obj_delete_list_for_update</code>.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.obj_delete_list_for_update', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.obj_delete_list_for_update" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">obj_delete_list_for_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A ORM-specific implementation of ``obj_delete_list_for_update``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">objects_to_delete</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_get_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">=</span><span class="n">bundle</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">deletable_objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authorized_update_list</span><span class="p">(</span><span class="n">objects_to_delete</span><span class="p">,</span> <span class="n">bundle</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">deletable_objects</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">):</span>
        <span class="c1"># It&#39;s likely a ``QuerySet``. Call ``.delete()`` for efficiency.</span>
        <span class="n">deletable_objects</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">authed_obj</span> <span class="ow">in</span> <span class="n">deletable_objects</span><span class="p">:</span>
            <span class="n">authed_obj</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.obj_get">
    <p>def <span class="ident">obj_get</span>(</p><p>self, bundle, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>A ORM-specific implementation of <code>obj_get</code>.</p>
<p>Takes optional <code>kwargs</code>, which are used to narrow the query to find
the instance.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.obj_get', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.obj_get" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">obj_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A ORM-specific implementation of ``obj_get``.</span>
<span class="sd">    Takes optional ``kwargs``, which are used to narrow the query to find</span>
<span class="sd">    the instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># prevents FieldError when looking up nested resources containing extra data</span>
    <span class="n">field_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_all_field_names</span><span class="p">()</span>
    <span class="n">field_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;pk&#39;</span><span class="p">)</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">object_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">stringified_kwargs</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">object_list</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_class</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find an instance of &#39;</span><span class="si">%s</span><span class="s2">&#39; which matched &#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_class</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">stringified_kwargs</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">object_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MultipleObjectsReturned</span><span class="p">(</span><span class="s2">&quot;More than &#39;</span><span class="si">%s</span><span class="s2">&#39; matched &#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_class</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">stringified_kwargs</span><span class="p">))</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">object_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authorized_read_detail</span><span class="p">(</span><span class="n">object_list</span><span class="p">,</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NotFound</span><span class="p">(</span><span class="s2">&quot;Invalid resource lookup data provided (mismatched type).&quot;</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.obj_get_list">
    <p>def <span class="ident">obj_get_list</span>(</p><p>self, bundle, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>A ORM-specific implementation of <code>obj_get_list</code>.</p>
<p>Takes an optional <code>request</code> object, whose <code>GET</code> dictionary can be
used to narrow the query.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.obj_get_list', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.obj_get_list" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">obj_get_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A ORM-specific implementation of ``obj_get_list``.</span>
<span class="sd">    Takes an optional ``request`` object, whose ``GET`` dictionary can be</span>
<span class="sd">    used to narrow the query.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">):</span>
        <span class="c1"># Grab a mutable copy.</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># Update with the provided kwargs.</span>
    <span class="n">filters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">applicable_filters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_filters</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_filters</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">applicable_filters</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">authorized_read_list</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">bundle</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Invalid resource lookup data provided (mismatched type).&quot;</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.obj_update">
    <p>def <span class="ident">obj_update</span>(</p><p>self, bundle, skip_errors=False, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>A ORM-specific implementation of <code>obj_update</code>.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.obj_update', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.obj_update" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">obj_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">skip_errors</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A ORM-specific implementation of ``obj_update``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bundle_detail_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bundle_detail_data</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span>
    <span class="n">arg_detail_data</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">detail_uri_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bundle_detail_data</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">arg_detail_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">bundle_detail_data</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">arg_detail_data</span><span class="p">)):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lookup_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_kwargs_with_identifiers</span><span class="p">(</span><span class="n">bundle</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># if there is trouble hydrating the data, fall back to just</span>
            <span class="c1"># using kwargs by itself (usually it only contains a &quot;pk&quot; key</span>
            <span class="c1"># and this will work fine.</span>
            <span class="n">lookup_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_get</span><span class="p">(</span><span class="n">bundle</span><span class="o">=</span><span class="n">bundle</span><span class="p">,</span> <span class="o">**</span><span class="n">lookup_kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ObjectDoesNotExist</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotFound</span><span class="p">(</span><span class="s2">&quot;A model instance matching the provided arguments could not be found.&quot;</span><span class="p">)</span>
    <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_hydrate</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">bundle</span><span class="p">,</span> <span class="n">skip_errors</span><span class="o">=</span><span class="n">skip_errors</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.override_urls">
    <p>def <span class="ident">override_urls</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Deprecated. Will be removed by v1.0.0. Please use <code>prepend_urls</code> instead.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.override_urls', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.override_urls" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">override_urls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deprecated. Will be removed by v1.0.0. Please use ``prepend_urls`` instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.patch_detail">
    <p>def <span class="ident">patch_detail</span>(</p><p>self, request, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Updates a resource in-place.</p>
<p>Calls <code>obj_update</code>.</p>
<p>If the resource is updated, return <code>HttpAccepted</code> (202 Accepted).
If the resource did not exist, return <code>HttpNotFound</code> (404 Not Found).</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.patch_detail', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.patch_detail" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">patch_detail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates a resource in-place.</span>
<span class="sd">    Calls ``obj_update``.</span>
<span class="sd">    If the resource is updated, return ``HttpAccepted`` (202 Accepted).</span>
<span class="sd">    If the resource did not exist, return ``HttpNotFound`` (404 Not Found).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">convert_post_to_patch</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">basic_bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
    <span class="c1"># We want to be able to validate the update, but we can&#39;t just pass</span>
    <span class="c1"># the partial data into the validator since all data needs to be</span>
    <span class="c1"># present. Instead, we basically simulate a PUT by pulling out the</span>
    <span class="c1"># original data and updating it in-place.</span>
    <span class="c1"># So first pull out the original object. This is essentially</span>
    <span class="c1"># ``get_detail``.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cached_obj_get</span><span class="p">(</span><span class="n">bundle</span><span class="o">=</span><span class="n">basic_bundle</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_api_resource_names</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">ObjectDoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="n">HttpNotFound</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">MultipleObjectsReturned</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="n">HttpMultipleChoices</span><span class="p">(</span><span class="s2">&quot;More than one resource is found at this URI.&quot;</span><span class="p">)</span>
    <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
    <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_dehydrate</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span>
    <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_detail_data_to_serialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">bundle</span><span class="p">)</span>
    <span class="c1"># Now update the bundle in-place.</span>
    <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update_in_place</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">always_return_data</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="n">HttpAccepted</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Invalidate prefetched_objects_cache for bundled object</span>
        <span class="c1"># because we might have changed a prefetched field</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">_prefetched_objects_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_dehydrate</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_detail_data_to_serialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">bundle</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">http</span><span class="o">.</span><span class="n">HttpAccepted</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.patch_dict">
    <p>def <span class="ident">patch_dict</span>(</p><p>self, dictdata, headers)</p>
    </div>
    

    
  
    <div class="desc"><p>Apply a JSON patch to the data in a particular column</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.patch_dict', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.patch_dict" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">patch_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictdata</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply a JSON patch to the data in a particular column&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
        <span class="n">json_patches</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operations&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">json_patches</span><span class="p">:</span>
            <span class="n">apply_json_patch</span><span class="p">(</span><span class="n">dictdata</span><span class="p">,</span> <span class="n">json_patches</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.patch_list">
    <p>def <span class="ident">patch_list</span>(</p><p>*args, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>An ORM-specific implementation of <code>patch_list</code>.</p>
<p>Necessary because PATCH should be atomic (all-success or all-fail)
and the only way to do this neatly is at the database level.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.patch_list', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.patch_list" class="source">
    <div class="codehilite"><pre><span></span><span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">assigned</span><span class="o">=</span><span class="n">available_attrs</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.post_detail">
    <p>def <span class="ident">post_detail</span>(</p><p>self, request, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Creates a new subcollection of the resource under a resource.</p>
<p>This is not implemented by default because most people's data models
aren't self-referential.</p>
<p>If a new resource is created, return <code>HttpCreated</code> (201 Created).</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.post_detail', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.post_detail" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">post_detail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a new subcollection of the resource under a resource.</span>
<span class="sd">    This is not implemented by default because most people&#39;s data models</span>
<span class="sd">    aren&#39;t self-referential.</span>
<span class="sd">    If a new resource is created, return ``HttpCreated`` (201 Created).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="n">HttpNotImplemented</span><span class="p">()</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.post_list">
    <p>def <span class="ident">post_list</span>(</p><p>self, request, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Creates a new resource/object with the provided data.</p>
<p>Calls <code>obj_create</code> with the provided data and returns a response
with the new resource's location.</p>
<p>If a new resource is created, return <code>HttpCreated</code> (201 Created).
If <code>Meta.always_return_data = True</code>, there will be a populated body
of serialized data.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.post_list', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.post_list" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">post_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a new resource/object with the provided data.</span>
<span class="sd">    Calls ``obj_create`` with the provided data and returns a response</span>
<span class="sd">    with the new resource&#39;s location.</span>
<span class="sd">    If a new resource is created, return ``HttpCreated`` (201 Created).</span>
<span class="sd">    If ``Meta.always_return_data = True``, there will be a populated body</span>
<span class="sd">    of serialized data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">))</span>
    <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_deserialized_detail_data</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">)</span>
    <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dict_strip_unicode_keys</span><span class="p">(</span><span class="n">deserialized</span><span class="p">),</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
    <span class="n">updated_bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_create</span><span class="p">(</span><span class="n">bundle</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_api_resource_names</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
    <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_resource_uri</span><span class="p">(</span><span class="n">updated_bundle</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">always_return_data</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="n">HttpCreated</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">updated_bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_dehydrate</span><span class="p">(</span><span class="n">updated_bundle</span><span class="p">)</span>
        <span class="n">updated_bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_detail_data_to_serialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">updated_bundle</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">updated_bundle</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">http</span><span class="o">.</span><span class="n">HttpCreated</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.post_validate_drawn">
    <p>def <span class="ident">post_validate_drawn</span>(</p><p>self, request, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Turn a drawn molfile via chemdoodle into a processable 
rdkit mol to be used by the rest of the architecture</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.post_validate_drawn', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.post_validate_drawn" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">post_validate_drawn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Turn a drawn molfile via chemdoodle into a processable </span>
<span class="sd">    rdkit mol to be used by the rest of the architecture</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">))</span>
    <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_deserialized_detail_data</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">)</span>
    <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">dict_strip_unicode_keys</span><span class="p">(</span><span class="n">deserialized</span><span class="p">),</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authorized_update_detail</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authorized_create_detail</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
    <span class="c1">#now get the SDfile from the request</span>
    <span class="n">ctab</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sketch&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="c1"># first assume ctab</span>
    <span class="c1"># allmols = [(obj, Chem.MolFromSmiles(str(obj))) for obj in objects]</span>
    <span class="c1"># we need to make allmols a single-entry list in order to use the rst of the architecture</span>
    <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromMolBlock</span><span class="p">(</span><span class="n">ctab</span><span class="p">)</span>
    <span class="c1">#for each of the supplied custom fields, use set prop to replicate how this would be if it was an sd file.</span>
    <span class="n">prj_data_fields</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;custom_fields&#39;</span><span class="p">,{})</span>
    <span class="n">sup_data_fields</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;supplementary_fields&#39;</span><span class="p">,[])</span>
    <span class="k">if</span><span class="p">(</span><span class="n">mol</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k1</span><span class="p">,</span> <span class="n">v1</span> <span class="ow">in</span> <span class="n">prj_data_fields</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="n">v1str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">v1</span><span class="p">:</span>
                    <span class="n">v1str</span> <span class="o">=</span> <span class="n">v1str</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
                <span class="n">mol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="n">k1</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">),</span> <span class="n">v1str</span><span class="p">)</span>
            <span class="c1">#not a unicode string? Don&#39;t try and ascii encode the result, </span>
            <span class="c1">#just add it as a value converted to a string (which SetProp expects)</span>
            <span class="k">elif</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">True</span><span class="p">):</span>
                <span class="n">mol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="n">k1</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">v1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="n">k1</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">),</span> <span class="n">v1</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">sup_data_fields</span><span class="p">:</span>
            <span class="n">mol</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">),</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">))</span>
    
    <span class="n">allmols</span> <span class="o">=</span> <span class="p">[</span> <span class="n">mol</span> <span class="p">]</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">batches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">multiple_batch</span> <span class="o">=</span> <span class="n">CBHCompoundMultipleBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">from_rd_mol</span><span class="p">(</span>
            <span class="n">mol</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">],</span> <span class="n">orig_ctab</span><span class="o">=</span><span class="n">ctab</span><span class="p">)</span>
        <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">blinded</span><span class="p">(</span>
                        <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
        <span class="n">b</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;parseerror&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
        <span class="n">b</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ignore&quot;</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
    <span class="n">b</span><span class="o">.</span><span class="n">custom_fields</span> <span class="o">=</span> <span class="n">prj_data_fields</span>
    <span class="n">b</span><span class="o">.</span><span class="n">uncurated_fields</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1">#iterate the supplementary fields</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">sup_data_fields</span><span class="p">:</span>
        <span class="n">b</span><span class="o">.</span><span class="n">uncurated_fields</span><span class="p">[</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
    <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;current_batch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">multiple_batch</span><span class="o">.</span><span class="n">pk</span>
    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">errors</span>
    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_multi_batch</span><span class="p">(</span><span class="n">multiple_batch</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">batches</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.post_validate_files">
    <p>def <span class="ident">post_validate_files</span>(</p><p>self, request, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Receive a CBHFlowFile ID which points at an uploaded SDF, XLSX or CDX file
Perform validation on the file's contents and then send the resultant elasticsearch index
to the validate mult batch method
More about data import information can be found in the wiki</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.post_validate_files', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.post_validate_files" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">post_validate_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Receive a CBHFlowFile ID which points at an uploaded SDF, XLSX or CDX file</span>
<span class="sd">    Perform validation on the file&#39;s contents and then send the resultant elasticsearch index</span>
<span class="sd">    to the validate mult batch method</span>
<span class="sd">    More about data import information can be found in the wiki</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">automapped_structure</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">))</span>
    <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_deserialized_detail_data</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">)</span>
    <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">dict_strip_unicode_keys</span><span class="p">(</span><span class="n">deserialized</span><span class="p">),</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">authorized_create_detail</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span>
    <span class="n">session_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">COOKIES</span><span class="p">[</span><span class="n">settings</span><span class="o">.</span><span class="n">SESSION_COOKIE_NAME</span><span class="p">]</span>
    <span class="n">correct_file</span> <span class="o">=</span> <span class="n">CBHFlowFile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="n">identifier</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">session_key</span><span class="p">,</span> <span class="n">file_name</span><span class="p">))</span>
    <span class="n">batches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fielderrors</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">fielderrors</span><span class="p">[</span><span class="s2">&quot;stringdate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
    <span class="n">fielderrors</span><span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
    <span class="n">fielderrors</span><span class="p">[</span><span class="s2">&quot;integer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
    <span class="n">structure_col</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;struccol&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;.cdx&quot;</span> <span class="ow">in</span> <span class="n">correct_file</span><span class="o">.</span><span class="n">extension</span><span class="p">):</span>
        <span class="n">mols</span> <span class="o">=</span> <span class="p">[</span><span class="n">mol</span> <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">readfile</span><span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">correct_file</span><span class="o">.</span><span class="n">extension</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">correct_file</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="p">)]</span>
        <span class="n">rxn</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">correct_file</span><span class="o">.</span><span class="n">extension</span> <span class="o">==</span> <span class="s1">&#39;.cdxml&#39;</span><span class="p">:</span>
            <span class="c1"># Look for a stoichiometry table in the reaction file</span>
            <span class="n">rxn</span> <span class="o">=</span> <span class="n">chemdraw_reaction</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">correct_file</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;%Completion&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;%Yield&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Expected Moles&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Product Moles&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Expected Mass&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Product Mass&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;MW&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;role&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Purity&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Limit Moles&quot;</span><span class="p">,</span>
                       <span class="c1"># &quot;Formula&quot;,</span>
                       <span class="s2">&quot;Equivalents&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Measured Mass&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">pybelmol</span> <span class="ow">in</span> <span class="n">mols</span><span class="p">:</span>
            <span class="n">molfile</span> <span class="o">=</span> <span class="n">pybelmol</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;mdl&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">molfile</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="n">molfile</span> <span class="o">!=</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span>
                <span class="n">rd_mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromMolBlock</span><span class="p">(</span><span class="n">molfile</span><span class="p">,</span> <span class="n">sanitize</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                Pybel can read some hypervalent molecules that RDKit cannot read</span>
<span class="sd">                Therefore currently these molecules are outputted as images and sent back to the front end</span>
<span class="sd">                https://www.mail-archive.com/rdkit-discuss@lists.sourceforge.net/msg04466.html</span>
<span class="sd">                &#39;&#39;&#39;</span>
                <span class="k">if</span> <span class="n">rd_mol</span><span class="p">:</span>
                    <span class="n">smiles</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolToSmiles</span><span class="p">(</span><span class="n">rd_mol</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">smiles</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">from_rd_mol</span><span class="p">(</span>
                                <span class="n">rd_mol</span><span class="p">,</span> <span class="n">orig_ctab</span><span class="o">=</span><span class="n">molfile</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="n">smiles</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">b</span> <span class="o">=</span> <span class="bp">None</span>
                            <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">b</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">rxn</span><span class="p">:</span>
                                <span class="c1"># Here we set the uncurated fields equal to</span>
                                <span class="c1"># the reaction data extracted from Chemdraw</span>
                                <span class="n">b</span><span class="o">.</span><span class="n">uncurated_fields</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                    <span class="n">pybelmol</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="p">{})</span>
                            <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">pybelmol</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                <span class="s2">&quot;svg&quot;</span><span class="p">),</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Unable to produce inchi from this molecule&quot;</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">pybelmol</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="s2">&quot;svg&quot;</span><span class="p">),</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid valency or other error parsing this molecule&quot;</span><span class="p">})</span>
                <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">correct_file</span><span class="o">.</span><span class="n">extension</span> <span class="o">==</span> <span class="s2">&quot;.sdf&quot;</span><span class="p">):</span>
            <span class="c1"># read in the file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_sdf_file</span><span class="p">(</span><span class="n">correct_file</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
            <span class="n">suppl</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">ForwardSDMolSupplier</span><span class="p">(</span><span class="n">correct_file</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
            <span class="n">mols</span> <span class="o">=</span> <span class="p">[</span><span class="n">mo</span> <span class="k">for</span> <span class="n">mo</span> <span class="ow">in</span> <span class="n">suppl</span><span class="p">]</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;file_too_large&quot;</span><span class="p">)</span>
            <span class="c1"># read the headers from the first molecule</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="n">get_all_sdf_headers</span><span class="p">(</span><span class="n">correct_file</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">uncurated</span><span class="p">,</span> <span class="n">ctabs</span> <span class="o">=</span> <span class="n">get_uncurated_fields_from_file</span><span class="p">(</span><span class="n">correct_file</span><span class="p">,</span> <span class="n">fielderrors</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">mol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mols</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">blinded</span><span class="p">(</span>
                        <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
                    <span class="n">b</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;parseerror&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
                    <span class="n">b</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ignore&quot;</span>
                    <span class="n">b</span><span class="o">.</span><span class="n">uncurated_fields</span> <span class="o">=</span> <span class="n">uncurated</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>  <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;No structure found&quot;</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">from_rd_mol</span><span class="p">(</span>
                            <span class="n">mol</span><span class="p">,</span> <span class="n">orig_ctab</span><span class="o">=</span><span class="n">ctabs</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">blinded</span><span class="p">(</span>
                        <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
                        <span class="n">b</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;parseerror&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
                        <span class="n">b</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ignore&quot;</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>  <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
                   
                    <span class="n">b</span><span class="o">.</span><span class="n">uncurated_fields</span> <span class="o">=</span> <span class="n">uncurated</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">correct_file</span><span class="o">.</span><span class="n">extension</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;.xls&quot;</span><span class="p">,</span> <span class="s2">&quot;.xlsx&quot;</span><span class="p">)):</span>
            <span class="c1"># we need to know which column contains structural info - this needs to be defined on the mapping page and passed here</span>
            <span class="c1"># read in the specified structural column</span>
            <span class="n">headerswithdata</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">correct_file</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;no_headers&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;file_too_large&quot;</span><span class="p">)</span>
            <span class="c1"># read the smiles string value out of here, when we know which</span>
            <span class="c1"># column it is.</span>
            <span class="n">row_iterator</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;__&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">]</span>
            <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">headers</span>
            <span class="c1"># Only automap on the first attempt at mapping the smiles</span>
                <span class="c1"># column</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">structure_col</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;headers&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
                <span class="n">max_score</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
                    <span class="c1"># fuzzy matching for smiles - this should also</span>
                    <span class="c1"># match things like &quot;canonical_smiles&quot;</span>
                    <span class="n">hdr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[^0-9a-zA-Z]+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hdr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">):</span>
                        <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">h</span><span class="p">:</span>
                            <span class="n">score</span> <span class="o">=</span> <span class="n">fuzzymatch</span><span class="p">(</span>
                                <span class="n">a</span><span class="o">=</span><span class="s2">&quot;smiles&quot;</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">max_score</span> <span class="ow">and</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">:</span>
                                <span class="n">structure_col</span> <span class="o">=</span> <span class="n">header</span>
                                <span class="n">max_score</span> <span class="o">=</span> <span class="n">score</span>
                                <span class="n">automapped_structure</span> <span class="o">=</span> <span class="bp">True</span>
            
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">row_iterator</span><span class="p">:</span>
                
                <span class="k">if</span> <span class="n">structure_col</span><span class="p">:</span>
                    <span class="n">smiles_str</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">structure_col</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">struc</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles_str</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">struc</span><span class="p">:</span>
                            <span class="n">Compute2DCoords</span><span class="p">(</span><span class="n">struc</span><span class="p">)</span>
                            <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">from_rd_mol</span><span class="p">(</span>
                                <span class="n">struc</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="n">smiles_str</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">],</span> <span class="n">reDraw</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                            <span class="n">b</span><span class="o">.</span><span class="n">blinded_batch_id</span> <span class="o">=</span> <span class="bp">None</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Smiles not processed&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">blinded</span><span class="p">(</span>
                            <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
                        <span class="n">b</span><span class="o">.</span><span class="n">original_smiles</span> <span class="o">=</span> <span class="n">smiles_str</span>
                        <span class="n">b</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;parseerror&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
                        <span class="n">b</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ignore&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">blinded</span><span class="p">(</span>
                        <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">dict</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">uncurated_fields</span><span class="p">)</span> <span class="o">==</span> <span class="p">{}:</span>
                        <span class="c1"># Only rebuild the uncurated fields if this has not</span>
                        <span class="c1"># been done before</span>
                    <span class="n">parse_pandas_record</span><span class="p">(</span>
                            <span class="n">headers</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="s2">&quot;uncurated_fields&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">fielderrors</span><span class="p">,</span> <span class="n">headerswithdata</span><span class="p">)</span>
               
                <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="n">hdr</span> <span class="k">for</span> <span class="n">hdr</span> <span class="ow">in</span> <span class="n">headers</span> <span class="k">if</span> <span class="n">hdr</span> <span class="ow">in</span> <span class="n">headerswithdata</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;file_format_error&quot;</span><span class="p">)</span>
    <span class="n">multiple_batch</span> <span class="o">=</span> <span class="n">CBHCompoundMultipleBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">],</span>
            <span class="n">uploaded_file</span><span class="o">=</span><span class="n">correct_file</span>
        <span class="p">)</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batches</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">b</span><span class="p">:</span>
            <span class="n">b</span><span class="o">.</span><span class="n">multiple_batch_id</span> <span class="o">=</span> <span class="n">multiple_batch</span><span class="o">.</span><span class="n">pk</span>
            <span class="n">b</span><span class="o">.</span><span class="n">created_by</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span>
    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;fileerrors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">errors</span>
    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;automapped&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cfr</span> <span class="o">=</span> <span class="n">ChemRegCustomFieldConfigResource</span><span class="p">()</span>
    <span class="n">jsondata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cfr</span><span class="o">.</span><span class="n">get_detail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
        <span class="n">pk</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">custom_field_config_id</span><span class="p">)</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
    <span class="n">schemaform</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="p">[</span><span class="s2">&quot;edit_form&quot;</span><span class="p">][</span><span class="s2">&quot;form&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">jsondata</span><span class="p">[</span><span class="s2">&quot;project_data_fields&quot;</span><span class="p">]]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;headers&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">copyto</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">automapped</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">operations</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">header</span> <span class="o">==</span> <span class="n">structure_col</span><span class="p">:</span>
                <span class="n">copyto</span> <span class="o">=</span> <span class="s2">&quot;SMILES for chemical structures&quot;</span>
                <span class="k">if</span> <span class="n">automapped_structure</span><span class="p">:</span>
                    <span class="n">automapped</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">schemaform</span><span class="p">)</span>
                <span class="n">copyto</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">max_score</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">form_item</span> <span class="ow">in</span> <span class="n">form</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="n">fuzzymatch</span><span class="p">(</span>
                        <span class="n">a</span><span class="o">=</span><span class="n">form_item</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">b</span><span class="o">=</span><span class="n">header</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">max_score</span> <span class="ow">and</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">:</span>
                        <span class="n">matched_item</span> <span class="o">=</span> <span class="n">form_item</span>
                        <span class="n">copyto</span> <span class="o">=</span> <span class="n">matched_item</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span>
                        <span class="n">automapped</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="k">if</span><span class="p">(</span><span class="n">matched_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;field_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;uiselecttags&quot;</span><span class="p">):</span>
                            <span class="n">operations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">{</span><span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="s2">&quot;split&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/uncurated_fields/&quot;</span> <span class="o">+</span> <span class="n">header</span><span class="p">})</span>
                            <span class="n">operations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">{</span><span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="s2">&quot;move&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/custom_fields/&quot;</span> <span class="o">+</span> <span class="n">matched_item</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">],</span> <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;/uncurated_fields/&quot;</span> <span class="o">+</span> <span class="n">header</span><span class="p">})</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">operation</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="s2">&quot;move&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/custom_fields/&quot;</span> <span class="o">+</span> <span class="n">matched_item</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">],</span> <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;/uncurated_fields/&quot;</span> <span class="o">+</span> <span class="n">header</span><span class="p">}</span>
                            <span class="n">operations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">operation</span><span class="p">)</span>
                            <span class="k">if</span><span class="p">(</span><span class="n">matched_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;format&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;date&quot;</span><span class="p">):</span>
                                <span class="n">operations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="p">{</span><span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="s2">&quot;convertdate&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/custom_fields/&quot;</span> <span class="o">+</span> <span class="n">matched_item</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]})</span>
                        <span class="c1">#set the max score so less well matched content than this is ignored</span>
                        <span class="n">max_score</span> <span class="o">=</span> <span class="n">score</span>
            <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">header</span><span class="p">,</span>
                <span class="s2">&quot;automapped&quot;</span><span class="p">:</span> <span class="n">automapped</span><span class="p">,</span>
                <span class="s2">&quot;copyto&quot;</span><span class="p">:</span> <span class="n">copyto</span><span class="p">,</span>
                <span class="s2">&quot;operations&quot;</span><span class="p">:</span> <span class="n">operations</span><span class="p">,</span>
                <span class="s2">&quot;fieldErrors&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;stringdate&quot;</span><span class="p">:</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">fielderrors</span><span class="p">[</span><span class="s2">&quot;stringdate&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;integer&quot;</span><span class="p">:</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">fielderrors</span><span class="p">[</span><span class="s2">&quot;integer&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">fielderrors</span><span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">})</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_multi_batch</span><span class="p">(</span><span class="n">multiple_batch</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">batches</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.post_validate_list">
    <p>def <span class="ident">post_validate_list</span>(</p><p>self, request, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>When a list of SMILES patterns are submitted, save them to elasticsearhc and
call the normal validate multi batch function to give the normal statistics page</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.post_validate_list', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.post_validate_list" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">post_validate_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    When a list of SMILES patterns are submitted, save them to elasticsearhc and</span>
<span class="sd">    call the normal validate multi batch function to give the normal statistics page</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">))</span>
    <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_deserialized_detail_data</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">)</span>
    <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">dict_strip_unicode_keys</span><span class="p">(</span><span class="n">deserialized</span><span class="p">),</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authorized_update_detail</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authorized_create_detail</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
    <span class="n">smilesdata</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;smilesdata&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="p">[</span><span class="n">smi</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">smi</span> <span class="ow">in</span> <span class="n">smilesdata</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="bp">True</span><span class="p">)]</span>
    <span class="n">batches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># first assume smiles</span>
    <span class="n">allmols</span> <span class="o">=</span> <span class="p">[(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)))</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">]</span>
    <span class="c1"># Next test for inchi</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">allmols</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">inchimol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromInchi</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">inchimol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">allmols</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">MolToSmiles</span><span class="p">(</span><span class="n">inchimol</span><span class="p">),</span> <span class="n">inchimol</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">allmols</span><span class="p">:</span>
        <span class="k">if</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">Compute2DCoords</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">batches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">multiple_batch</span> <span class="o">=</span> <span class="n">CBHCompoundMultipleBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">mol2</span> <span class="ow">in</span> <span class="n">allmols</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mol2</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">from_rd_mol</span><span class="p">(</span>
                <span class="n">mol2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">smiles</span><span class="o">=</span><span class="n">mol2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">],</span> <span class="n">reDraw</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">CBHCompoundBatch</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">blinded</span><span class="p">(</span>
                <span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
            <span class="n">b</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;smilesParseError&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
            <span class="n">b</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ignore&quot;</span>
            <span class="n">b</span><span class="o">.</span><span class="n">original_smiles</span> <span class="o">=</span> <span class="n">mol2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">b</span><span class="o">.</span><span class="n">multiple_batch_id</span> <span class="o">=</span> <span class="n">multiple_batch</span><span class="o">.</span><span class="n">pk</span>
        <span class="n">b</span><span class="o">.</span><span class="n">created_by</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span>
        <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;current_batch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">multiple_batch</span><span class="o">.</span><span class="n">pk</span>
    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_multi_batch</span><span class="p">(</span><span class="n">multiple_batch</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">batches</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.prepend_urls">
    <p>def <span class="ident">prepend_urls</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Add lots of extra methods to the API</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.prepend_urls', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.prepend_urls" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">prepend_urls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add lots of extra methods to the API&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">url</span><span class="p">(</span><span class="s2">r&quot;^(?P&lt;resource_name&gt;</span><span class="si">%s</span><span class="s2">)/delete_index/?$&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wrap_view</span><span class="p">(</span><span class="s1">&#39;delete_index&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;delete_index&quot;</span><span class="p">),</span>
        <span class="n">url</span><span class="p">(</span><span class="s2">r&quot;^(?P&lt;resource_name&gt;</span><span class="si">%s</span><span class="s2">)/update_temp_batches/?$&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wrap_view</span><span class="p">(</span><span class="s1">&#39;update_temp_batches&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;update_temp_batches&quot;</span><span class="p">),</span>
        <span class="n">url</span><span class="p">(</span><span class="s2">r&quot;^(?P&lt;resource_name&gt;</span><span class="si">%s</span><span class="s2">)/get_part_processed_multiple_batch/?$&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wrap_view</span><span class="p">(</span><span class="s1">&#39;get_part_processed_multiple_batch&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;api_get_part_processed_multiple_batch&quot;</span><span class="p">),</span>
        <span class="n">url</span><span class="p">(</span><span class="s2">r&quot;^(?P&lt;resource_name&gt;</span><span class="si">%s</span><span class="s2">)/validate_list/?$&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wrap_view</span><span class="p">(</span><span class="s1">&#39;post_validate_list&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;api_validate_compound_list&quot;</span><span class="p">),</span>
        <span class="n">url</span><span class="p">(</span><span class="s2">r&quot;^(?P&lt;resource_name&gt;</span><span class="si">%s</span><span class="s2">)/validate_drawn/?$&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wrap_view</span><span class="p">(</span><span class="s1">&#39;post_validate_drawn&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;api_validate_compound_drawn&quot;</span><span class="p">),</span>
        <span class="n">url</span><span class="p">(</span><span class="s2">r&quot;^(?P&lt;resource_name&gt;</span><span class="si">%s</span><span class="s2">)/multi_batch_save/?$&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wrap_view</span><span class="p">(</span><span class="s1">&#39;multi_batch_save&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;multi_batch_save&quot;</span><span class="p">),</span>
        <span class="n">url</span><span class="p">(</span><span class="s2">r&quot;^(?P&lt;resource_name&gt;</span><span class="si">%s</span><span class="s2">)/multi_batch_custom_fields/?$&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wrap_view</span><span class="p">(</span><span class="s1">&#39;multi_batch_custom_fields&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;multi_batch_custom_fields&quot;</span><span class="p">),</span>
        <span class="n">url</span><span class="p">(</span><span class="s2">r&quot;^(?P&lt;resource_name&gt;</span><span class="si">%s</span><span class="s2">)/validate_files/?$&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wrap_view</span><span class="p">(</span><span class="s1">&#39;post_validate_files&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;api_compound_validate_files&quot;</span><span class="p">),]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.preprocess_sdf_file">
    <p>def <span class="ident">preprocess_sdf_file</span>(</p><p>self, file_obj, request)</p>
    </div>
    

    
  
    <div class="desc"><p>Read the input SDF file and add some extra information to it</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.preprocess_sdf_file', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.preprocess_sdf_file" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">preprocess_sdf_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_obj</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read the input SDF file and add some extra information to it&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.put_detail">
    <p>def <span class="ident">put_detail</span>(</p><p>self, request, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Either updates an existing resource or creates a new one with the
provided data.</p>
<p>Calls <code>obj_update</code> with the provided data first, but falls back to
<code>obj_create</code> if the object does not already exist.</p>
<p>If a new resource is created, return <code>HttpCreated</code> (201 Created).
If <code>Meta.always_return_data = True</code>, there will be a populated body
of serialized data.</p>
<p>If an existing resource is modified and
<code>Meta.always_return_data = False</code> (default), return <code>HttpNoContent</code>
(204 No Content).
If an existing resource is modified and
<code>Meta.always_return_data = True</code>, return <code>HttpAccepted</code> (200
OK).</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.put_detail', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.put_detail" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">put_detail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Either updates an existing resource or creates a new one with the</span>
<span class="sd">    provided data.</span>
<span class="sd">    Calls ``obj_update`` with the provided data first, but falls back to</span>
<span class="sd">    ``obj_create`` if the object does not already exist.</span>
<span class="sd">    If a new resource is created, return ``HttpCreated`` (201 Created).</span>
<span class="sd">    If ``Meta.always_return_data = True``, there will be a populated body</span>
<span class="sd">    of serialized data.</span>
<span class="sd">    If an existing resource is modified and</span>
<span class="sd">    ``Meta.always_return_data = False`` (default), return ``HttpNoContent``</span>
<span class="sd">    (204 No Content).</span>
<span class="sd">    If an existing resource is modified and</span>
<span class="sd">    ``Meta.always_return_data = True``, return ``HttpAccepted`` (200</span>
<span class="sd">    OK).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">))</span>
    <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_deserialized_detail_data</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">)</span>
    <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dict_strip_unicode_keys</span><span class="p">(</span><span class="n">deserialized</span><span class="p">),</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">updated_bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_update</span><span class="p">(</span><span class="n">bundle</span><span class="o">=</span><span class="n">bundle</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_api_resource_names</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">always_return_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="n">HttpNoContent</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Invalidate prefetched_objects_cache for bundled object</span>
            <span class="c1"># because we might have changed a prefetched field</span>
            <span class="n">updated_bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">_prefetched_objects_cache</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">updated_bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_dehydrate</span><span class="p">(</span><span class="n">updated_bundle</span><span class="p">)</span>
            <span class="n">updated_bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_detail_data_to_serialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">updated_bundle</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">updated_bundle</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">NotFound</span><span class="p">,</span> <span class="n">MultipleObjectsReturned</span><span class="p">):</span>
        <span class="n">updated_bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_create</span><span class="p">(</span><span class="n">bundle</span><span class="o">=</span><span class="n">bundle</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_api_resource_names</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_resource_uri</span><span class="p">(</span><span class="n">updated_bundle</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">always_return_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="n">HttpCreated</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">updated_bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_dehydrate</span><span class="p">(</span><span class="n">updated_bundle</span><span class="p">)</span>
            <span class="n">updated_bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_detail_data_to_serialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">updated_bundle</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">updated_bundle</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">http</span><span class="o">.</span><span class="n">HttpCreated</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.put_list">
    <p>def <span class="ident">put_list</span>(</p><p>self, request, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Replaces a collection of resources with another collection.</p>
<p>Calls <code>delete_list</code> to clear out the collection then <code>obj_create</code>
with the provided the data to create the new collection.</p>
<p>Return <code>HttpNoContent</code> (204 No Content) if
<code>Meta.always_return_data = False</code> (default).</p>
<p>Return <code>HttpAccepted</code> (200 OK) if
<code>Meta.always_return_data = True</code>.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.put_list', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.put_list" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">put_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replaces a collection of resources with another collection.</span>
<span class="sd">    Calls ``delete_list`` to clear out the collection then ``obj_create``</span>
<span class="sd">    with the provided the data to create the new collection.</span>
<span class="sd">    Return ``HttpNoContent`` (204 No Content) if</span>
<span class="sd">    ``Meta.always_return_data = False`` (default).</span>
<span class="sd">    Return ``HttpAccepted`` (200 OK) if</span>
<span class="sd">    ``Meta.always_return_data = True``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">))</span>
    <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_deserialized_list_data</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">collection_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">deserialized</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Invalid data sent: missing &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">collection_name</span><span class="p">)</span>
    <span class="n">basic_bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">obj_delete_list_for_update</span><span class="p">(</span><span class="n">bundle</span><span class="o">=</span><span class="n">basic_bundle</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_api_resource_names</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
    <span class="n">bundles_seen</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">object_data</span> <span class="ow">in</span> <span class="n">deserialized</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">collection_name</span><span class="p">]:</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dict_strip_unicode_keys</span><span class="p">(</span><span class="n">object_data</span><span class="p">),</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
        <span class="c1"># Attempt to be transactional, deleting any previously created</span>
        <span class="c1"># objects if validation fails.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obj_create</span><span class="p">(</span><span class="n">bundle</span><span class="o">=</span><span class="n">bundle</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_api_resource_names</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
            <span class="n">bundles_seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ImmediateHttpResponse</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span><span class="p">(</span><span class="n">bundles_seen</span><span class="p">)</span>
            <span class="k">raise</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">always_return_data</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="n">HttpNoContent</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">to_be_serialized</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">collection_name</span><span class="p">:</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">full_dehydrate</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">for_list</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bundles_seen</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="n">to_be_serialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_list_data_to_serialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">to_be_serialized</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">to_be_serialized</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.remove_api_resource_names">
    <p>def <span class="ident">remove_api_resource_names</span>(</p><p>self, url_dict)</p>
    </div>
    

    
  
    <div class="desc"><p>Given a dictionary of regex matches from a URLconf, removes
<code>api_name</code> and/or <code>resource_name</code> if found.</p>
<p>This is useful for converting URLconf matches into something suitable
for data lookup. For example::</p>
<div class="codehilite"><pre><span></span>Model.objects.filter(**self.remove_api_resource_names(matches))
</pre></div></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.remove_api_resource_names', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.remove_api_resource_names" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">remove_api_resource_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url_dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a dictionary of regex matches from a URLconf, removes</span>
<span class="sd">    ``api_name`` and/or ``resource_name`` if found.</span>
<span class="sd">    This is useful for converting URLconf matches into something suitable</span>
<span class="sd">    for data lookup. For example::</span>
<span class="sd">        Model.objects.filter(**self.remove_api_resource_names(matches))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs_subset</span> <span class="o">=</span> <span class="n">url_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;api_name&#39;</span><span class="p">,</span> <span class="s1">&#39;resource_name&#39;</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span><span class="p">(</span><span class="n">kwargs_subset</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">kwargs_subset</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.resource_uri_kwargs">
    <p>def <span class="ident">resource_uri_kwargs</span>(</p><p>self, bundle_or_obj=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Builds a dictionary of kwargs to help generate URIs.</p>
<p>Automatically provides the <code>Resource.Meta.resource_name</code> (and
optionally the <code>Resource.Meta.api_name</code> if populated by an <code>Api</code>
object).</p>
<p>If the <code>bundle_or_obj</code> argument is provided, it calls
<code>Resource.detail_uri_kwargs</code> for additional bits to create</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.resource_uri_kwargs', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.resource_uri_kwargs" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">resource_uri_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle_or_obj</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Builds a dictionary of kwargs to help generate URIs.</span>
<span class="sd">    Automatically provides the ``Resource.Meta.resource_name`` (and</span>
<span class="sd">    optionally the ``Resource.Meta.api_name`` if populated by an ``Api``</span>
<span class="sd">    object).</span>
<span class="sd">    If the ``bundle_or_obj`` argument is provided, it calls</span>
<span class="sd">    ``Resource.detail_uri_kwargs`` for additional bits to create</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;resource_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">resource_name</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">api_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;api_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">api_name</span>
    <span class="k">if</span> <span class="n">bundle_or_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detail_uri_kwargs</span><span class="p">(</span><span class="n">bundle_or_obj</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">kwargs</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.rollback">
    <p>def <span class="ident">rollback</span>(</p><p>self, bundles)</p>
    </div>
    

    
  
    <div class="desc"><p>A ORM-specific implementation of <code>rollback</code>.</p>
<p>Given the list of bundles, delete all models pertaining to those
bundles.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.rollback', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.rollback" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundles</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A ORM-specific implementation of ``rollback``.</span>
<span class="sd">    Given the list of bundles, delete all models pertaining to those</span>
<span class="sd">    bundles.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">bundle</span> <span class="ow">in</span> <span class="n">bundles</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bundle_detail_data</span><span class="p">(</span><span class="n">bundle</span><span class="p">):</span>
            <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.save">
    <p>def <span class="ident">save</span>(</p><p>self, bundle, skip_errors=False)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.save', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.save" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">skip_errors</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">via_uri</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">bundle</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">errors</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">skip_errors</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ImmediateHttpResponse</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">error_response</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">bundle</span><span class="o">.</span><span class="n">errors</span><span class="p">))</span>
    <span class="c1"># Check if they&#39;re authorized.</span>
    <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authorized_update_detail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authorized_create_detail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
    <span class="c1"># Save FKs just in case.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_related</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span>
    <span class="c1"># Save the main object.</span>
    <span class="n">obj_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_identifier</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">obj_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bundle</span><span class="o">.</span><span class="n">objects_saved</span> <span class="ow">or</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">adding</span><span class="p">:</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">objects_saved</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj_id</span><span class="p">)</span>
    <span class="c1"># Now pick up the M2M bits.</span>
    <span class="n">m2m_bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hydrate_m2m</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_m2m</span><span class="p">(</span><span class="n">m2m_bundle</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bundle</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.save_m2m">
    <p>def <span class="ident">save_m2m</span>(</p><p>self, bundle)</p>
    </div>
    

    
  
    <div class="desc"><p>Handles the saving of related M2M data.</p>
<p>Due to the way Django works, the M2M data must be handled after the
main instance, which is why this isn't a part of the main <code>save</code> bits.</p>
<p>Currently slightly inefficient in that it will clear out the whole
relation and recreate the related data as needed.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.save_m2m', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.save_m2m" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_m2m</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles the saving of related M2M data.</span>
<span class="sd">    Due to the way Django works, the M2M data must be handled after the</span>
<span class="sd">    main instance, which is why this isn&#39;t a part of the main ``save`` bits.</span>
<span class="sd">    Currently slightly inefficient in that it will clear out the whole</span>
<span class="sd">    relation and recreate the related data as needed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_object</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field_object</span><span class="o">.</span><span class="n">is_m2m</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field_object</span><span class="o">.</span><span class="n">attribute</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">field_object</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># Get the manager.</span>
        <span class="n">related_mngr</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_object</span><span class="o">.</span><span class="n">attribute</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">related_mngr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">field_object</span><span class="o">.</span><span class="n">attribute</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">field_object</span><span class="o">.</span><span class="n">attribute</span><span class="p">):</span>
            <span class="n">related_mngr</span> <span class="o">=</span> <span class="n">field_object</span><span class="o">.</span><span class="n">attribute</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">related_mngr</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">related_mngr</span><span class="p">,</span> <span class="s1">&#39;clear&#39;</span><span class="p">):</span>
            <span class="c1"># FIXME: Dupe the original bundle, copy in the new object &amp;</span>
            <span class="c1">#        check the perms on that (using the related resource)?</span>
            <span class="c1"># Clear it out, just to be safe.</span>
            <span class="n">related_mngr</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">related_objs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">related_bundle</span> <span class="ow">in</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]:</span>
            <span class="n">related_resource</span> <span class="o">=</span> <span class="n">field_object</span><span class="o">.</span><span class="n">get_related_resource</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span>
            <span class="c1"># Only build &amp; save if there&#39;s data, not just a URI.</span>
            <span class="n">updated_related_bundle</span> <span class="o">=</span> <span class="n">related_resource</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span>
                <span class="n">obj</span><span class="o">=</span><span class="n">related_bundle</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">related_bundle</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                <span class="n">request</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">,</span>
                <span class="n">objects_saved</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">objects_saved</span><span class="p">,</span>
                <span class="n">via_uri</span><span class="o">=</span><span class="n">related_bundle</span><span class="o">.</span><span class="n">via_uri</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">related_resource</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">updated_related_bundle</span><span class="p">)</span>
            <span class="n">related_objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">updated_related_bundle</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">related_mngr</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="n">related_objs</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.save_related">
    <p>def <span class="ident">save_related</span>(</p><p>self, bundle)</p>
    </div>
    

    
  
    <div class="desc"><p>Handles the saving of related non-M2M data.</p>
<p>Calling assigning <code>child.parent = parent</code> &amp; then calling
<code>Child.save</code> isn't good enough to make sure the <code>parent</code>
is saved.</p>
<p>To get around this, we go through all our related fields &amp;
call <code>save</code> on them if they have related, non-M2M data.
M2M data is handled by the <code>ModelResource.save_m2m</code> method.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.save_related', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.save_related" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_related</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles the saving of related non-M2M data.</span>
<span class="sd">    Calling assigning ``child.parent = parent`` &amp; then calling</span>
<span class="sd">    ``Child.save`` isn&#39;t good enough to make sure the ``parent``</span>
<span class="sd">    is saved.</span>
<span class="sd">    To get around this, we go through all our related fields &amp;</span>
<span class="sd">    call ``save`` on them if they have related, non-M2M data.</span>
<span class="sd">    M2M data is handled by the ``ModelResource.save_m2m`` method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_object</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field_object</span><span class="o">.</span><span class="n">is_related</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">field_object</span><span class="o">.</span><span class="n">is_m2m</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field_object</span><span class="o">.</span><span class="n">attribute</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">field_object</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">field_object</span><span class="o">.</span><span class="n">blank</span> <span class="ow">and</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># Get the object.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">related_obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">field_object</span><span class="o">.</span><span class="n">attribute</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ObjectDoesNotExist</span><span class="p">:</span>
            <span class="c1"># Django 1.8: unset related objects default to None, no error</span>
            <span class="n">related_obj</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1"># We didn&#39;t get it, so maybe we created it but haven&#39;t saved it</span>
        <span class="k">if</span> <span class="n">related_obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">related_obj</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">related_objects_to_save</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_object</span><span class="o">.</span><span class="n">attribute</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field_object</span><span class="o">.</span><span class="n">related_name</span><span class="p">:</span>
            <span class="c1"># this might be a reverse relation, so we need to save this</span>
            <span class="c1"># model, attach it to the related object, and save the related</span>
            <span class="c1"># object.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bundle_detail_data</span><span class="p">(</span><span class="n">bundle</span><span class="p">):</span>
                <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">related_obj</span><span class="p">,</span> <span class="n">field_object</span><span class="o">.</span><span class="n">related_name</span><span class="p">,</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">related_resource</span> <span class="o">=</span> <span class="n">field_object</span><span class="o">.</span><span class="n">get_related_resource</span><span class="p">(</span><span class="n">related_obj</span><span class="p">)</span>
        <span class="c1"># Before we build the bundle &amp; try saving it, let&#39;s make sure we</span>
        <span class="c1"># haven&#39;t already saved it.</span>
        <span class="k">if</span> <span class="n">related_obj</span><span class="p">:</span>
            <span class="n">obj_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_identifier</span><span class="p">(</span><span class="n">related_obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obj_id</span> <span class="ow">in</span> <span class="n">bundle</span><span class="o">.</span><span class="n">objects_saved</span><span class="p">:</span>
                <span class="c1"># It&#39;s already been saved. We&#39;re done here.</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">field_name</span><span class="p">],</span> <span class="s1">&#39;keys&#39;</span><span class="p">):</span>
                <span class="c1"># Only build &amp; save if there&#39;s data, not just a URI.</span>
                <span class="n">related_bundle</span> <span class="o">=</span> <span class="n">related_resource</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span>
                    <span class="n">obj</span><span class="o">=</span><span class="n">related_obj</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">),</span>
                    <span class="n">request</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">,</span>
                    <span class="n">objects_saved</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">objects_saved</span>
                <span class="p">)</span>
                <span class="n">related_resource</span><span class="o">.</span><span class="n">full_hydrate</span><span class="p">(</span><span class="n">related_bundle</span><span class="p">)</span>
                <span class="n">related_resource</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">related_bundle</span><span class="p">)</span>
                <span class="n">related_obj</span> <span class="o">=</span> <span class="n">related_bundle</span><span class="o">.</span><span class="n">obj</span>
            <span class="k">elif</span> <span class="n">field_object</span><span class="o">.</span><span class="n">related_name</span><span class="p">:</span>
                <span class="c1"># This condition probably means a URI for a reverse</span>
                <span class="c1"># relation was provided.</span>
                <span class="n">related_bundle</span> <span class="o">=</span> <span class="n">related_resource</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span>
                    <span class="n">obj</span><span class="o">=</span><span class="n">related_obj</span><span class="p">,</span>
                    <span class="n">request</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">,</span>
                    <span class="n">objects_saved</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">objects_saved</span>
                <span class="p">)</span>
                <span class="n">related_resource</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">related_bundle</span><span class="p">)</span>
                <span class="n">related_obj</span> <span class="o">=</span> <span class="n">related_bundle</span><span class="o">.</span><span class="n">obj</span>
        <span class="k">if</span> <span class="n">related_obj</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">field_object</span><span class="o">.</span><span class="n">attribute</span><span class="p">,</span> <span class="n">related_obj</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.serialize">
    <p>def <span class="ident">serialize</span>(</p><p>self, request, data, format, options=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Given a request, data and a desired format, produces a serialized
version suitable for transfer over the wire.</p>
<p>Mostly a hook, this uses the <code>Serializer</code> from <code>Resource._meta</code>.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.serialize', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.serialize" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a request, data and a desired format, produces a serialized</span>
<span class="sd">    version suitable for transfer over the wire.</span>
<span class="sd">    Mostly a hook, this uses the ``Serializer`` from ``Resource._meta``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">options</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s1">&#39;text/javascript&#39;</span> <span class="ow">in</span> <span class="n">format</span><span class="p">:</span>
        <span class="c1"># get JSONP callback name. default to &quot;callback&quot;</span>
        <span class="n">callback</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;callback&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid_jsonp_callback_value</span><span class="p">(</span><span class="n">callback</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span><span class="s1">&#39;JSONP callback name is invalid.&#39;</span><span class="p">)</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;callback&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">callback</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">serializer</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.set_cached_temporary_batches">
    <p>def <span class="ident">set_cached_temporary_batches</span>(</p><p>self, batches, multi_batch_id, request)</p>
    </div>
    

    
  
    <div class="desc"><p>Index the new data when a new bulk upload is done</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.set_cached_temporary_batches', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.set_cached_temporary_batches" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">set_cached_temporary_batches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batches</span><span class="p">,</span> <span class="n">multi_batch_id</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Index the new data when a new bulk upload is done&quot;&quot;&quot;</span>
    <span class="n">es_serializer</span> <span class="o">=</span> <span class="n">CBHCompoundBatchElasticSearchSerializer</span><span class="p">()</span>
    <span class="n">batch_dicts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches_to_es_ready</span><span class="p">(</span><span class="n">batches</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
    <span class="n">index_name</span> <span class="o">=</span> <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_temp_index_name</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span> <span class="n">multi_batch_id</span><span class="p">)</span>
    <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">create_temporary_index</span><span class="p">(</span>
        <span class="n">batch_dicts</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">index_name</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.should_skip_field">
    <p>def <span class="ident">should_skip_field</span>(</p><p>cls, field)</p>
    </div>
    

    
  
    <div class="desc"><p>Given a Django model field, return if it should be included in the
contributed ApiFields.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.should_skip_field', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.should_skip_field" class="source">
    <div class="codehilite"><pre><span></span><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">should_skip_field</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a Django model field, return if it should be included in the</span>
<span class="sd">    contributed ApiFields.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Ignore certain fields (related fields).</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s1">&#39;rel&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.throttle_check">
    <p>def <span class="ident">throttle_check</span>(</p><p>self, request)</p>
    </div>
    

    
  
    <div class="desc"><p>Handles checking if the user should be throttled.</p>
<p>Mostly a hook, this uses class assigned to <code>throttle</code> from
<code>Resource._meta</code>.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.throttle_check', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.throttle_check" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">throttle_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles checking if the user should be throttled.</span>
<span class="sd">    Mostly a hook, this uses class assigned to ``throttle`` from</span>
<span class="sd">    ``Resource._meta``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">get_identifier</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="c1"># Check to see if they should be throttled.</span>
    <span class="n">throttle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">throttle</span><span class="o">.</span><span class="n">should_be_throttled</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">throttle</span><span class="p">:</span>
        <span class="c1"># Throttle limit exceeded.</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">HttpTooManyRequests</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">throttle</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">throttle</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Retry-After&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">throttle</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">throttle</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
            <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Retry-After&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">format_date_time</span><span class="p">(</span><span class="n">mktime</span><span class="p">(</span><span class="n">throttle</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))</span>
        <span class="k">raise</span> <span class="n">ImmediateHttpResponse</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.unauthorized_result">
    <p>def <span class="ident">unauthorized_result</span>(</p><p>self, exception)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.unauthorized_result', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.unauthorized_result" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">unauthorized_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">ImmediateHttpResponse</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="n">http</span><span class="o">.</span><span class="n">HttpUnauthorized</span><span class="p">())</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.update_in_place">
    <p>def <span class="ident">update_in_place</span>(</p><p>self, request, original_bundle, new_data)</p>
    </div>
    

    
  
    <div class="desc"><p>Update the object in original_bundle in-place using new_data.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.update_in_place', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.update_in_place" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">update_in_place</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">original_bundle</span><span class="p">,</span> <span class="n">new_data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the object in original_bundle in-place using new_data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">original_bundle</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">dict_strip_unicode_keys</span><span class="p">(</span><span class="n">new_data</span><span class="p">))</span>
    <span class="c1"># Now we&#39;ve got a bundle with the new data sitting in it and we&#39;re</span>
    <span class="c1"># we&#39;re basically in the same spot as a PUT request. SO the rest of this</span>
    <span class="c1"># function is cribbed from put_detail.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">alter_deserialized_detail_data</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">original_bundle</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">detail_uri_name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bundle_detail_data</span><span class="p">(</span><span class="n">original_bundle</span><span class="p">),</span>
        <span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_update</span><span class="p">(</span><span class="n">bundle</span><span class="o">=</span><span class="n">original_bundle</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.update_temp_batches">
    <p>def <span class="ident">update_temp_batches</span>(</p><p>self, request, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Update a set of molecules into elasticsearch (used in ChemBio Hub to set the action field to ignore or new batch)</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.update_temp_batches', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.update_temp_batches" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">update_temp_batches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Update a set of molecules into elasticsearch (used in ChemBio Hub to set the action field to ignore or new batch)&#39;&#39;&#39;</span>
    <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">))</span>
    <span class="n">deserialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alter_deserialized_detail_data</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">)</span>
    <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bundle</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">dict_strip_unicode_keys</span><span class="p">(</span><span class="n">deserialized</span><span class="p">),</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bundle</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authorized_update_detail</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authorized_create_detail</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">request</span><span class="p">),</span> <span class="n">bundle</span><span class="p">)</span>
    <span class="n">multi_batch_id</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;multiplebatch&quot;</span><span class="p">]</span>
    <span class="n">es_serializer</span> <span class="o">=</span> <span class="n">CBHCompoundBatchElasticSearchSerializer</span><span class="p">()</span>
    <span class="n">es_ready_updates</span> <span class="o">=</span> <span class="p">[</span><span class="n">es_serializer</span><span class="o">.</span><span class="n">to_es_ready_data</span><span class="p">(</span><span class="n">dictdata</span><span class="p">,</span>
                                                       <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;underscorize&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span> <span class="k">for</span> <span class="n">dictdata</span> <span class="ow">in</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]]</span>
    <span class="n">index_name</span> <span class="o">=</span> <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_temp_index_name</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span> <span class="n">multi_batch_id</span><span class="p">)</span>
    <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">create_temporary_index</span><span class="p">(</span>
        <span class="n">es_ready_updates</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">index_name</span><span class="p">)</span>
    <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_action_totals</span><span class="p">(</span><span class="n">index_name</span><span class="p">,</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">http</span><span class="o">.</span><span class="n">HttpAccepted</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.validate_multi_batch">
    <p>def <span class="ident">validate_multi_batch</span>(</p><p>self, multi_batch, bundle, request, batches)</p>
    </div>
    

    
  
    <div class="desc"><p>Generate a set of staticstics about a set of data that has been uploaded</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.validate_multi_batch', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.validate_multi_batch" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">validate_multi_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multi_batch</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">batches</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate a set of staticstics about a set of data that has been uploaded&quot;&quot;&quot;</span>
    <span class="n">batches_not_errors</span> <span class="o">=</span> <span class="p">[</span><span class="n">batch</span> <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches</span> <span class="k">if</span> <span class="n">batch</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;parseerror&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;smilesParseError&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)]</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;no_data&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batches_not_errors</span><span class="p">:</span>
        <span class="n">b</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;New Batch&quot;</span>
    <span class="n">batches_with_structures</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">batch</span> <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches_not_errors</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">batch</span><span class="o">.</span><span class="n">blinded_batch_id</span><span class="p">]</span>
    <span class="n">blinded_data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">batch</span> <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches_not_errors</span> <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">blinded_batch_id</span><span class="p">]</span>
    <span class="n">sdfstrings</span> <span class="o">=</span> <span class="p">[</span><span class="n">batch</span><span class="o">.</span><span class="n">ctab</span> <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches_with_structures</span><span class="p">]</span>
    <span class="n">sdf</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sdfstrings</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;/tmp/&quot;</span> <span class="o">+</span> <span class="n">shortuuid</span><span class="o">.</span><span class="n">ShortUUID</span><span class="p">()</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
    <span class="n">text_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sdf</span><span class="p">)</span>
    <span class="n">text_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">PIPE</span><span class="p">,</span> <span class="n">Popen</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">([</span><span class="n">settings</span><span class="o">.</span><span class="n">INCHI_BINARIES_LOCATION</span><span class="p">[</span><span class="s1">&#39;1.02&#39;</span><span class="p">],</span>
               <span class="s2">&quot;-STDIO&quot;</span><span class="p">,</span>  <span class="n">filename</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="n">inchis</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1">#PB - there is an assumption here that everything that has a structure will generate an inChi without issue. This is not the case.</span>
    <span class="c1">#Where a molecule does not generate an inchi, there will be a key error looking up the inchi in inchiparts, as anything that cannot </span>
    <span class="c1">#generate an inchi will be missing from inchiparts, i.e. 50 structures with 1 error will have 49 entries in inchiparts, and this </span>
    <span class="c1">#will in turn bin the whole file - not great when we can handle erroring structures elsewhere</span>
    <span class="n">error_locs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1">#a[0] holds the generated inchis. a[1] holds all of the error and warning information (if any)</span>
    <span class="n">errorparts</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error&quot;</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">errorparts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">errorp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">errorparts</span><span class="p">):</span>
            <span class="c1">#split on &#39;structure #&#39;, then get the number given</span>
            <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">splits</span> <span class="o">=</span> <span class="n">errorp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;structure #&#39;</span><span class="p">)</span>
                <span class="n">error_loc</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1">#convert to number, put this number in an errors list</span>
                <span class="n">error_locs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_loc</span><span class="p">)</span>
    <span class="n">err_batches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1">#for the errors found, remove from non-error lists and flag as erroring</span>
    <span class="k">for</span> <span class="n">error_no</span> <span class="ow">in</span> <span class="n">error_locs</span><span class="p">:</span>
        <span class="n">error_no_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">error_no</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="c1">#find structures at the position indicated - 1 (for 0-indexed list)</span>
        <span class="n">err_batch</span> <span class="o">=</span> <span class="n">batches_with_structures</span><span class="p">[</span><span class="n">error_no_int</span><span class="p">]</span>
        <span class="n">err_batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_batch</span><span class="p">)</span>
    <span class="c1">#we can&#39;t remove these while looping through err_locs as it messes up the list order and gives arrayindex exceptions</span>
    <span class="k">for</span> <span class="n">err_batch</span> <span class="ow">in</span> <span class="n">err_batches</span><span class="p">:</span>
        <span class="c1">#remove from batches_with_structures and batches_not_errors</span>
        <span class="n">batches_with_structures</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">err_batch</span><span class="p">)</span>
        <span class="n">batches_not_errors</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">err_batch</span><span class="p">)</span>
        <span class="c1">#flag this batch as erroring due to inability to generate anything for the standard_inchi_key field</span>
        <span class="n">batches_index</span> <span class="o">=</span> <span class="n">batches</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">err_batch</span><span class="p">)</span>
        <span class="n">batches</span><span class="p">[</span><span class="n">batches_index</span><span class="p">]</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;inchicreationerror&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
        <span class="n">batches</span><span class="p">[</span><span class="n">batches_index</span><span class="p">]</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ignore&quot;</span>
    <span class="n">inchiparts</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Structure:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">inch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inchiparts</span><span class="p">):</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">inch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">ints</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]</span>
        <span class="n">part</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ints</span><span class="p">)</span>
        <span class="n">inchis</span><span class="p">[</span><span class="n">part</span><span class="p">]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fileerrors&quot;</span><span class="p">):</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;fileerrors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">new_uploaded_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">already_found</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
    <span class="n">duplicates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">batches_with_structures</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">error_locs</span><span class="p">):</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi</span> <span class="o">=</span> <span class="n">inchis</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">temp_props</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span> <span class="ow">in</span> <span class="n">already_found</span><span class="p">:</span>
            <span class="c1"># setting this in case we change it later</span>
            <span class="n">duplicates</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">already_found</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span><span class="p">)</span>
        <span class="n">new_uploaded_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
    <span class="n">already_in_db</span> <span class="o">=</span> <span class="n">MoleculeDictionary</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                                                      <span class="s2">&quot;project&quot;</span><span class="p">],</span> <span class="n">structure_type</span><span class="o">=</span><span class="s2">&quot;MOL&quot;</span><span class="p">,</span> <span class="n">structure_key__in</span><span class="o">=</span><span class="n">already_found</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s2">&quot;structure_key&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">already_in_db</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">already_in_db</span><span class="p">)</span>
    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;new&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">new_data</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
    <span class="n">duplicate_overlaps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
    <span class="n">duplicate_new</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches_with_structures</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;duplicate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span> <span class="ow">in</span> <span class="n">already_in_db</span><span class="p">:</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;overlap&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;duplicate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">duplicate_overlaps</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;new&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">new_data</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;duplicate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">duplicate_new</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">standard_inchi_key</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches_with_structures</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nostructure&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;nostructure&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">blinded_data</span><span class="p">:</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">warnings</span><span class="p">[</span><span class="s2">&quot;nostructure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;batchstats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;batchstats&quot;</span><span class="p">][</span><span class="s2">&quot;withstructure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
        <span class="n">batches_with_structures</span><span class="p">)</span>
    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;batchstats&quot;</span><span class="p">][</span><span class="s2">&quot;parseerrors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">batches_not_errors</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span>
        <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batches_not_errors</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parseerror&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">])</span>
    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;batchstats&quot;</span><span class="p">][</span><span class="s2">&quot;withoutstructure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">blinded_data</span><span class="p">)</span>
    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;batchstats&quot;</span><span class="p">][</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span>
    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;compoundstats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;compoundstats&quot;</span><span class="p">][</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
        <span class="n">already_in_db</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>
    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;compoundstats&quot;</span><span class="p">][</span><span class="s2">&quot;overlaps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">already_in_db</span><span class="p">)</span>
    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;compoundstats&quot;</span><span class="p">][</span><span class="s2">&quot;new&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>
    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;compoundstats&quot;</span><span class="p">][</span>
        <span class="s2">&quot;duplicateoverlaps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">duplicate_overlaps</span><span class="p">)</span>
    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;compoundstats&quot;</span><span class="p">][</span><span class="s2">&quot;duplicatenew&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">duplicate_new</span><span class="p">)</span>
    <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;multiplebatch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">multi_batch</span><span class="o">.</span><span class="n">pk</span>
    
    <span class="n">fifty_batches_for_first_page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_cached_temporary_batches</span><span class="p">(</span>
        <span class="n">batches</span><span class="p">,</span> <span class="n">multi_batch</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
    <span class="n">multi_batch</span><span class="o">.</span><span class="n">uploaded_data</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span>
    <span class="n">multi_batch</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="c1">#bundle.data[&quot;objects&quot;] = fifty_batches_for_first_page</span>
    <span class="n">index_name</span> <span class="o">=</span> <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_temp_index_name</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span> <span class="n">multi_batch</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="n">elasticsearch_client</span><span class="o">.</span><span class="n">get_action_totals</span><span class="p">(</span><span class="n">index_name</span><span class="p">,</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">http</span><span class="o">.</span><span class="n">HttpAccepted</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="cbh_chem_api.compounds.CBHCompoundUploadResource.wrap_view">
    <p>def <span class="ident">wrap_view</span>(</p><p>self, view)</p>
    </div>
    

    
  
    <div class="desc"><p>Wraps methods so they can be called in a more functional way as well
as handling exceptions better.</p>
<p>Note that if <code>BadRequest</code> or an exception with a <code>response</code> attr
are seen, there is special handling to either present a message back
to the user or return the response traveling with the exception.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-cbh_chem_api.compounds.CBHCompoundUploadResource.wrap_view', this);">Show source &equiv;</a></p>
  <div id="source-cbh_chem_api.compounds.CBHCompoundUploadResource.wrap_view" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">wrap_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wraps methods so they can be called in a more functional way as well</span>
<span class="sd">    as handling exceptions better.</span>
<span class="sd">    Note that if ``BadRequest`` or an exception with a ``response`` attr</span>
<span class="sd">    are seen, there is special handling to either present a message back</span>
<span class="sd">    to the user or return the response traveling with the exception.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@csrf_exempt</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">callback</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">callback</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c1"># Our response can vary based on a number of factors, use</span>
            <span class="c1"># the cache class to determine what we should ``Vary`` on so</span>
            <span class="c1"># caches won&#39;t return the wrong (cached) version.</span>
            <span class="n">varies</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">cache</span><span class="p">,</span> <span class="s2">&quot;varies&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">varies</span><span class="p">:</span>
                <span class="n">patch_vary_headers</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">varies</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">cacheable</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">cache_control</span><span class="p">():</span>
                    <span class="c1"># If the request is cacheable and we have a</span>
                    <span class="c1"># ``Cache-Control`` available then patch the header.</span>
                    <span class="n">patch_cache_control</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">cache_control</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">is_ajax</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">has_header</span><span class="p">(</span><span class="s2">&quot;Cache-Control&quot;</span><span class="p">):</span>
                <span class="c1"># IE excessively caches XMLHttpRequests, so we&#39;re disabling</span>
                <span class="c1"># the browser cache here.</span>
                <span class="c1"># See http://www.enhanceie.com/ie/bugs.asp for details.</span>
                <span class="n">patch_cache_control</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">no_cache</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">BadRequest</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">ApiFieldError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">sanitize</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">http</span><span class="o">.</span><span class="n">HttpBadRequest</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">sanitize</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">)}</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">http</span><span class="o">.</span><span class="n">HttpBadRequest</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Prevent muting non-django&#39;s exceptions</span>
            <span class="c1"># i.e. RequestException from &#39;requests&#39; library</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;response&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">,</span> <span class="n">HttpResponse</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span>
            <span class="c1"># A real, non-expected exception.</span>
            <span class="c1"># Handle the case where the full traceback is more helpful</span>
            <span class="c1"># than the serialized error.</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s1">&#39;TASTYPIE_FULL_DEBUG&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
                <span class="k">raise</span>
            <span class="c1"># Re-raise the error to get a proper traceback when the error</span>
            <span class="c1"># happend during a test case</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SERVER_NAME&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;testserver&#39;</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="c1"># Rather than re-raising, we&#39;re going to things similar to</span>
            <span class="c1"># what Django does. The difference is returning a serialized</span>
            <span class="c1"># error message.</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_500</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>
</pre></div>

  </div>
</div>

  </div>
  
      </div>
      </div>

  </section>

    </article>
  <div class="clear"> </div>
  <footer id="footer">
    <p>
      Documentation generated by
      <a href="https://github.com/BurntSushi/pdoc">pdoc 0.3.2</a>
    </p>

    <p>pdoc is in the public domain with the
      <a href="http://unlicense.org">UNLICENSE</a></p>

    <p>Design by <a href="http://nadh.in">Kailash Nadh</a></p>
  </footer>
</div>
</body>
</html>
